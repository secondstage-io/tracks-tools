<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACKS Revenue Calculator</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Load Prop-types -->
    <script src="https://cdn.jsdelivr.net/npm/prop-types/prop-types.min.js"></script>

    <!-- 4. Load Recharts -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- 5. Babel -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Custom range slider styling */
        input[type=range] {
            height: 6px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff0249;
            cursor: pointer;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Ensure Recharts is loaded before running
        if (!window.Recharts) {
            document.body.innerHTML = '<div style="padding: 20px; color: red; font-family: sans-serif;">Error: Recharts library failed to load. Please check your internet connection or try disabling ad-blockers.</div>';
        }

        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, ComposedChart, Bar } = window.Recharts;

        // Brand Color Constants
        const BRAND_COLOR = '#ff0249';
        const BRAND_COLOR_LIGHT = '#ffe6ed'; 
        const BRAND_COLOR_FLAT = '#8b5cf6';
        
        // Cohort Colors
        const COLOR_BASE = '#94a3b8'; // Slate 400
        const COLOR_Y1 = '#ff0249';   // Brand
        const COLOR_Y2 = '#fcd34d';   // Amber 300

        // Icons
        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        );
        const RotateCcwIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        );
        const DollarIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        );
        const TrendIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
        );
        const UsersIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const InfoIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
        );

        // Helper hook for localStorage
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        const SaasCalculator = () => {
            // --- State / Inputs (Wrapped in Persistence) ---
            
            // --- TRACKS FLEX Config ---
            const [setupFeeStandard, setSetupFeeStandard] = useStickyState(5000, 'setupFeeStandard');
            const [gracePeriodStandard, setGracePeriodStandard] = useStickyState(2, 'gracePeriodStandard');
            const [setupFeeSubsequent, setSetupFeeSubsequent] = useStickyState(2000, 'setupFeeSubsequent');
            const [gracePeriodSubsequent, setGracePeriodSubsequent] = useStickyState(0, 'gracePeriodSubsequent'); 
            const [subsequentMix, setSubsequentMix] = useStickyState(20, 'subsequentMix'); 
            const [recurringFeeFlex, setRecurringFeeFlex] = useStickyState(3000, 'recurringFeeFlex'); 
            const [retentionFlex, setRetentionFlex] = useStickyState(4, 'retentionFlex');
            const [churnLockFlex, setChurnLockFlex] = useStickyState(2, 'churnLockFlex');
            
            // --- TRACKS FLAT Config ---
            const [recurringFeeFlat, setRecurringFeeFlat] = useStickyState(3500, 'recurringFeeFlat');
            const [retentionFlat, setRetentionFlat] = useStickyState(12, 'retentionFlat'); 
            
            // --- GROWTH / SALES ---
            const [startingGamesFlex, setStartingGamesFlex] = useStickyState(8, 'startingGamesFlex');
            const [startingGamesFlat, setStartingGamesFlat] = useStickyState(2, 'startingGamesFlat');
            
            // Year 1 (Direct Inputs)
            const [flexY1, setFlexY1] = useStickyState(10, 'flexY1');
            const [flatY1, setFlatY1] = useStickyState(4, 'flatY1');
            
            // Year 2 (Direct Inputs)
            const [flexY2, setFlexY2] = useStickyState(14, 'flexY2');
            const [flatY2, setFlatY2] = useStickyState(6, 'flatY2');

            // --- Reset Function ---
            const resetToDefaults = () => {
                if(confirm('Reset all inputs to default values?')) {
                    setSetupFeeStandard(5000);
                    setGracePeriodStandard(2);
                    setSetupFeeSubsequent(2000);
                    setGracePeriodSubsequent(0);
                    setSubsequentMix(20);
                    setRecurringFeeFlex(3000);
                    setRetentionFlex(4);
                    setChurnLockFlex(2);
                    setRecurringFeeFlat(3500);
                    setRetentionFlat(12);
                    setStartingGamesFlex(8);
                    setStartingGamesFlat(2);
                    setFlexY1(10);
                    setFlatY1(4);
                    setFlexY2(14);
                    setFlatY2(6);
                }
            };

            const [data, setData] = useState([]);
            const [metrics, setMetrics] = useState({
                ltvFlex: 0,
                ltvFlat: 0,
                totalRevenue: 0,
                setupRevenue: 0,
                recurringRevenue: 0
            });

            // Helper: Distribute total integer games across 12 months with volatility
            const distributeGames = (total) => {
                const weights = [0.6, 1.2, 0.8, 1.5, 0.5, 1.3, 1.0, 1.4, 0.7, 1.2, 1.4, 0.4];
                const totalWeight = weights.reduce((a, b) => a + b, 0); 

                let distributed = weights.map(w => Math.floor(total * (w / totalWeight)));
                let currentSum = distributed.reduce((a, b) => a + b, 0);
                let remainder = total - currentSum;

                const decimalParts = weights.map(w => (total * (w / totalWeight)) % 1);
                const indices = Array.from(decimalParts.keys()).sort((a, b) => decimalParts[b] - decimalParts[a]);

                for (let i = 0; i < remainder; i++) {
                    distributed[indices[i]]++;
                }
                return distributed;
            };

            // --- Calculations ---
            useEffect(() => {
                const calculatedData = [];
                
                // Active Pools - We now track by Cohort to build the Stacked Chart
                // Cohort 0: Base (Starting)
                // Cohort 1: Year 1 Sales
                // Cohort 2: Year 2 Sales
                
                let activeFlexBase = startingGamesFlex;
                let activeFlatBase = startingGamesFlat;
                
                let activeFlexY1 = 0;
                let activeFlatY1 = 0;
                
                let activeFlexY2 = 0;
                let activeFlatY2 = 0;
                
                let cumulativeRevenue = 0;
                
                // Rates
                const churnRateFlex = retentionFlex > 0 ? 1 / retentionFlex : 1; 
                const churnRateFlat = retentionFlat > 0 ? 1 / retentionFlat : 1; 

                // Flex Blended Logic
                const mixRate = subsequentMix / 100;
                const blendedSetupFee = (setupFeeStandard * (1 - mixRate)) + (setupFeeSubsequent * mixRate);
                const blendedGracePeriod = (gracePeriodStandard * (1 - mixRate)) + (gracePeriodSubsequent * mixRate);

                // --- DISTRIBUTION LOGIC ---
                const distFlexY1 = distributeGames(Math.max(0, Math.round(flexY1)));
                const distFlatY1 = distributeGames(Math.max(0, Math.round(flatY1)));
                
                const distFlexY2 = distributeGames(Math.max(0, Math.round(flexY2)));
                const distFlatY2 = distributeGames(Math.max(0, Math.round(flatY2)));

                // Combined 24 Month Arrays
                const monthlyFlexNew = [...distFlexY1, ...distFlexY2];
                const monthlyFlatNew = [...distFlatY1, ...distFlatY2];

                for (let month = 1; month <= 24; month++) {
                    // New Sales this month
                    const newFlex = monthlyFlexNew[month - 1] || 0;
                    const newFlat = monthlyFlatNew[month - 1] || 0;
                    
                    const isYear1 = month <= 12;

                    // --- CHURN & UPDATE LOGIC BY COHORT ---
                    
                    // 1. BASE COHORT
                    // Simple decay
                    const churnFlexBase = Math.round(activeFlexBase * churnRateFlex);
                    activeFlexBase = Math.max(0, activeFlexBase - churnFlexBase);
                    
                    const churnFlatBase = Math.round(activeFlatBase * churnRateFlat);
                    activeFlatBase = Math.max(0, activeFlatBase - churnFlatBase);
                    
                    // 2. YEAR 1 COHORT
                    // Only gets new games if month <= 12
                    const newFlexY1 = isYear1 ? newFlex : 0;
                    const newFlatY1 = isYear1 ? newFlat : 0;
                    
                    // Lock Logic for Flex Y1
                    // We need to count protected games specific to this cohort
                    // Look back N months, but clamp at month 1 (start of Y1)
                    let protectedFlexY1 = 0;
                    for (let i = 1; i <= churnLockFlex; i++) {
                        const idx = month - 1 - i;
                        if (idx >= 0 && idx < 12) { 
                            protectedFlexY1 += monthlyFlexNew[idx]; 
                        }
                    }
                    const churnableFlexY1 = Math.max(0, activeFlexY1 - protectedFlexY1);
                    const churnFlexY1 = Math.round(churnableFlexY1 * churnRateFlex);
                    activeFlexY1 = Math.max(0, activeFlexY1 + newFlexY1 - churnFlexY1);
                    
                    const churnFlatY1 = Math.round(activeFlatY1 * churnRateFlat);
                    activeFlatY1 = Math.max(0, activeFlatY1 + newFlatY1 - churnFlatY1);

                    // 3. YEAR 2 COHORT
                    // Only gets new games if month > 12
                    const newFlexY2 = !isYear1 ? newFlex : 0;
                    const newFlatY2 = !isYear1 ? newFlat : 0;
                    
                    // Lock Logic for Flex Y2
                    let protectedFlexY2 = 0;
                    for (let i = 1; i <= churnLockFlex; i++) {
                        const idx = month - 1 - i;
                        if (idx >= 12) { // Must be from Y2
                            protectedFlexY2 += monthlyFlexNew[idx];
                        }
                    }
                    const churnableFlexY2 = Math.max(0, activeFlexY2 - protectedFlexY2);
                    const churnFlexY2 = Math.round(churnableFlexY2 * churnRateFlex);
                    activeFlexY2 = Math.max(0, activeFlexY2 + newFlexY2 - churnFlexY2);
                    
                    const churnFlatY2 = Math.round(activeFlatY2 * churnRateFlat);
                    activeFlatY2 = Math.max(0, activeFlatY2 + newFlatY2 - churnFlatY2);


                    // --- REVENUE CALCULATION BY COHORT ---
                    
                    // Setup Revenue (Easy, just new games * fee)
                    const revSetupY1 = newFlexY1 * blendedSetupFee;
                    const revSetupY2 = newFlexY2 * blendedSetupFee;
                    // Base has no new setup
                    
                    // Recurring Revenue (With Grace Period Logic applied to totals)
                    // Note: Ideally Grace should be tracked per cohort. 
                    // Simplified: We calculate "Total Grace Games" for Y1 adds and Y2 adds separately.
                    
                    // Y1 Grace
                    let graceCountY1 = 0;
                    // Current month adds (Age 0)
                    if(isYear1) graceCountY1 += newFlex * Math.min(1, Math.max(0, blendedGracePeriod));
                    // Last month adds (Age 1)
                    if(month > 1 && month <= 13) { // up to month 13, games from m12 are age 1
                         const prev = monthlyFlexNew[month-2];
                         // Approximate survival
                         graceCountY1 += prev * (1-churnRateFlex) * Math.min(1, Math.max(0, blendedGracePeriod - 1));
                    }
                    // Age 2
                    if(month > 2 && month <= 14) {
                         const prev2 = monthlyFlexNew[month-3];
                         graceCountY1 += prev2 * Math.pow((1-churnRateFlex),2) * Math.min(1, Math.max(0, blendedGracePeriod - 2));
                    }
                    
                    const payingFlexY1 = Math.max(0, Math.round(activeFlexY1 - graceCountY1));
                    const revRecFlexY1 = payingFlexY1 * recurringFeeFlex;
                    const revRecFlatY1 = activeFlatY1 * recurringFeeFlat; // Flat pays immediately usually, using active count
                    
                    // Y2 Grace
                    let graceCountY2 = 0;
                    if(!isYear1) graceCountY2 += newFlex * Math.min(1, Math.max(0, blendedGracePeriod));
                    if(month > 13) {
                         const prev = monthlyFlexNew[month-2];
                         graceCountY2 += prev * (1-churnRateFlex) * Math.min(1, Math.max(0, blendedGracePeriod - 1));
                    }
                    if(month > 14) {
                         const prev2 = monthlyFlexNew[month-3];
                         graceCountY2 += prev2 * Math.pow((1-churnRateFlex),2) * Math.min(1, Math.max(0, blendedGracePeriod - 2));
                    }
                    
                    const payingFlexY2 = Math.max(0, Math.round(activeFlexY2 - graceCountY2));
                    const revRecFlexY2 = payingFlexY2 * recurringFeeFlex;
                    const revRecFlatY2 = activeFlatY2 * recurringFeeFlat;

                    // Base Recurring (Assume no grace, mature)
                    const revRecFlexBase = activeFlexBase * recurringFeeFlex;
                    const revRecFlatBase = activeFlatBase * recurringFeeFlat;

                    // --- AGGREGATION ---
                    const totalRevenueBase = revRecFlexBase + revRecFlatBase;
                    const totalRevenueY1 = revSetupY1 + revRecFlexY1 + revRecFlatY1;
                    const totalRevenueY2 = revSetupY2 + revRecFlexY2 + revRecFlatY2;
                    
                    const totalMonthlyRevenue = totalRevenueBase + totalRevenueY1 + totalRevenueY2;
                    cumulativeRevenue += totalMonthlyRevenue;

                    // Totals for table
                    const totalActiveFlex = activeFlexBase + activeFlexY1 + activeFlexY2;
                    const totalActiveFlat = activeFlatBase + activeFlatY1 + activeFlatY2;
                    const totalChurnFlex = churnFlexBase + churnFlexY1 + churnFlexY2;
                    const totalChurnFlat = churnFlatBase + churnFlatY1 + churnFlatY2;

                    calculatedData.push({
                        month,
                        newGames: newFlex + newFlat,
                        
                        churnedGames: totalChurnFlex + totalChurnFlat,
                        churnedFlex: totalChurnFlex,
                        churnedFlat: totalChurnFlat,
                        
                        activeGames: totalActiveFlex + totalActiveFlat,
                        activeFlex: totalActiveFlex,
                        activeFlat: totalActiveFlat,
                        
                        revenue: Math.round(totalMonthlyRevenue),
                        
                        // For Cohort Chart
                        revBase: Math.round(totalRevenueBase),
                        revY1: Math.round(totalRevenueY1),
                        revY2: Math.round(totalRevenueY2),
                        
                        // For Composition Chart
                        splitSetup: Math.round(revSetupY1 + revSetupY2),
                        splitFlexRecurring: Math.round(revRecFlexBase + revRecFlexY1 + revRecFlexY2),
                        splitFlatRecurring: Math.round(revRecFlatBase + revRecFlatY1 + revRecFlatY2),
                        
                        cumulativeRevenue: Math.round(cumulativeRevenue)
                    });
                }

                setData(calculatedData);

                // LTV Estimates
                const effectiveFlexRecurringMonths = Math.max(0, retentionFlex - blendedGracePeriod);
                const ltvFlex = blendedSetupFee + (recurringFeeFlex * effectiveFlexRecurringMonths);
                const ltvFlat = recurringFeeFlat * retentionFlat;

                // Totals for split calculation
                const totSetup = calculatedData.reduce((s, i) => s + i.splitSetup, 0);
                const totRec = calculatedData.reduce((s, i) => s + i.splitFlexRecurring + i.splitFlatRecurring, 0);

                setMetrics({
                    ltvFlex,
                    ltvFlat,
                    totalRevenue: cumulativeRevenue,
                    setupRevenue: totSetup,
                    recurringRevenue: totRec
                });

            }, [
                setupFeeStandard, setupFeeSubsequent, gracePeriodStandard, gracePeriodSubsequent, subsequentMix, 
                recurringFeeFlex, retentionFlex, churnLockFlex, 
                recurringFeeFlat, retentionFlat,
                startingGamesFlex, startingGamesFlat, 
                flexY1, flatY1, flexY2, flatY2
            ]);

            const formatCurrency = (val) => {
                return new Intl.NumberFormat('en-IE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
            };

            const copyToClipboard = () => {
                const header = "Month,New Games,Total Churn,Active Flex,Churn Flex,Active Flat,Churn Flat,Total Active,Setup Rev,Flex Recurring Rev,Flat Recurring Rev,Total Rev,Cum. Rev\n";
                const rows = data.map(row => 
                    `${row.month},${row.newGames},${row.churnedGames},${row.activeFlex},${row.churnedFlex},${row.activeFlat},${row.churnedFlat},${row.activeGames},${row.splitSetup},${row.splitFlexRecurring},${row.splitFlatRecurring},${row.revenue},${row.cumulativeRevenue}`
                ).join("\n");
                
                const csvContent = header + rows;
                const textArea = document.createElement("textarea");
                textArea.value = csvContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert("Data copied! You can paste this directly into Google Sheets.");
            };

            const totalNewGames = data.reduce((sum, item) => sum + item.newGames, 0);
            const totalChurned = data.reduce((sum, item) => sum + item.churnedGames, 0);
            const totalChurnedFlex = data.reduce((sum, item) => sum + item.churnedFlex, 0);
            const totalChurnedFlat = data.reduce((sum, item) => sum + item.churnedFlat, 0);
            
            const totalRev = metrics.totalRevenue;
            const percentSetup = totalRev > 0 ? (metrics.setupRevenue / totalRev * 100).toFixed(1) : 0;
            const percentRecurring = totalRev > 0 ? (metrics.recurringRevenue / totalRev * 100).toFixed(1) : 0;

            return (
                <div className="flex flex-col h-screen bg-slate-50 overflow-hidden text-slate-900">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-white p-1 rounded-lg">
                                <img src="https://tracks.secondstage.io/vite/assets/tracks-signup-logo-J-NQw5DE.png" className="h-8 w-auto" alt="Tracks Logo" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800">Revenue Calculator</h1>
                                <p className="text-xs text-slate-500">Sales Forecasting for Second Stage TRACKS</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button 
                                onClick={resetToDefaults}
                                className="flex items-center gap-2 text-slate-500 hover:text-slate-800 px-3 py-2 text-xs font-medium transition-colors"
                            >
                                <RotateCcwIcon /> Reset
                            </button>
                            <button 
                                onClick={copyToClipboard}
                                className="flex items-center gap-2 bg-[#ff0249] hover:bg-[#cc023a] text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
                            >
                                <CopyIcon />
                                Copy Data for Excel/Sheets
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar */}
                        <aside className="w-80 bg-white border-r border-slate-200 overflow-y-auto p-6 flex flex-col gap-8 shrink-0 pb-20">
                            
                            {/* Summary Box */}
                            <div className="bg-slate-50 border border-slate-200 p-3 rounded-md text-xs text-slate-600 flex flex-col gap-2">
                                <div className="flex gap-2">
                                    <div className="shrink-0 mt-0.5 text-[#ff0249]"><InfoIcon /></div>
                                    <p className="font-semibold text-slate-800">Revenue Mix (24 Mo)</p>
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-1">
                                    <div>
                                        <span className="block text-slate-400">Flex LTV</span>
                                        <span className="font-bold text-[#ff0249]">{formatCurrency(metrics.ltvFlex)}</span>
                                    </div>
                                    <div>
                                        <span className="block text-slate-400">Flat LTV</span>
                                        <span className="font-bold text-[#8b5cf6]">{formatCurrency(metrics.ltvFlat)}</span>
                                    </div>
                                </div>
                                <div className="border-t border-slate-200 mt-2 pt-2 flex justify-between">
                                    <span>Setup: <strong>{percentSetup}%</strong></span>
                                    <span>Recurring: <strong>{percentRecurring}%</strong></span>
                                </div>
                            </div>

                            <div className="space-y-6 pt-4">
                                
                                {/* 1. GROWTH ENGINE */}
                                <div className="space-y-3 border-t border-slate-100 pt-4 first:border-0 first:pt-0">
                                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                                        <div className="text-[#ff0249]"><TrendIcon /></div> Growth Engine
                                    </h3>
                                    
                                    {/* Starting Base */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Existing Projects (Flex)</label>
                                            <input type="number" value={startingGamesFlex} onChange={(e) => setStartingGamesFlex(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Existing Projects (Flat)</label>
                                            <input type="number" value={startingGamesFlat} onChange={(e) => setStartingGamesFlat(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#8b5cf6] outline-none" />
                                        </div>
                                    </div>

                                    {/* Year 1 Config */}
                                    <div className="space-y-2 border border-slate-100 p-2 rounded-md bg-white">
                                        <div className="text-xs font-semibold text-slate-600">Year 1 Sales (New Games)</div>
                                        <div className="flex items-center justify-between text-xs">
                                            <label className="text-[#ff0249] font-medium w-16">Flex:</label>
                                            <input type="number" value={flexY1} onChange={(e) => setFlexY1(Number(e.target.value))} className="w-16 px-1 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none text-right" />
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <label className="text-[#8b5cf6] font-medium w-16">Flat:</label>
                                            <input type="number" value={flatY1} onChange={(e) => setFlatY1(Number(e.target.value))} className="w-16 px-1 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-[#8b5cf6] outline-none text-right" />
                                        </div>
                                        <div className="flex items-center justify-between text-xs pt-1 border-t border-slate-100 mt-1">
                                            <label className="text-slate-500 w-16">Total:</label>
                                            <span className="w-16 text-right font-bold text-slate-700">{flexY1 + flatY1}</span>
                                        </div>
                                    </div>

                                    {/* Year 2 Config */}
                                    <div className="space-y-2 border border-slate-100 p-2 rounded-md bg-white">
                                        <div className="text-xs font-semibold text-slate-600">Year 2 Sales (New Games)</div>
                                        <div className="flex items-center justify-between text-xs">
                                            <label className="text-[#ff0249] font-medium w-16">Flex:</label>
                                            <input type="number" value={flexY2} onChange={(e) => setFlexY2(Number(e.target.value))} className="w-16 px-1 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none text-right" />
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <label className="text-[#8b5cf6] font-medium w-16">Flat:</label>
                                            <input type="number" value={flatY2} onChange={(e) => setFlatY2(Number(e.target.value))} className="w-16 px-1 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-[#8b5cf6] outline-none text-right" />
                                        </div>
                                        <div className="flex items-center justify-between text-xs pt-1 border-t border-slate-100 mt-1">
                                            <label className="text-slate-500 w-16">Total:</label>
                                            <span className="w-16 text-right font-bold text-slate-700">{flexY2 + flatY2}</span>
                                        </div>
                                    </div>
                                    
                                </div>

                                {/* 2. FLEX PRICING */}
                                <div className="space-y-3 border-t border-slate-100 pt-4">
                                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                                        <div className="text-[#ff0249]"><DollarIcon /></div> TRACKS Flex
                                    </h3>
                                    
                                    {/* Setup Fees */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Starter Fee (€)</label>
                                            <input type="number" value={setupFeeStandard} onChange={(e) => setSetupFeeStandard(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Subsq Setup (€)</label>
                                            <input type="number" value={setupFeeSubsequent} onChange={(e) => setSetupFeeSubsequent(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none" />
                                        </div>
                                    </div>
                                    
                                    {/* Flex Mix */}
                                    <div>
                                        <div className="flex justify-between text-[10px] text-slate-500 mb-1">
                                            <span>New Clients</span>
                                            <span>Existing Clients</span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="0" 
                                            max="100" 
                                            value={subsequentMix} 
                                            onChange={(e) => setSubsequentMix(Number(e.target.value))}
                                            className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                        />
                                        <div className="text-right text-[10px] text-[#ff0249]">{subsequentMix}% Subsequent</div>
                                    </div>

                                    {/* Flex Recurring */}
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">Avg Recurring Fee (€/mo)</label>
                                        <input type="number" value={recurringFeeFlex} onChange={(e) => setRecurringFeeFlex(Number(e.target.value))} className="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#ff0249] outline-none" />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Avg Retention (Months)</label>
                                            <input type="number" value={retentionFlex} onChange={(e) => setRetentionFlex(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-medium text-slate-500 mb-1">Minimum Duration (Months)</label>
                                            <input type="number" value={churnLockFlex} onChange={(e) => setChurnLockFlex(Number(e.target.value))} className="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-[#ff0249] outline-none" />
                                        </div>
                                    </div>
                                </div>

                                {/* 3. FLAT PRICING */}
                                <div className="space-y-3 border-t border-slate-100 pt-4">
                                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                                        <div className="text-[#8b5cf6]"><DollarIcon /></div> TRACKS Flat
                                    </h3>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">Avg Recurring Fee (€/mo)</label>
                                        <input type="number" value={recurringFeeFlat} onChange={(e) => setRecurringFeeFlat(Number(e.target.value))} className="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#8b5cf6] outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">Avg Contract Duration (Months)</label>
                                        <input type="number" value={retentionFlat} onChange={(e) => setRetentionFlat(Number(e.target.value))} className="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#8b5cf6] outline-none" />
                                    </div>
                                    <p className="text-[10px] text-slate-400">No setup fee. No grace period.</p>
                                </div>

                            </div>
                        </aside>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto p-6 bg-slate-50">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-80 flex flex-col">
                                    <h3 className="text-sm font-semibold text-slate-500 mb-4 uppercase tracking-wider">Revenue by Cohort</h3>
                                    <div className="flex-1">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={data}>
                                                <defs>
                                                    <linearGradient id="colorBase" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={COLOR_BASE} stopOpacity={0.1}/><stop offset="95%" stopColor={COLOR_BASE} stopOpacity={0}/></linearGradient>
                                                    <linearGradient id="colorY1" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={COLOR_Y1} stopOpacity={0.1}/><stop offset="95%" stopColor={COLOR_Y1} stopOpacity={0}/></linearGradient>
                                                    <linearGradient id="colorY2" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={COLOR_Y2} stopOpacity={0.1}/><stop offset="95%" stopColor={COLOR_Y2} stopOpacity={0}/></linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                <XAxis dataKey="month" tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} />
                                                <YAxis tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} tickFormatter={(value) => `€${value/1000}k`} />
                                                <Tooltip formatter={(value) => formatCurrency(value)} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                                                <Legend />
                                                <Area type="monotone" dataKey="revBase" name="Base Rev" stackId="1" stroke={COLOR_BASE} fill="url(#colorBase)" />
                                                <Area type="monotone" dataKey="revY1" name="Year 1 Sales" stackId="1" stroke={COLOR_Y1} fill="url(#colorY1)" />
                                                <Area type="monotone" dataKey="revY2" name="Year 2 Sales" stackId="1" stroke={COLOR_Y2} fill="url(#colorY2)" />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-80 flex flex-col">
                                    <h3 className="text-sm font-semibold text-slate-500 mb-4 uppercase tracking-wider">Revenue Composition</h3>
                                    <div className="flex-1">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={data}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                <XAxis dataKey="month" tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false}/>
                                                <YAxis tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} tickFormatter={(value) => `€${value/1000}k`}/>
                                                <Tooltip formatter={(value) => formatCurrency(value)} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}/>
                                                <Legend />
                                                <Bar dataKey="splitSetup" name="Setup Fees" fill="#10b981" barSize={20} stackId="a" />
                                                <Bar dataKey="splitFlexRecurring" name="Flex Recurring" fill={BRAND_COLOR} barSize={20} stackId="a" />
                                                <Bar dataKey="splitFlatRecurring" name="Flat Recurring" fill={BRAND_COLOR_FLAT} barSize={20} stackId="a" />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-700">Detailed Monthly Breakdown</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                                            <tr>
                                                <th className="px-6 py-3">Month</th>
                                                <th className="px-6 py-3">New Games</th>
                                                <th className="px-6 py-3 text-red-500">Churn Total</th>
                                                <th className="px-6 py-3 text-[#ff0249]">Active Flex</th>
                                                <th className="px-6 py-3 text-[#ff0249]">Churn Flex</th>
                                                <th className="px-6 py-3 text-[#8b5cf6]">Active Flat</th>
                                                <th className="px-6 py-3 text-[#8b5cf6]">Churn Flat</th>
                                                <th className="px-6 py-3 font-bold text-slate-800">Total Active</th>
                                                <th className="px-6 py-3 text-slate-700">Total Rev.</th>
                                                <th className="px-6 py-3">Cum. Rev</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.map((row) => (
                                                <tr key={row.month} className="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-3 font-medium text-slate-900">{row.month}</td>
                                                    <td className="px-6 py-3 text-emerald-600">+{row.newGames}</td>
                                                    <td className="px-6 py-3 text-red-500">-{row.churnedGames}</td>
                                                    <td className="px-6 py-3 font-bold text-[#ff0249]">{row.activeFlex}</td>
                                                    <td className="px-6 py-3 text-red-400">-{row.churnedFlex}</td>
                                                    <td className="px-6 py-3 font-bold text-[#8b5cf6]">{row.activeFlat}</td>
                                                    <td className="px-6 py-3 text-red-400">-{row.churnedFlat}</td>
                                                    <td className="px-6 py-3 font-bold text-slate-800">{row.activeGames}</td>
                                                    <td className={`px-6 py-3 bg-[${BRAND_COLOR_LIGHT}] font-medium text-slate-900`}>{formatCurrency(row.revenue)}</td>
                                                    <td className="px-6 py-3 text-slate-500">{formatCurrency(row.cumulativeRevenue)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot className="bg-slate-100 font-bold text-slate-700 border-t-2 border-slate-200">
                                            <tr>
                                                <td className="px-6 py-3">TOTAL (24 Mo)</td>
                                                <td className="px-6 py-3 text-emerald-600">+{totalNewGames}</td>
                                                <td className="px-6 py-3 text-red-500">-{totalChurned}</td>
                                                <td className="px-6 py-3">-</td>
                                                <td className="px-6 py-3 text-red-400">-{totalChurnedFlex}</td>
                                                <td className="px-6 py-3">-</td>
                                                <td className="px-6 py-3 text-red-400">-{totalChurnedFlat}</td>
                                                <td className="px-6 py-3">-</td>
                                                <td className="px-6 py-3 text-slate-800">{formatCurrency(metrics.totalRevenue)}</td>
                                                <td className="px-6 py-3">-</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SaasCalculator />);
    </script>
</body>
</html>
