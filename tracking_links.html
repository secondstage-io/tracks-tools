<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACKS Tracking Links</title>
    <style>
        :root{--primary:#2c3e50;--accent:#ff0249;--bg:#f5f6fa;--card:#fff;--shadow:0 2px 8px rgba(0,0,0,.08);--radius:8px;--green:#27ae60;--blue:#3b82f6;--orange:#f59e0b;--tblr-primary:#FF0249;--tblr-primary-rgb:255,2,73;--tblr-body-bg:#f9fafb;--tblr-body-color:#1f2937;--tblr-border-color:rgba(4,32,69,.1);--tblr-secondary:#6b7280;--tblr-border-radius:6px;--tblr-border-radius-lg:8px}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--tblr-body-bg);color:var(--tblr-body-color);font-size:.875rem;line-height:1.4286;padding:0;min-height:100vh}
        /* ═══ APP SHELL ═══ */
        .page{display:flex;flex-direction:column;min-height:100vh}
        .main-navbar{background:var(--tblr-primary);padding:0 1rem;height:3.25rem;display:flex;align-items:center;justify-content:space-between}
        .navbar-brand{display:flex;align-items:center;font-size:1.1rem;font-weight:800;color:#fff;letter-spacing:1px;text-decoration:none}
        .navbar-user{display:flex;align-items:center;gap:8px;color:#fff;font-size:.82rem}
        .navbar-avatar{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;color:#fff}
        .secondary-nav{background:#fff;border-bottom:1px solid var(--tblr-border-color);padding:0 1rem;display:flex;align-items:center;height:2.75rem;gap:1.5rem}
        .secondary-nav a{color:var(--tblr-secondary);font-size:.82rem;font-weight:500;text-decoration:none;display:flex;align-items:center;gap:6px}
        .secondary-nav a:hover{color:var(--tblr-body-color)}
        .secondary-nav a.active{color:var(--tblr-body-color);font-weight:600}
        .page-wrapper{flex:1;display:flex;flex-direction:column}
        .page-header{padding:1.25rem 1.5rem .5rem}
        .page-pretitle{font-size:.75rem;font-weight:500;text-transform:uppercase;letter-spacing:.04em;color:var(--tblr-secondary);margin-bottom:2px}
        .page-pretitle a{color:var(--tblr-secondary);text-decoration:none}
        .page-pretitle a:hover{text-decoration:underline}
        .page-title{font-size:1.25rem;font-weight:700;margin:0}
        .page-body{flex:1;padding:1.25rem 1.5rem}
        .container-xl{max-width:1200px;margin:0 auto;width:100%}
        .shell-card{max-width:1000px;margin:0 auto;border:1px solid var(--tblr-border-color);border-radius:var(--tblr-border-radius-lg);background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.04);overflow:hidden}
        .card-img-top-hero{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 40%,#0f3460 100%);height:200px;position:relative}
        .card-img-top-hero .hero-overlay{background:linear-gradient(transparent,rgba(0,0,0,.55));display:flex;flex-direction:column;justify-content:flex-end;height:100%;padding:1.5rem}
        .card-img-top-hero .hero-overlay h1{color:#fff;font-size:1.5rem;font-weight:700;margin:0 0 4px}
        .card-img-top-hero .hero-overlay p{color:rgba(255,255,255,.75);font-size:.9rem;margin:0}
        .hero-btn-group{position:absolute;top:12px;right:12px;z-index:10;display:flex;flex-direction:column;gap:6px}
        .hero-devguide-btn{background:rgba(255,255,255,.15);color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.25);padding:5px 12px;border-radius:5px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s;backdrop-filter:blur(4px);text-align:center}
        .hero-devguide-btn:hover{background:rgba(255,255,255,.25);color:#fff}
        .card-body-main{padding:1.5rem}
        .app-footer{padding:1rem 1.5rem;text-align:center;font-size:.78rem;color:var(--tblr-secondary);border-top:1px solid #e5e7eb;margin-top:auto}
        .app-footer a{color:var(--tblr-secondary);text-decoration:none}
        .app-footer a:hover{text-decoration:underline}
        @media print{.main-navbar,.secondary-nav,.page-header,.app-footer,.card-img-top-hero{display:none!important}}

        /* ═══ CARDS ═══ */
        .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin-bottom:16px}
        .card h2{font-size:1.1rem;color:var(--primary);margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .card-desc{font-size:.85rem;color:#64748b;line-height:1.5;margin-bottom:16px}

        /* ═══ SETUP GRID ═══ */
        .setup-grid{display:grid;grid-template-columns:2fr 2fr;gap:16px;margin-bottom:16px}
        .setup-grid .field{display:flex;flex-direction:column;gap:4px}
        .setup-grid label{font-weight:600;font-size:.82rem;color:#475569;text-transform:uppercase;letter-spacing:.3px}
        .setup-grid input{padding:10px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:.9rem;transition:border-color .2s}
        .setup-grid input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,62,80,.1)}

        /* ═══ BEAT MANAGEMENT ═══ */
        .beat-bar{display:flex;gap:8px;align-items:flex-end;margin-bottom:16px}
        .beat-bar .field{display:flex;flex-direction:column;gap:4px;flex:1}
        .beat-bar label{font-weight:600;font-size:.82rem;color:#475569;text-transform:uppercase;letter-spacing:.3px}
        .beat-bar input{padding:10px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:.9rem}
        .beat-bar input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,62,80,.1)}
        .bld-setup{display:flex;align-items:center;gap:20px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:var(--radius);padding:14px 16px;margin-bottom:12px}
        .bld-setup-lbl{font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:6px;color:#475569}
        .bld-setup-lbl select,.bld-setup-lbl input{padding:5px 8px;border:2px solid #e2e8f0;border-radius:4px;font-size:.88rem;font-weight:600;outline:none;transition:border-color .2s}
        .bld-setup-lbl select{min-width:160px;cursor:pointer}
        .bld-setup-lbl input{width:120px;font-family:'SF Mono','Fira Code',monospace}
        .bld-setup-lbl select:focus,.bld-setup-lbl input:focus{border-color:var(--primary)}
        .btn-gen{background:var(--primary);color:#fff;border:none;padding:6px 14px;border-radius:4px;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:opacity .15s}
        .btn-gen:hover{opacity:.85}
        .saved-beats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:0 0 12px;margin-bottom:4px}
        .saved-beats:empty{display:none}
        .beats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
        .beat-card{background:var(--card);border:1px solid var(--tblr-border-color);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;cursor:pointer;transition:all .2s ease-in-out}
        .beat-card:hover{transform:scale(1.02);box-shadow:0 1px 6px 0 rgba(0,0,0,.08)}
        .beat-card.active{border-color:var(--tblr-primary);box-shadow:0 0 0 3px rgba(255,2,73,.15)}
        .beat-card-header{font-weight:700;color:var(--primary);font-size:.92rem;margin-bottom:4px}
        .beat-card-stats{font-size:.78rem;color:var(--tblr-secondary);margin-bottom:8px}
        .beat-card-actions{display:flex;gap:4px}
        .beat-card-btn{background:transparent;color:var(--tblr-secondary);border:1px solid var(--tblr-border-color);padding:4px 8px;font-size:.78rem;cursor:pointer;border-radius:4px;transition:all .15s}
        .beat-card-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .beat-card-btn.danger:hover{background:#ef4444;color:#fff;border-color:#ef4444}

        /* ═══ GUIDE ═══ */
        .gc{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #e2e8f0}
        .gc:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .gc h2{font-size:1.1rem;color:var(--primary);margin-bottom:10px}
        .gc p{font-size:.85rem;color:#475569;line-height:1.6;margin-bottom:8px}
        .gc ul,.gc ol{font-size:.85rem;color:#475569;line-height:1.6;margin:6px 0 10px;padding-left:22px}
        .gc li{margin-bottom:4px}
        .gc code{background:#f1f5f9;padding:1px 5px;border-radius:3px;font-size:.8rem;font-family:'SF Mono','Fira Code',monospace;color:var(--primary)}

        /* ═══ INLINE VALUE TAGS ═══ */
        .field-vals-toggle{display:flex;align-items:center;cursor:pointer;user-select:none;padding:10px 0 8px;margin-top:4px;border-top:1px solid #e2e8f0}
        .field-vals-toggle span:first-child{font-size:.88rem;font-weight:700;color:var(--primary)}
        .field-vals-chev{margin-left:auto;font-size:.7rem;color:#94a3b8;transition:transform .2s;transform:rotate(-90deg)}
        .field-vals-body{display:none;margin-bottom:16px}
        .field-vals-row{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9}
        .field-vals-row:last-child{border-bottom:none}
        .field-vals-label{min-width:100px;font-weight:600;font-size:.82rem;color:#475569;text-transform:uppercase;letter-spacing:.3px;padding-top:3px}
        .values-list{display:flex;flex-wrap:wrap;gap:4px;flex:1;align-items:center}
        .val-tag{padding:2px 7px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:4px;font-size:.78rem;font-family:'SF Mono','Fira Code',monospace;color:#475569}
        .val-tag.custom{background:#e0f2fe;border-color:#7dd3fc}
        .val-rm{margin-left:3px;cursor:pointer;color:#94a3b8;font-size:.72rem;font-weight:700;vertical-align:middle}
        .val-rm:hover{color:#ef4444}
        .val-add{display:inline-flex;align-items:center;gap:4px;margin-left:6px;vertical-align:middle}
        .val-add input{padding:2px 6px;border:1px solid #d1d5db;border-radius:4px;font-size:.78rem;width:110px;outline:none;font-family:'SF Mono','Fira Code',monospace}
        .val-add input:focus{border-color:var(--primary)}
        .val-add button{padding:2px 8px;border:none;background:var(--primary);color:#fff;border-radius:4px;font-size:.75rem;font-weight:700;cursor:pointer;line-height:1.4}
        .val-add button:hover{opacity:.85}

        /* ═══ BUTTONS ═══ */
        .btn{padding:8px 18px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
        .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{opacity:.85}
        .btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.85}
        .btn-accent{background:var(--accent);color:#fff}.btn-accent:hover{opacity:.85}
        .btn-outline{background:transparent;color:var(--primary);border:1px solid #e2e8f0}.btn-outline:hover{background:#f8fafc}
        .btn-sm{padding:5px 10px;font-size:.78rem;border-radius:4px}
        .btn-copy{background:#333;color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:.78rem;cursor:pointer;white-space:nowrap}
        .btn-copy:hover{background:#000}
        .btn-copy.copied{background:var(--green)}
        .btn-shorten{background:var(--primary);color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:.78rem;cursor:pointer;white-space:nowrap;width:100%}
        .btn-shorten:hover{opacity:.85}
        .btn-shorten:disabled{background:#cbd5e1;cursor:not-allowed}
        .btn-remove{background:transparent;color:#e74c3c;border:1px solid #e74c3c;padding:3px 6px;font-size:.72rem;cursor:pointer;border-radius:4px}
        .btn-remove:hover{background:#e74c3c;color:#fff}
        .btn-dup{background:transparent;color:var(--blue);border:1px solid var(--blue);padding:3px 6px;font-size:.72rem;cursor:pointer;border-radius:4px}
        .btn-dup:hover{background:var(--blue);color:#fff}

        /* ═══ TABLE ═══ */
        .table-wrapper{margin:0 -24px 12px;width:calc(100% + 48px)}
        table{width:100%;border-collapse:collapse}
        #table-inf,#table-mh,#table-om,#table-cost{table-layout:fixed}
        th{text-align:left;font-size:.72rem;color:#fff;padding:8px 4px;background:var(--primary);white-space:nowrap;text-transform:uppercase;letter-spacing:.3px;overflow:hidden}
        th:first-child{padding-left:8px;border-radius:0}
        th:last-child{padding-right:8px;border-radius:0}
        td{padding:5px 3px;vertical-align:top;border-bottom:1px solid #f1f5f9;font-size:.82rem;overflow:hidden}
        .row-inputs td:first-child{padding-left:8px}
        .row-inputs td:last-child{padding-right:8px}
        tbody tr.row-inputs:hover{background:#f8fafc}
        td select,td input[type="text"],td input[type="date"]{width:100%;padding:5px 4px;border:1px solid #e2e8f0;border-radius:4px;font-size:.78rem;box-sizing:border-box}
        td select:focus,td input:focus{outline:none;border-color:var(--primary)}
        td:last-child{white-space:nowrap}
        tr.row-inputs td{border-bottom:none}
        tr.row-links td{background:#fafbfc;border-bottom:1px solid #e2e8f0;padding:3px 8px}
        .row-links-inner{display:flex;gap:10px;align-items:center;min-width:0;overflow:hidden}
        .row-links-inner .short-area{display:flex;gap:6px;align-items:center;flex-shrink:0}
        .row-links-inner .short-result{display:none;font-family:'SF Mono','Fira Code',monospace;font-size:.88rem;font-weight:700;color:var(--accent);background:#fff0f4;border:1.5px solid var(--accent);border-radius:5px;padding:5px 10px;white-space:nowrap}
        .row-links-inner .short-result a{color:var(--accent);text-decoration:none}
        .row-links-inner .short-result a:hover{text-decoration:underline}
        .row-links-inner .short-input{margin-bottom:0;width:140px;flex-shrink:0}
        .row-links-inner .btn-shorten{width:auto;white-space:nowrap;flex-shrink:0}
        .row-links-inner .link-box{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-height:none;overflow-y:visible;word-break:normal;border:none;background:transparent;padding:4px 0;font-size:.68rem;color:#94a3b8}
        .row-links-inner .link-box a{color:#94a3b8}
        .row-links-inner .link-box a:hover{color:var(--accent)}

        /* ═══ LINK OUTPUT ═══ */
        .link-box{background:#f8fafc;padding:6px 8px;border-radius:4px;font-family:'SF Mono','Fira Code',monospace;font-size:.72rem;color:#64748b;border:1px solid #e2e8f0;word-break:break-all;white-space:normal;line-height:1.4;max-height:60px;overflow-y:auto}
        .link-box a{color:var(--accent);text-decoration:none}
        .link-box a:hover{text-decoration:underline}
        .link-box.empty{color:#94a3b8;font-style:italic;font-family:inherit}
        td .i-key.duplicate,td .m-key.duplicate,td .o-key.duplicate{border-color:#e74c3c!important;background:#fff5f5}
        .short-input{width:100%;padding:5px 8px;border:1px solid #e2e8f0;border-radius:4px;font-size:.78rem;font-weight:600;background:#f8fafc;color:var(--primary);margin-bottom:4px}
        .short-input:read-only{cursor:default}

        /* ═══ ACTION BAR ═══ */
        .action-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
        .action-bar .spacer{flex:1}

        /* ═══ STATS ═══ */
        .stats-bar{display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap}
        .stat{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px 20px;display:flex;flex-direction:column;align-items:center;min-width:100px}
        .stat-num{font-size:1.4rem;font-weight:700;color:var(--primary)}
        .stat-label{font-size:.75rem;color:#94a3b8;text-transform:uppercase;letter-spacing:.3px;margin-top:2px}

        /* ═══ CALLOUT ═══ */
        .callout{padding:12px 16px;border-radius:6px;font-size:.85rem;line-height:1.5;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px}
        .callout-blue{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
        .callout-amber{background:#fffbeb;border:1px solid #fde68a;color:#92400e}

        /* ═══ TOOLTIP ═══ */
        .tooltip-wrap{position:relative;cursor:help;display:inline-flex;align-items:center;gap:4px}
        .tooltip-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;background:rgba(255,255,255,.3);border-radius:50%;font-size:10px;font-weight:700}
        .tooltip-text{visibility:hidden;width:240px;background:#333;color:#fff;text-align:left;border-radius:6px;padding:8px 10px;position:absolute;z-index:100;top:130%;right:0;opacity:0;transition:opacity .2s;font-weight:normal;font-size:.75rem;line-height:1.4;white-space:normal;box-shadow:0 2px 10px rgba(0,0,0,.2);text-transform:none;letter-spacing:0}
        .tooltip-wrap:hover .tooltip-text{visibility:visible;opacity:1}

        /* ═══ ROW ACTIONS ═══ */
        .row-actions{display:flex;gap:2px;align-items:center;padding-top:3px}

        /* ═══ MODE TOGGLE ═══ */
        .mode-toggle{display:flex;justify-content:center;gap:4px;background:var(--card);border-radius:var(--radius);padding:4px;box-shadow:var(--shadow);margin-bottom:24px;max-width:720px;margin-left:auto;margin-right:auto}
        .mode-btn{flex:1;padding:10px 16px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:.9rem;font-weight:600;color:#64748b;transition:all .2s}
        .mode-btn.active{background:var(--primary);color:#fff}
        .mode-btn:hover:not(.active){background:#e2e8f0}
        .mode-panel{display:none}.mode-panel.active{display:block}

        /* ═══ DEV GUIDE ═══ */
        .dg h3{font-size:.95rem;color:var(--primary);margin:18px 0 6px;padding-top:14px;border-top:1px solid #e2e8f0}
        .dg h3:first-child{border-top:none;padding-top:0}
        .dg p{font-size:.85rem;color:#475569;line-height:1.6;margin-bottom:8px}
        .dg ul,.dg ol{font-size:.85rem;color:#475569;line-height:1.6;margin:6px 0 10px;padding-left:22px}
        .dg li{margin-bottom:4px}
        .dg code{background:#f1f5f9;padding:1px 5px;border-radius:3px;font-size:.8rem;font-family:'SF Mono','Fira Code',monospace;color:var(--primary)}
        .dg pre{background:#f1f5f9;padding:12px 14px;border-radius:6px;font-size:.75rem;overflow-x:auto;margin:6px 0 12px;line-height:1.5;font-family:'SF Mono','Fira Code',monospace;white-space:pre;color:#334155}
        .dg table{min-width:auto}
        .dg th{font-size:.75rem;padding:8px 10px;background:#f8fafc;color:#475569;text-transform:uppercase;letter-spacing:.3px;border-bottom:2px solid #e2e8f0}
        .dg td{padding:8px 10px;border-bottom:1px solid #f1f5f9;vertical-align:top;font-size:.83rem}
        .dg strong{color:#1e293b}
        .dg .warn{font-size:.82rem;color:#92400e;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;padding:8px 12px;line-height:1.5;margin:8px 0}
        .dg .info{font-size:.82rem;color:#1e40af;background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 12px;line-height:1.5;margin:8px 0}

        /* ═══ COST UPLOAD ═══ */
        .cost-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;white-space:nowrap}
        .cost-badge-new{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
        .cost-badge-updated{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
        .cost-badge-complete{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
        .cost-source{font-size:.75rem;color:#64748b;font-weight:600}
        .cost-name{font-size:.82rem;color:#1e293b;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .cost-shortlink{font-family:'SF Mono','Fira Code',monospace;font-size:.78rem;color:var(--primary);font-weight:600;text-decoration:none}
        a.cost-shortlink:hover{text-decoration:underline;color:var(--accent)}
        #table-cost td input[type="text"],#table-cost td input[type="date"],#table-cost td input[type="number"]{width:100%;padding:5px 4px;border:1px solid #e2e8f0;border-radius:4px;font-size:.78rem;box-sizing:border-box}
        #table-cost td input:focus{outline:none;border-color:var(--primary)}
        .cost-updated{font-size:.72rem;color:#94a3b8;white-space:nowrap}

        /* ═══ RESPONSIVE ═══ */
        @media(max-width:768px){
            .setup-grid{grid-template-columns:1fr}
            .field-vals-row{flex-direction:column;gap:4px}
            .stats-bar{flex-direction:column}
            .beats-grid{grid-template-columns:1fr}
            .saved-beats{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
<div class="page">
  <!-- Primary navbar -->
  <header class="main-navbar d-print-none">
    <div class="navbar-brand">&#9670; TRACKS</div>
    <div class="navbar-user">
      <span>Demo User</span>
      <div class="navbar-avatar">DU</div>
    </div>
  </header>

  <!-- Secondary nav -->
  <nav class="secondary-nav d-print-none">
    <a href="#">Dashboard</a>
    <a href="#">Attribution</a>
    <a href="#" class="active">Tools</a>
    <a href="#">FAQ</a>
    <a href="#">Documentation</a>
  </nav>

  <div class="page-wrapper">
    <!-- Page header -->
    <div class="page-header d-print-none">
      <div class="container-xl">
        <div class="page-pretitle"><a href="#">Enshrouded</a> / <a href="#">Tools</a></div>
        <h2 class="page-title">Tracking Links</h2>
      </div>
    </div>

    <!-- Page body -->
    <div class="page-body">
      <div class="container-xl">
        <div class="shell-card">
          <!-- Hero -->
          <div class="card-img-top-hero">
            <div class="hero-btn-group">
              <button class="hero-devguide-btn" onclick="switchMode('devguide')">Dev Guide</button>
              <button class="hero-devguide-btn" onclick="switchMode('prereq')">Prerequisite</button>
            </div>
            <div class="hero-overlay">
              <h1>Tracking Links: Enshrouded</h1>
              <p>Generate trackable campaign links for Influencers, Media Houses, and Organic Media</p>
            </div>
          </div>

          <!-- Card body = all existing tool content -->
          <div class="card-body-main">

    <div class="mode-toggle">
        <button class="mode-btn active" onclick="switchMode('guide')">Guide</button>
        <button class="mode-btn" onclick="switchMode('tool')">Influencer</button>
        <button class="mode-btn" onclick="switchMode('mh')">Media Houses</button>
        <button class="mode-btn" onclick="switchMode('om')">Organic Media</button>
        <button class="mode-btn" onclick="switchMode('cost')">Cost Upload</button>
    </div>

    <!-- ═══════════ GUIDE PANEL ═══════════ -->
    <div id="mode-guide" class="mode-panel active"></div>

    <!-- ═══════════ TOOL PANEL ═══════════ -->
    <div id="mode-tool" class="mode-panel">

    <!-- Hidden inputs for game/project (hardcoded — inherited from Game model in the real app) -->
    <input type="hidden" id="inf_gamename" value="Enshrouded">
    <input type="hidden" id="inf_project" value="ENS">

    <!-- ═══════════ BEAT SETUP ═══════════ -->
    <div style="margin-bottom:12px;font-size:.88rem;color:#475569;line-height:1.6">
        <strong style="color:var(--primary)">Generate trackable links for creators and influencers.</strong> Select an existing beat or create a new one, then add creator rows to generate links. Everything autosaves as you work.
    </div>
    <div class="bld-setup">
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> Select Beat
            <select id="beat-select" onchange="if(this.value)selectBeat(this.value)">
                <option value="" disabled selected>Select a beat\u2026</option>
            </select>
        </label>
        <span style="color:#cbd5e1;font-size:.82rem;font-weight:600">or</span>
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> New Beat
            <input type="text" id="beat-input" placeholder="e.g. Launch" onkeydown="if(event.key==='Enter')addBeat()">
        </label>
        <button class="btn-gen" onclick="addBeat()">Create</button>
    </div>
    <div id="beats-grid" class="beats-grid"></div>

    <!-- ═══════════ ACTIVE BEAT SECTION (hidden until a beat is selected) ═══════════ -->
    <div id="active-beat-section" style="display:none">

    <!-- ═══════════ TRACKER TABLE ═══════════ -->
    <div class="card" id="card-tracker">
        <h2 id="tracker-title">Creator Links</h2>
        <div class="callout callout-blue">
            <span>&#9432;</span>
            <span>Fill in all fields per row to generate a tracking link. The <b>Short Key</b> must be unique across all beats &mdash; it becomes the vanity path in the short URL.</span>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="stat-num" id="stat-total">0</span><span class="stat-label">Creators</span></div>
            <div class="stat"><span class="stat-num" id="stat-ready">0</span><span class="stat-label">Links Ready</span></div>
            <div class="stat"><span class="stat-num" id="stat-shortened">0</span><span class="stat-label">Shortened</span></div>
        </div>

        <div class="table-wrapper">
        <table id="table-inf">
            <thead>
                <tr>
                    <th style="width:13%">Creator</th>
                    <th style="width:20%">Dest URL</th>
                    <th style="width:9%">Lang</th>
                    <th style="width:11%">
                        <div class="tooltip-wrap">Platform <span class="tooltip-icon">i</span>
                            <span class="tooltip-text">The creator's publishing platform (YouTube, Twitch, etc.) — not an ad platform.</span>
                        </div>
                    </th>
                    <th style="width:9%">Type</th>
                    <th style="width:11%">Persona</th>
                    <th style="width:11%">Date</th>
                    <th style="width:10%">
                        <div class="tooltip-wrap">Short Key <span class="tooltip-icon">i</span>
                            <span class="tooltip-text">A unique identifier used in the short URL path, e.g. the creator's handle or nickname. Must be URL-safe.</span>
                        </div>
                    </th>
                    <th style="width:6%"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>

        <!-- ═══════════ FIELD VALUES (inline) ═══════════ -->
        <div class="field-vals-toggle" onclick="toggleFieldValues()">
            <span>Available Fields</span>
            <span class="field-vals-chev" id="field-vals-chev">&#9660;</span>
        </div>
        <div class="field-vals-body" id="field-vals-body"></div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="addRow()">+ Add Creator</button>
            <span class="spacer"></span>
            <button class="btn btn-outline" onclick="copyAllLinks()">Copy All Links</button>
            <button class="btn btn-outline" onclick="downloadCSV()">Download CSV</button>
        </div>
    </div>

    </div><!-- /active-beat-section -->

    <!-- ═══════════ HOW IT WORKS ═══════════ -->
    <div class="card" id="card-help">
        <h2>How It Works</h2>
        <p class="card-desc" style="margin-bottom:8px">Each creator link is assembled from the game's project code, the active beat, and the per-row fields into a structured campaign name. UTM parameters are appended to that row's destination URL:</p>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;font-size:.82rem;line-height:1.8;margin-bottom:12px">
            <div style="margin-bottom:8px"><b>Campaign name pattern:</b></div>
            <code style="background:#e2e8f0;padding:2px 6px;border-radius:3px;font-family:'SF Mono','Fira Code',monospace;font-size:.8rem">{project}-{persona}-{lang}-{beat}_{date}-{platform}_{type}-{creator}</code>
            <div style="margin-top:12px;margin-bottom:8px"><b>UTM parameters appended:</b></div>
            <table style="min-width:auto;font-size:.82rem;border-collapse:collapse">
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">campaign_name</td><td style="padding:2px 0;border:none">Full campaign name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">ad_group_name</td><td style="padding:2px 0;border:none">Creator name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_source</td><td style="padding:2px 0;border:none">Creator name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_medium</td><td style="padding:2px 0;border:none">"creator"</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_campaign</td><td style="padding:2px 0;border:none">Parent campaign (without creator suffix)</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_content</td><td style="padding:2px 0;border:none">Short key</td></tr>
            </table>
        </div>
    </div>

    </div><!-- /mode-tool -->

    <!-- ═══════════ MEDIA HOUSES PANEL ═══════════ -->
    <div id="mode-mh" class="mode-panel">

    <!-- Hidden inputs for game/project (shared with influencer) -->
    <input type="hidden" id="mh_gamename" value="Enshrouded">
    <input type="hidden" id="mh_project" value="ENS">

    <!-- ═══════════ MH BEAT SETUP ═══════════ -->
    <div style="margin-bottom:12px;font-size:.88rem;color:#475569;line-height:1.6">
        <strong style="color:var(--primary)">Generate trackable links for media house placements.</strong> Select an existing beat or create a new one, then add placement rows to generate links. Everything autosaves as you work.
    </div>
    <div class="bld-setup">
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> Select Beat
            <select id="beat-select-mh" onchange="if(this.value)selectBeat(this.value)">
                <option value="" disabled selected>Select a beat…</option>
            </select>
        </label>
        <span style="color:#cbd5e1;font-size:.82rem;font-weight:600">or</span>
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> New Beat
            <input type="text" id="beat-input-mh" placeholder="e.g. Launch" onkeydown="if(event.key==='Enter')addBeat()">
        </label>
        <button class="btn-gen" onclick="addBeat()">Create</button>
    </div>
    <div id="mh-beats-grid" class="beats-grid"></div>

    <!-- ═══════════ MH ACTIVE BEAT SECTION ═══════════ -->
    <div id="active-mh-section" style="display:none">

    <div class="card" id="card-mh-tracker">
        <h2 id="mh-tracker-title">Placement Links</h2>
        <div class="callout callout-blue">
            <span>&#9432;</span>
            <span>Fill in all fields per row to generate a tracking link. The <b>Short Key</b> must be unique across all beats and both tools &mdash; it becomes the vanity path in the short URL.</span>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="stat-num" id="mh-stat-total">0</span><span class="stat-label">Placements</span></div>
            <div class="stat"><span class="stat-num" id="mh-stat-ready">0</span><span class="stat-label">Links Ready</span></div>
            <div class="stat"><span class="stat-num" id="mh-stat-shortened">0</span><span class="stat-label">Shortened</span></div>
        </div>

        <div class="table-wrapper">
        <table id="table-mh">
            <thead>
                <tr>
                    <th style="width:14%">Media House</th>
                    <th style="width:18%">Dest URL</th>
                    <th style="width:8%">GEO</th>
                    <th style="width:12%">Placement</th>
                    <th style="width:10%">Ad Type</th>
                    <th style="width:12%">Strategy</th>
                    <th style="width:11%">Start Date</th>
                    <th style="width:9%">
                        <div class="tooltip-wrap">Short Key <span class="tooltip-icon">i</span>
                            <span class="tooltip-text">A unique identifier used in the short URL path. Must be URL-safe and unique across both Influencer and Media Houses.</span>
                        </div>
                    </th>
                    <th style="width:6%"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>

        <!-- ═══════════ MH FIELD VALUES ═══════════ -->
        <div class="field-vals-toggle" onclick="mhToggleFieldValues()">
            <span>Available Fields</span>
            <span class="field-vals-chev" id="mh-field-vals-chev">&#9660;</span>
        </div>
        <div class="field-vals-body" id="mh-field-vals-body"></div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="mhAddRow()">+ Add Placement</button>
            <span class="spacer"></span>
            <button class="btn btn-outline" onclick="mhCopyAllLinks()">Copy All Links</button>
            <button class="btn btn-outline" onclick="mhDownloadCSV()">Download CSV</button>
        </div>
    </div>

    </div><!-- /active-mh-section -->

    <!-- ═══════════ MH HOW IT WORKS ═══════════ -->
    <div class="card" id="card-mh-help">
        <h2>How It Works</h2>
        <p class="card-desc" style="margin-bottom:8px">Each media house link is assembled from the game's project code, the active beat, and the per-row fields into a structured campaign name. UTM parameters are appended to that row's destination URL:</p>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;font-size:.82rem;line-height:1.8;margin-bottom:12px">
            <div style="margin-bottom:8px"><b>Campaign name pattern:</b></div>
            <code style="background:#e2e8f0;padding:2px 6px;border-radius:3px;font-family:'SF Mono','Fira Code',monospace;font-size:.8rem">{project}-MediaHouse-{strategy}-{geo}_{date}-{placement}_{adType}-{mediaHouse}</code>
            <div style="margin-top:12px;margin-bottom:8px"><b>UTM parameters appended:</b></div>
            <table style="min-width:auto;font-size:.82rem;border-collapse:collapse">
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">campaign_name</td><td style="padding:2px 0;border:none">Full campaign name (with media house suffix)</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">ad_group_name</td><td style="padding:2px 0;border:none">Media house name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_source</td><td style="padding:2px 0;border:none">Media house name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_medium</td><td style="padding:2px 0;border:none">"mediahouse"</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_campaign</td><td style="padding:2px 0;border:none">Parent campaign (without media house suffix)</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_content</td><td style="padding:2px 0;border:none">Short key</td></tr>
            </table>
        </div>
    </div>

    </div><!-- /mode-mh -->

    <!-- ═══════════ ORGANIC MEDIA PANEL ═══════════ -->
    <div id="mode-om" class="mode-panel">

    <!-- Hidden inputs for game/project (shared) -->
    <input type="hidden" id="om_gamename" value="Enshrouded">
    <input type="hidden" id="om_project" value="ENS">

    <!-- ═══════════ OM BEAT SETUP ═══════════ -->
    <div style="margin-bottom:12px;font-size:.88rem;color:#475569;line-height:1.6">
        <strong style="color:var(--primary)">Generate trackable links for organic media activities.</strong> Select an existing beat or create a new one, then add rows to generate links. Everything autosaves as you work.
    </div>
    <div class="bld-setup">
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> Select Beat
            <select id="beat-select-om" onchange="if(this.value)selectBeat(this.value)">
                <option value="" disabled selected>Select a beat…</option>
            </select>
        </label>
        <span style="color:#cbd5e1;font-size:.82rem;font-weight:600">or</span>
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> New Beat
            <input type="text" id="beat-input-om" placeholder="e.g. Launch" onkeydown="if(event.key==='Enter')addBeat()">
        </label>
        <button class="btn-gen" onclick="addBeat()">Create</button>
    </div>
    <div id="om-beats-grid" class="beats-grid"></div>

    <!-- ═══════════ OM ACTIVE BEAT SECTION ═══════════ -->
    <div id="active-om-section" style="display:none">

    <div class="card" id="card-om-tracker">
        <h2 id="om-tracker-title">Organic Links</h2>
        <div class="callout callout-blue">
            <span>&#9432;</span>
            <span>Fill in all fields per row to generate a tracking link. The <b>Short Key</b> must be unique across all beats and all tools &mdash; it becomes the vanity path in the short URL.</span>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="stat-num" id="om-stat-total">0</span><span class="stat-label">Entries</span></div>
            <div class="stat"><span class="stat-num" id="om-stat-ready">0</span><span class="stat-label">Links Ready</span></div>
            <div class="stat"><span class="stat-num" id="om-stat-shortened">0</span><span class="stat-label">Shortened</span></div>
        </div>

        <div class="table-wrapper">
        <table id="table-om">
            <thead>
                <tr>
                    <th style="width:14%">Activity</th>
                    <th style="width:28%">Dest URL</th>
                    <th style="width:18%">Placement</th>
                    <th style="width:14%">Start Date</th>
                    <th style="width:14%">
                        <div class="tooltip-wrap">Short Key <span class="tooltip-icon">i</span>
                            <span class="tooltip-text">A unique identifier used in the short URL path. Must be URL-safe and unique across all tools.</span>
                        </div>
                    </th>
                    <th style="width:6%"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>

        <!-- ═══════════ OM FIELD VALUES ═══════════ -->
        <div class="field-vals-toggle" onclick="omToggleFieldValues()">
            <span>Available Fields</span>
            <span class="field-vals-chev" id="om-field-vals-chev">&#9660;</span>
        </div>
        <div class="field-vals-body" id="om-field-vals-body"></div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="omAddRow()">+ Add Entry</button>
            <span class="spacer"></span>
            <button class="btn btn-outline" onclick="omCopyAllLinks()">Copy All Links</button>
            <button class="btn btn-outline" onclick="omDownloadCSV()">Download CSV</button>
        </div>
    </div>

    </div><!-- /active-om-section -->

    <!-- ═══════════ OM HOW IT WORKS ═══════════ -->
    <div class="card" id="card-om-help">
        <h2>How It Works</h2>
        <p class="card-desc" style="margin-bottom:8px">Each organic media link is assembled from the game's project code, the active beat, and the per-row fields into a structured campaign name. UTM parameters are appended to that row's destination URL:</p>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;font-size:.82rem;line-height:1.8;margin-bottom:12px">
            <div style="margin-bottom:8px"><b>Campaign name pattern:</b></div>
            <code style="background:#e2e8f0;padding:2px 6px;border-radius:3px;font-family:'SF Mono','Fira Code',monospace;font-size:.8rem">{project}-Organic-{beat}_{date}-{activity}-{placement}</code>
            <div style="margin-top:12px;margin-bottom:8px"><b>UTM parameters appended:</b></div>
            <table style="min-width:auto;font-size:.82rem;border-collapse:collapse">
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">campaign_name</td><td style="padding:2px 0;border:none">Full campaign name</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">ad_group_name</td><td style="padding:2px 0;border:none">Placement</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_source</td><td style="padding:2px 0;border:none">Placement (lowercase)</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_medium</td><td style="padding:2px 0;border:none">"organic"</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_campaign</td><td style="padding:2px 0;border:none">Full campaign name (same as campaign_name)</td></tr>
                <tr><td style="padding:2px 12px 2px 0;color:#64748b;border:none">utm_content</td><td style="padding:2px 0;border:none">Short key</td></tr>
            </table>
        </div>
    </div>

    </div><!-- /mode-om -->

    <!-- ═══════════ COST UPLOAD PANEL ═══════════ -->
    <div id="mode-cost" class="mode-panel">

    <div style="margin-bottom:12px;font-size:.88rem;color:#475569;line-height:1.6">
        <strong style="color:var(--primary)">Review and annotate cost data across all tracking tools.</strong> Select a beat to see aggregated entries from Influencer, Media Houses, and Organic Media. Source data is read-only &mdash; edit cost fields here.
    </div>
    <div class="bld-setup">
        <label class="bld-setup-lbl">
            <span style="color:#f59e0b">&#9679;</span> Select Beat
            <select id="beat-select-cost" onchange="if(this.value)selectBeat(this.value)">
                <option value="" disabled selected>Select a beat…</option>
            </select>
        </label>
    </div>

    <!-- ═══════════ COST ACTIVE BEAT SECTION ═══════════ -->
    <div id="active-cost-section" style="display:none">

    <div class="card" id="card-cost-tracker">
        <h2 id="cost-tracker-title">Cost Upload</h2>
        <div class="callout callout-blue">
            <span>&#9432;</span>
            <span>This table aggregates entries from all three tracking tools. Source columns (Status, Source, Name, Short Key) are <b>read-only</b>. Use the cost fields (Budget, End Date, Days, Handle, Hashtags, Notes) to annotate each entry. Only entries with a Short Key appear here.</span>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="stat-num" id="cost-stat-total">0</span><span class="stat-label">Entries</span></div>
            <div class="stat"><span class="stat-num" id="cost-stat-new">0</span><span class="stat-label">New</span></div>
            <div class="stat"><span class="stat-num" id="cost-stat-updated">0</span><span class="stat-label">Updated</span></div>
            <div class="stat"><span class="stat-num" id="cost-stat-complete">0</span><span class="stat-label">Complete</span></div>
        </div>

        <div class="table-wrapper">
        <table id="table-cost">
            <thead>
                <tr>
                    <th style="width:5%">Status</th>
                    <th style="width:7%">Source</th>
                    <th style="width:10%">Name</th>
                    <th style="width:8%">Short Key</th>
                    <th style="width:8%">Budget</th>
                    <th style="width:9%">End Date</th>
                    <th style="width:5%">Days</th>
                    <th style="width:9%">Handle</th>
                    <th style="width:11%">Hashtags</th>
                    <th style="width:16%">Notes</th>
                    <th style="width:12%">Updated</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>

        <div class="action-bar">
            <span class="spacer"></span>
            <button class="btn btn-outline" onclick="costDownloadCSV()">Download CSV</button>
        </div>
    </div>

    </div><!-- /active-cost-section -->

    </div><!-- /mode-cost -->

    <!-- ═══════════ DEV GUIDE PANEL ═══════════ -->
    <div id="mode-devguide" class="mode-panel"></div>

    <!-- ═══════════ PREREQUISITE PANEL ═══════════ -->
    <div id="mode-prereq" class="mode-panel"></div>

          </div><!-- card-body-main -->
        </div><!-- shell-card -->
      </div><!-- container-xl -->
    </div><!-- page-body -->

    <!-- Footer -->
    <footer class="app-footer d-print-none">
      &copy; 2026 <a href="#">Second Stage GmbH</a>. All rights reserved.
    </footer>
  </div><!-- page-wrapper -->
</div><!-- page -->

<script>
// ==================== DEFAULTS & CUSTOM VALUE LISTS ====================
const DEFAULTS = {
    langs:    ['EN','DE','FR','ES','IT','PT','PL','JP','KR','CN'],
    plats:    ['YouTube','Twitch','TikTok','Instagram','X','Kick'],
    types:    ['VOD','Stream','Short','Post','Story','Reel'],
    personas: ['Creator','Influencer','Ambassador','Partner']
};

let lists = JSON.parse(JSON.stringify(DEFAULTS));
const CUSTOM = {};

(function loadCustomValues(){
    const saved = localStorage.getItem('tracksInfluencerLists');
    if(saved){
        try {
            const data = JSON.parse(saved);
            lists = JSON.parse(JSON.stringify(DEFAULTS));
            for(const key in data){
                if(lists[key]) data[key].forEach(v => {
                    if(!lists[key].includes(v)){
                        lists[key].push(v);
                        if(!CUSTOM[key]) CUSTOM[key] = new Set();
                        CUSTOM[key].add(v);
                    }
                });
            }
        } catch(e){}
    }
})();

function saveLists(){
    localStorage.setItem('tracksInfluencerLists', JSON.stringify(lists));
}

// ==================== MH DEFAULTS & CUSTOM VALUE LISTS ====================
const MH_DEFAULTS = {
    houses:     ['IGN','Publisher Collective','Webedia'],
    geos:       ['EN','DE','FR','ES','IT','PT','PL','JP','KR','CN'],
    placements: ['Takeover','Interstitial','Banner','Siteskin','PreRoll','Roadblock','Exclusive Day','Video Wall'],
    adtypes:    ['Display','Video','High Impact'],
    strategies: ['Awareness','Consideration']
};

let mhLists = JSON.parse(JSON.stringify(MH_DEFAULTS));
const MH_CUSTOM = {};

(function loadMHCustomValues(){
    const saved = localStorage.getItem('tracksMediaHouseLists');
    if(saved){
        try {
            const data = JSON.parse(saved);
            mhLists = JSON.parse(JSON.stringify(MH_DEFAULTS));
            for(const key in data){
                if(mhLists[key]) data[key].forEach(v => {
                    if(!mhLists[key].includes(v)){
                        mhLists[key].push(v);
                        if(!MH_CUSTOM[key]) MH_CUSTOM[key] = new Set();
                        MH_CUSTOM[key].add(v);
                    }
                });
            }
        } catch(e){}
    }
})();

function saveMHLists(){
    localStorage.setItem('tracksMediaHouseLists', JSON.stringify(mhLists));
}

const MH_FIELD_META = [
    { key:'houses',     label:'Media House',  selectCls:'m-house' },
    { key:'geos',       label:'GEO',          selectCls:'m-geo' },
    { key:'placements', label:'Placement',     selectCls:'m-placement' },
    { key:'adtypes',    label:'Ad Type',       selectCls:'m-adtype' },
    { key:'strategies', label:'Strategy',      selectCls:'m-strategy' }
];

// ==================== OM DEFAULTS & CUSTOM VALUE LISTS ====================
const OM_DEFAULTS = {
    activities: ['PR','Article','News','Social','Content','Guide','Newsletter'],
    omPlacements: ['Post','Instagram','Discord','Twitch','Kick','Steam','Community','Blog','X','Facebook','TikTok','BlueSky','YouTube','IGN','Press Release','LinkedIn']
};

let omLists = JSON.parse(JSON.stringify(OM_DEFAULTS));
const OM_CUSTOM = {};

(function loadOMCustomValues(){
    const saved = localStorage.getItem('tracksOrganicMediaLists');
    if(saved){
        try {
            const data = JSON.parse(saved);
            omLists = JSON.parse(JSON.stringify(OM_DEFAULTS));
            for(const key in data){
                if(omLists[key]) data[key].forEach(v => {
                    if(!omLists[key].includes(v)){
                        omLists[key].push(v);
                        if(!OM_CUSTOM[key]) OM_CUSTOM[key] = new Set();
                        OM_CUSTOM[key].add(v);
                    }
                });
            }
        } catch(e){}
    }
})();

function saveOMLists(){
    localStorage.setItem('tracksOrganicMediaLists', JSON.stringify(omLists));
}

const OM_FIELD_META = [
    { key:'activities',   label:'Activity',   selectCls:'o-activity' },
    { key:'omPlacements', label:'Placement',  selectCls:'o-placement' }
];

// ==================== BEAT STATE ====================
let STATE = { beats: [], activeBeatId: null, game: 'Enshrouded' };

function loadState(){
    const saved = localStorage.getItem('tracksInfluencerState');
    if(saved){ try { Object.assign(STATE, JSON.parse(saved)); } catch(e){} }
    STATE.game = 'Enshrouded';
    if(STATE.beats.length && !STATE.activeBeatId) STATE.activeBeatId = STATE.beats[0].id;
}

function saveState(){
    localStorage.setItem('tracksInfluencerState', JSON.stringify(STATE));
}

function populateBeatSelect(){
    ['beat-select','beat-select-mh','beat-select-om','beat-select-cost'].forEach(selId => {
        const sel = document.getElementById(selId); if(!sel) return;
        sel.innerHTML = '';
        const ph = document.createElement('option'); ph.value = ''; ph.textContent = 'Select a beat\u2026'; ph.disabled = true;
        if(!STATE.activeBeatId || !STATE.beats.find(b => b.id === STATE.activeBeatId)) ph.selected = true;
        sel.appendChild(ph);
        STATE.beats.forEach(b => {
            const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name;
            if(b.id === STATE.activeBeatId) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

function syncActiveRows(){
    const beat = getActiveBeat();
    if(!beat) return;
    beat.rows = [];
    document.querySelectorAll('#table-inf tbody tr.row-inputs').forEach(row => {
        beat.rows.push({
            creator:  row.querySelector('.i-creator').value,
            dest:     row.querySelector('.i-dest').value,
            lang:     row.querySelector('.i-lang').value,
            plat:     row.querySelector('.i-plat').value,
            type:     row.querySelector('.i-type').value,
            persona:  row.querySelector('.i-persona').value,
            date:     row.querySelector('.i-date').value,
            shortKey: row.querySelector('.i-key').value
        });
    });
}

function getActiveBeat(){
    return STATE.beats.find(b => b.id === STATE.activeBeatId) || null;
}

// ==================== BEAT MANAGEMENT ====================
function addBeat(){
    const tab = getActiveToolTab();
    const inputId = tab === 'mh' ? 'beat-input-mh' : tab === 'om' ? 'beat-input-om' : 'beat-input';
    const nameEl = document.getElementById(inputId);
    const name = nameEl.value.trim();
    if(!name){ nameEl.focus(); return; }
    if(STATE.beats.some(b => b.name.toLowerCase() === name.toLowerCase())){
        alert('A beat with this name already exists.'); nameEl.select(); return;
    }
    syncCurrentTab();
    const beat = { id: 'beat-' + Date.now(), name: name, createdAt: new Date().toISOString(), rows: [], mhRows: [], omRows: [], costData: {} };
    STATE.beats.push(beat);
    STATE.activeBeatId = beat.id;
    saveState();
    nameEl.value = '';
    populateBeatSelect();
    renderBeatsForTab();
    if(tab === 'mh'){ mhRenderRows(); mhAddRow(); }
    else if(tab === 'om'){ omRenderRows(); omAddRow(); }
    else { renderRows(); addRow(); }
}

function selectBeat(id){
    if(STATE.activeBeatId === id) return;
    syncCurrentTab();
    STATE.activeBeatId = id;
    saveState();
    populateBeatSelect();
    renderBeatsForTab();
    const tab = getActiveToolTab();
    if(tab === 'mh') mhRenderRows();
    else if(tab === 'om') omRenderRows();
    else if(tab === 'cost') costRenderEntries();
    else renderRows();
}

function deleteBeat(id){
    const beat = STATE.beats.find(b => b.id === id);
    if(!beat) return;
    if(!confirm('Delete beat "' + beat.name + '" and all its rows?')) return;
    syncCurrentTab();
    STATE.beats = STATE.beats.filter(b => b.id !== id);
    if(STATE.activeBeatId === id) STATE.activeBeatId = STATE.beats.length ? STATE.beats[0].id : null;
    saveState();
    populateBeatSelect();
    renderBeatsForTab();
    const tab = getActiveToolTab();
    if(tab === 'mh') mhRenderRows();
    else if(tab === 'om') omRenderRows();
    else if(tab === 'cost') costRenderEntries();
    else renderRows();
}

function duplicateBeat(id){
    const orig = STATE.beats.find(b => b.id === id);
    if(!orig) return;
    syncCurrentTab();
    let newName = orig.name + ' Copy'; let n = 2;
    while(STATE.beats.some(b => b.name.toLowerCase() === newName.toLowerCase())) newName = orig.name + ' Copy ' + n++;
    const clone = {
        id: 'beat-' + Date.now(), name: newName, createdAt: new Date().toISOString(),
        rows: JSON.parse(JSON.stringify(orig.rows || [])),
        mhRows: JSON.parse(JSON.stringify(orig.mhRows || [])),
        omRows: JSON.parse(JSON.stringify(orig.omRows || [])),
        costData: {}
    };
    clone.rows.forEach(r => { r.shortKey = ''; });
    clone.mhRows.forEach(r => { r.shortKey = ''; });
    clone.omRows.forEach(r => { r.shortKey = ''; });
    STATE.beats.push(clone);
    STATE.activeBeatId = clone.id;
    saveState();
    populateBeatSelect();
    renderBeatsForTab();
    const tab = getActiveToolTab();
    if(tab === 'mh') mhRenderRows();
    else if(tab === 'om') omRenderRows();
    else if(tab === 'cost') costRenderEntries();
    else renderRows();
}

function escHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function getActiveToolTab(){
    if(document.getElementById('mode-mh').classList.contains('active')) return 'mh';
    if(document.getElementById('mode-om').classList.contains('active')) return 'om';
    if(document.getElementById('mode-cost').classList.contains('active')) return 'cost';
    return 'inf';
}

function syncCurrentTab(){
    const tab = getActiveToolTab();
    if(tab === 'cost') return;
    if(tab === 'mh') mhSyncActiveRows();
    else if(tab === 'om') omSyncActiveRows();
    else syncActiveRows();
}

function renderBeatsForTab(){
    const tab = getActiveToolTab();
    if(tab === 'cost') return;
    if(tab === 'mh') renderBeatsMH();
    else if(tab === 'om') renderBeatsOM();
    else renderBeats();
}

function renderBeats(){
    const container = document.getElementById('beats-grid');
    const activeSection = document.getElementById('active-beat-section');
    if(STATE.beats.length === 0){
        container.innerHTML = '';
        activeSection.style.display = 'none';
        return;
    }
    activeSection.style.display = 'block';
    const activeBeat = getActiveBeat();
    if(activeBeat) document.getElementById('tracker-title').textContent = 'Creator Links \u2014 ' + activeBeat.name;
    container.innerHTML = STATE.beats.map(b => {
        const isActive = b.id === STATE.activeBeatId;
        const rc = (b.rows || []).length;
        const ready = (b.rows || []).filter(r => r.creator && r.dest && r.lang && r.plat && r.type && r.persona && r.shortKey).length;
        return '<div class="beat-card' + (isActive ? ' active' : '') + '" onclick="selectBeat(\'' + b.id + '\')">' +
            '<div class="beat-card-header">' + escHtml(b.name) + '</div>' +
            '<div class="beat-card-stats">' + rc + ' creator' + (rc !== 1 ? 's' : '') + ' \u00b7 ' + ready + ' ready</div>' +
            '<div class="beat-card-actions" onclick="event.stopPropagation()">' +
                '<button class="beat-card-btn" onclick="duplicateBeat(\'' + b.id + '\')">Dupe</button>' +
                '<button class="beat-card-btn danger" onclick="deleteBeat(\'' + b.id + '\')">Del</button>' +
            '</div></div>';
    }).join('');
}

function renderBeatsMH(){
    const container = document.getElementById('mh-beats-grid');
    const activeSection = document.getElementById('active-mh-section');
    if(STATE.beats.length === 0){
        container.innerHTML = '';
        activeSection.style.display = 'none';
        return;
    }
    activeSection.style.display = 'block';
    const activeBeat = getActiveBeat();
    if(activeBeat) document.getElementById('mh-tracker-title').textContent = 'Placement Links \u2014 ' + activeBeat.name;
    container.innerHTML = STATE.beats.map(b => {
        const isActive = b.id === STATE.activeBeatId;
        const rc = (b.mhRows || []).length;
        const ready = (b.mhRows || []).filter(r => r.house && r.dest && r.geo && r.placement && r.adtype && r.strategy && r.shortKey).length;
        return '<div class="beat-card' + (isActive ? ' active' : '') + '" onclick="selectBeat(\'' + b.id + '\')">' +
            '<div class="beat-card-header">' + escHtml(b.name) + '</div>' +
            '<div class="beat-card-stats">' + rc + ' placement' + (rc !== 1 ? 's' : '') + ' \u00b7 ' + ready + ' ready</div>' +
            '<div class="beat-card-actions" onclick="event.stopPropagation()">' +
                '<button class="beat-card-btn" onclick="duplicateBeat(\'' + b.id + '\')">Dupe</button>' +
                '<button class="beat-card-btn danger" onclick="deleteBeat(\'' + b.id + '\')">Del</button>' +
            '</div></div>';
    }).join('');
}

function renderBeatsOM(){
    const container = document.getElementById('om-beats-grid');
    const activeSection = document.getElementById('active-om-section');
    if(STATE.beats.length === 0){
        container.innerHTML = '';
        activeSection.style.display = 'none';
        return;
    }
    activeSection.style.display = 'block';
    const activeBeat = getActiveBeat();
    if(activeBeat) document.getElementById('om-tracker-title').textContent = 'Organic Links \u2014 ' + activeBeat.name;
    container.innerHTML = STATE.beats.map(b => {
        const isActive = b.id === STATE.activeBeatId;
        const rc = (b.omRows || []).length;
        const ready = (b.omRows || []).filter(r => r.activity && r.dest && r.placement && r.shortKey).length;
        return '<div class="beat-card' + (isActive ? ' active' : '') + '" onclick="selectBeat(\'' + b.id + '\')">' +
            '<div class="beat-card-header">' + escHtml(b.name) + '</div>' +
            '<div class="beat-card-stats">' + rc + ' entr' + (rc !== 1 ? 'ies' : 'y') + ' \u00b7 ' + ready + ' ready</div>' +
            '<div class="beat-card-actions" onclick="event.stopPropagation()">' +
                '<button class="beat-card-btn" onclick="duplicateBeat(\'' + b.id + '\')">Dupe</button>' +
                '<button class="beat-card-btn danger" onclick="deleteBeat(\'' + b.id + '\')">Del</button>' +
            '</div></div>';
    }).join('');
}

// ==================== INLINE FIELD VALUES ====================
const FIELD_META = [
    { key:'langs',    label:'Language',         selectCls:'i-lang' },
    { key:'plats',    label:'Creator Platform',  selectCls:'i-plat' },
    { key:'types',    label:'Content Type',      selectCls:'i-type' },
    { key:'personas', label:'Persona',           selectCls:'i-persona' }
];

function toggleFieldValues(){
    const body = document.getElementById('field-vals-body');
    const chev = document.getElementById('field-vals-chev');
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : 'block';
    chev.style.transform = open ? 'rotate(-90deg)' : 'rotate(0)';
    if(!open) renderFieldValues();
}

function renderFieldValues(){
    const body = document.getElementById('field-vals-body');
    body.innerHTML = '';
    FIELD_META.forEach(fm => {
        const row = document.createElement('div'); row.className = 'field-vals-row';
        const lbl = document.createElement('div'); lbl.className = 'field-vals-label'; lbl.textContent = fm.label;
        row.appendChild(lbl);
        const valContainer = document.createElement('div'); valContainer.className = 'values-list';
        renderValsList(valContainer, fm.key);
        // inline add input
        const addWrap = document.createElement('span'); addWrap.className = 'val-add';
        const addInp = document.createElement('input'); addInp.placeholder = 'Add…';
        addInp.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); commitInlineAdd(fm.key, addInp); }});
        addWrap.appendChild(addInp);
        const addBtn = document.createElement('button'); addBtn.textContent = '+';
        addBtn.addEventListener('click', () => commitInlineAdd(fm.key, addInp));
        addWrap.appendChild(addBtn);
        valContainer.appendChild(addWrap);
        row.appendChild(valContainer);
        body.appendChild(row);
    });
    const note = document.createElement('div');
    note.style.cssText = 'font-size:.7rem;color:#10b981;margin-top:4px;font-style:italic;padding-bottom:8px';
    note.textContent = '\u270e custom values are saved in your browser';
    body.appendChild(note);
}

function renderValsList(container, key){
    (lists[key] || []).forEach(x => {
        const t = document.createElement('span');
        const isCustom = CUSTOM[key] && CUSTOM[key].has(x);
        t.className = 'val-tag' + (isCustom ? ' custom' : '');
        t.textContent = x;
        if(isCustom){
            const rm = document.createElement('span'); rm.className = 'val-rm'; rm.textContent = '\u00d7';
            rm.addEventListener('click', () => { removeCustomValue(key, x); });
            t.appendChild(rm);
        }
        container.appendChild(t);
    });
}

function commitInlineAdd(key, input){
    const val = input.value.trim().replace(/\s+/g, '');
    if(!val) return;
    if(lists[key].includes(val)){ input.value = ''; return; }
    lists[key].push(val);
    if(!CUSTOM[key]) CUSTOM[key] = new Set();
    CUSTOM[key].add(val);
    saveLists();
    refreshSelects(key);
    input.value = '';
    renderFieldValues();
}

function removeCustomValue(key, val){
    const idx = lists[key].indexOf(val);
    if(idx > -1) lists[key].splice(idx, 1);
    if(CUSTOM[key]) CUSTOM[key].delete(val);
    saveLists();
    refreshSelects(key);
    renderFieldValues();
}

function refreshSelects(key){
    const fm = FIELD_META.find(f => f.key === key);
    if(!fm) return;
    document.querySelectorAll('.' + fm.selectCls).forEach(sel => {
        const current = sel.value;
        sel.innerHTML = '<option value="" disabled>Select...</option>';
        lists[key].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v;
            if(v === current) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

// ==================== TABLE HELPERS ====================
function createSelect(opts, cls, selected){
    let h = '<select class="' + cls + '" onchange="onRowChange()"><option value="" disabled' + (!selected ? ' selected' : '') + '>Select...</option>';
    opts.forEach(o => { h += '<option value="' + o + '"' + (o === selected ? ' selected' : '') + '>' + o + '</option>'; });
    h += '</select>';
    return h;
}

function addRow(data){
    data = data || {};
    const tbody = document.querySelector('#table-inf tbody');

    const tr1 = document.createElement('tr');
    tr1.className = 'row-inputs';
    tr1.innerHTML =
        '<td><input type="text" class="i-creator" placeholder="Name" value="' + escHtml(data.creator || '') + '" oninput="onRowChange()"></td>' +
        '<td><input type="text" class="i-dest" placeholder="https://example.com" value="' + escHtml(data.dest || '') + '" oninput="onRowChange()"></td>' +
        '<td>' + createSelect(lists.langs, 'i-lang', data.lang) + '</td>' +
        '<td>' + createSelect(lists.plats, 'i-plat', data.plat) + '</td>' +
        '<td>' + createSelect(lists.types, 'i-type', data.type) + '</td>' +
        '<td>' + createSelect(lists.personas, 'i-persona', data.persona) + '</td>' +
        '<td><input type="date" class="i-date" value="' + (data.date || todayISO()) + '" oninput="onRowChange()"></td>' +
        '<td><input type="text" class="i-key" placeholder="handle" value="' + escHtml(data.shortKey || '') + '" oninput="onRowChange()"></td>' +
        '<td><div class="row-actions">' +
            '<button class="btn-dup" onclick="duplicateRow(this)" title="Duplicate">&#128196;</button>' +
            '<button class="btn-remove" onclick="removeRow(this)" title="Remove">&#10005;</button>' +
        '</div></td>';

    const tr2 = document.createElement('tr');
    tr2.className = 'row-links';
    tr2.innerHTML =
        '<td colspan="9"><div class="row-links-inner">' +
            '<div class="short-area">' +
                '<span class="short-result"></span>' +
                '<input type="text" class="short-input" placeholder="\u2014" readonly style="display:none">' +
                '<button class="btn-shorten" onclick="fetchShortLink(this)" disabled>Get Short Link</button>' +
            '</div>' +
            '<div class="link-box empty" data-long-url="" data-short-key="">Fill all fields...</div>' +
        '</div></td>';

    tbody.appendChild(tr1);
    tbody.appendChild(tr2);
    updateStats();
}

function renderRows(){
    const tbody = document.querySelector('#table-inf tbody');
    tbody.innerHTML = '';
    const beat = getActiveBeat();
    if(!beat){ updateStats(); return; }
    if(!beat.rows || beat.rows.length === 0){ addRow(); return; }
    beat.rows.forEach(r => addRow(r));
    updateAllLinks();
}

function removeRow(btn){
    const tbody = document.querySelector('#table-inf tbody');
    const tr1 = btn.closest('tr');
    const tr2 = tr1.nextElementSibling;
    tr1.remove();
    if(tr2 && tr2.classList.contains('row-links')) tr2.remove();
    if(tbody.querySelectorAll('tr.row-inputs').length === 0) addRow();
    onRowChange();
}

function duplicateRow(btn){
    const origRow1 = btn.closest('tr');
    const origRow2 = origRow1.nextElementSibling;
    const cloneRow1 = origRow1.cloneNode(true);
    const cloneRow2 = origRow2.cloneNode(true);
    // Copy input/select values from originals (cloneNode doesn't preserve dynamic values)
    const origInputs1 = origRow1.querySelectorAll('input, select');
    const cloneInputs1 = cloneRow1.querySelectorAll('input, select');
    origInputs1.forEach((el, i) => { cloneInputs1[i].value = el.value; });
    // Clear short key, short link, and reset shorten button on clone
    cloneRow1.querySelector('.i-key').value = '';
    cloneRow2.querySelector('.short-input').value = '';
    const shortResult = cloneRow2.querySelector('.short-result');
    shortResult.innerHTML = '';
    shortResult.style.display = 'none';
    const shortenBtn = cloneRow2.querySelector('.btn-shorten');
    shortenBtn.textContent = 'Get Short Link';
    shortenBtn.disabled = true;
    shortenBtn.style.display = '';
    shortenBtn.style.background = '';
    // Insert the cloned pair after the original pair
    origRow2.parentNode.insertBefore(cloneRow1, origRow2.nextSibling);
    cloneRow1.parentNode.insertBefore(cloneRow2, cloneRow1.nextSibling);
    onRowChange();
}

function onRowChange(){
    updateAllLinks();
    validateShortKeys();
    syncActiveRows();
    saveState();
    renderBeats();
}

// ==================== PROJECT CODE ====================
function deriveProjectCode(){
    const name = document.getElementById('inf_gamename').value.trim();
    const words = name.split(/\s+/).filter(w => w.length > 0);
    let code = '';
    if(words.length === 0) code = '';
    else if(words.length === 1) code = words[0].substring(0,3).toUpperCase();
    else if(words.length === 2) code = (words[0][0] + words[1].substring(0,2)).toUpperCase();
    else code = words.map(w => w[0]).join('').substring(0,3).toUpperCase();
    document.getElementById('inf_project').value = code;
}

// ==================== SHORT KEY VALIDATION (CROSS-TOOL) ====================
function collectAllShortKeys(excludeBeatId, excludeTool){
    const keys = {};
    function countRows(rows){
        for(const row of rows){
            const k = (row.shortKey || '').trim().toLowerCase();
            if(k) keys[k] = (keys[k] || 0) + 1;
        }
    }
    for(const beat of STATE.beats){
        if(beat.id === excludeBeatId) {
            // For the active beat, include the OTHER tools' rows from STATE
            if(excludeTool !== 'inf') countRows(beat.rows || []);
            if(excludeTool !== 'mh') countRows(beat.mhRows || []);
            if(excludeTool !== 'om') countRows(beat.omRows || []);
            continue;
        }
        // Non-active beats: include all tools from STATE
        countRows(beat.rows || []);
        countRows(beat.mhRows || []);
        countRows(beat.omRows || []);
    }
    return keys;
}

function validateShortKeys(){
    const otherKeys = collectAllShortKeys(STATE.activeBeatId, 'inf');
    const rows = document.querySelectorAll('#table-inf tbody tr.row-inputs');
    const currentKeys = {};
    rows.forEach(row => {
        const k = row.querySelector('.i-key').value.trim().toLowerCase();
        if(k) currentKeys[k] = (currentKeys[k] || 0) + 1;
    });
    rows.forEach(row => {
        const input = row.querySelector('.i-key');
        const k = input.value.trim().toLowerCase();
        if(!k){ input.classList.remove('duplicate'); input.title = ''; return; }
        const isDup = (currentKeys[k] > 1) || (otherKeys[k] > 0);
        if(isDup){
            input.classList.add('duplicate');
            input.title = 'This short key is already in use \u2014 short keys must be unique across all beats and tools';
        } else {
            input.classList.remove('duplicate');
            input.title = '';
        }
    });
}

function mhValidateShortKeys(){
    const otherKeys = collectAllShortKeys(STATE.activeBeatId, 'mh');
    const rows = document.querySelectorAll('#table-mh tbody tr.row-inputs');
    const currentKeys = {};
    rows.forEach(row => {
        const k = row.querySelector('.m-key').value.trim().toLowerCase();
        if(k) currentKeys[k] = (currentKeys[k] || 0) + 1;
    });
    rows.forEach(row => {
        const input = row.querySelector('.m-key');
        const k = input.value.trim().toLowerCase();
        if(!k){ input.classList.remove('duplicate'); input.title = ''; return; }
        const isDup = (currentKeys[k] > 1) || (otherKeys[k] > 0);
        if(isDup){
            input.classList.add('duplicate');
            input.title = 'This short key is already in use \u2014 short keys must be unique across all beats and tools';
        } else {
            input.classList.remove('duplicate');
            input.title = '';
        }
    });
}

function omValidateShortKeys(){
    const otherKeys = collectAllShortKeys(STATE.activeBeatId, 'om');
    const rows = document.querySelectorAll('#table-om tbody tr.row-inputs');
    const currentKeys = {};
    rows.forEach(row => {
        const k = row.querySelector('.o-key').value.trim().toLowerCase();
        if(k) currentKeys[k] = (currentKeys[k] || 0) + 1;
    });
    rows.forEach(row => {
        const input = row.querySelector('.o-key');
        const k = input.value.trim().toLowerCase();
        if(!k){ input.classList.remove('duplicate'); input.title = ''; return; }
        const isDup = (currentKeys[k] > 1) || (otherKeys[k] > 0);
        if(isDup){
            input.classList.add('duplicate');
            input.title = 'This short key is already in use \u2014 short keys must be unique across all beats and tools';
        } else {
            input.classList.remove('duplicate');
            input.title = '';
        }
    });
}

// ==================== LINK GENERATION ====================
function updateAllLinks(){
    const proj = document.getElementById('inf_project').value;
    const beat = getActiveBeat();
    const beatName = beat ? beat.name.replace(/\s+/g, '') : '';

    document.querySelectorAll('#table-inf tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const creator  = row.querySelector('.i-creator').value.trim().replace(/\s+/g, '');
        const dest     = row.querySelector('.i-dest').value.trim().replace(/\/$/,'');
        const lang     = row.querySelector('.i-lang').value;
        const plat     = row.querySelector('.i-plat').value;
        const type     = row.querySelector('.i-type').value;
        const persona  = row.querySelector('.i-persona').value;
        const dateRaw  = row.querySelector('.i-date').value;
        const shortKey = row.querySelector('.i-key').value.trim().replace(/\s+/g, '');
        const outBox   = linksRow.querySelector('.link-box');
        const shortenBtn = linksRow.querySelector('.btn-shorten');

        if(!creator || !dest || !lang || !plat || !type || !persona || !shortKey || !beatName){
            outBox.innerHTML = 'Fill all fields...';
            outBox.className = 'link-box empty';
            outBox.setAttribute('data-long-url', '');
            outBox.setAttribute('data-short-key', '');
            shortenBtn.disabled = true;
            return;
        }

        const date = formatDate(dateRaw);
        const prefix = proj ? proj + '-' : '';
        const parentCamp = prefix + persona + '-' + lang + '-' + beatName + '_' + date + '-' + plat + '_' + type;
        const campName = parentCamp + '-' + creator;

        const connector = dest.includes('?') ? '&' : '?';
        const params = new URLSearchParams();
        params.set('campaign_name', campName);
        params.set('ad_group_name', creator);
        params.set('utm_source', creator);
        params.set('utm_medium', 'creator');
        params.set('utm_campaign', parentCamp);
        params.set('utm_content', shortKey);

        const fullLink = dest + connector + params.toString();

        outBox.className = 'link-box';
        outBox.innerHTML = '<a href="' + fullLink + '" target="_blank">' + fullLink + '</a>';
        outBox.setAttribute('data-long-url', fullLink);
        outBox.setAttribute('data-short-key', shortKey);
        shortenBtn.disabled = false;
    });

    updateStats();
}

// ==================== SHORT LINK API ====================
async function fetchShortLink(btn){
    const linksRow = btn.closest('tr');
    const inputsRow = linksRow.previousElementSibling;
    const linkBox = linksRow.querySelector('.link-box');
    const shortInput = linksRow.querySelector('.short-input');
    const longUrl = linkBox.getAttribute('data-long-url');
    const shortKey = linkBox.getAttribute('data-short-key');
    const destVal = inputsRow.querySelector('.i-dest').value;

    if(!longUrl || !shortKey) return;

    let hostname;
    try { hostname = new URL(destVal).hostname.replace(/^www\./,''); }
    catch(e){ shortInput.value = 'Invalid URL'; return; }

    const apiUrl = `https://connect.${hostname}/shorten`;

    btn.textContent = 'Shortening...';
    btn.disabled = true;
    shortInput.value = '';

    const shortResult = linksRow.querySelector('.short-result');
    try {
        const requestUrl = `${apiUrl}?url=${encodeURIComponent(longUrl)}&short_key=${encodeURIComponent(shortKey)}`;
        const response = await fetch(requestUrl, { method: 'GET' });
        if(!response.ok) throw new Error('Network Error');
        const data = await response.json();
        if(data.short_url){
            shortInput.value = data.short_url;
            shortResult.innerHTML = '<a href="' + data.short_url + '" target="_blank">' + data.short_url + '</a>';
            shortResult.style.display = '';
            btn.style.display = 'none';
        } else {
            shortInput.value = 'Error';
            btn.textContent = 'Retry';
            btn.disabled = false;
        }
    } catch(error){
        console.error(error);
        shortInput.value = 'API Error';
        btn.textContent = 'Retry';
        btn.disabled = false;
        alert('Failed to shorten link.\nIn the production app, TRACKS handles shortening internally.\nThe POC cannot shorten because no service exists at "connect.' + hostname + '".');
    }

    updateStats();
}

// ==================== BULK ACTIONS ====================
function copyAllLinks(){
    const links = [];
    document.querySelectorAll('#table-inf tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        const shortUrl = linksRow.querySelector('.short-input').value;
        const creator = row.querySelector('.i-creator').value.trim();
        if(url){
            links.push(shortUrl ? `${creator}\t${shortUrl}\t${url}` : `${creator}\t\t${url}`);
        }
    });
    if(!links.length){ alert('No links to copy.'); return; }
    const text = 'Creator\tShort Link\tFull Link\n' + links.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('[onclick="copyAllLinks()"]');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = 'var(--green)';
        btn.style.color = '#fff';
        setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
    });
}

function downloadCSV(){
    const beat = getActiveBeat();
    const beatName = beat ? beat.name : 'unknown';
    const rows = [['Beat','Creator','DestURL','Language','Platform','Type','Persona','Date','ShortKey','CampaignName','FullLink','ShortLink']];
    document.querySelectorAll('#table-inf tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const creator  = row.querySelector('.i-creator').value.trim();
        const destUrl  = row.querySelector('.i-dest').value.trim();
        const lang     = row.querySelector('.i-lang').value;
        const plat     = row.querySelector('.i-plat').value;
        const type     = row.querySelector('.i-type').value;
        const persona  = row.querySelector('.i-persona').value;
        const dateVal  = row.querySelector('.i-date').value;
        const shortKey = row.querySelector('.i-key').value.trim();
        const longUrl  = linksRow.querySelector('.link-box').getAttribute('data-long-url') || '';
        const shortUrl = linksRow.querySelector('.short-input').value || '';

        let campName = '';
        if(longUrl){
            try { campName = new URL(longUrl).searchParams.get('campaign_name') || ''; } catch(e){}
        }

        if(creator) rows.push([beatName, creator, destUrl, lang, plat, type, persona, dateVal, shortKey, campName, longUrl, shortUrl]);
    });

    if(rows.length <= 1){ alert('No data to export.'); return; }

    const csv = rows.map(r => r.map(c => '"' + (c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'influencer_links_' + beatName + '_' + todayISO() + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ==================== STATS ====================
function updateStats(){
    let total = 0, ready = 0, shortened = 0;
    document.querySelectorAll('#table-inf tbody tr.row-inputs').forEach(row => {
        total++;
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        if(url) ready++;
        const shortVal = linksRow.querySelector('.short-input').value;
        if(shortVal && !shortVal.startsWith('Error') && !shortVal.startsWith('API')) shortened++;
    });
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-ready').textContent = ready;
    document.getElementById('stat-shortened').textContent = shortened;
}

// ==================== UTILITIES ====================
function formatDate(ds){
    if(!ds) return '';
    const d = new Date(ds);
    return `${d.getFullYear().toString().substr(-2)}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`;
}

function todayISO(){
    return new Date().toISOString().split('T')[0];
}

// ==================== MODE TOGGLE ====================
function switchMode(mode){
    document.querySelectorAll('.mode-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('mode-'+mode).classList.add('active');
    document.querySelectorAll('.mode-btn').forEach(b => {
        if((mode==='tool' && b.textContent==='Influencer') ||
           (mode==='mh' && b.textContent==='Media Houses') ||
           (mode==='om' && b.textContent==='Organic Media') ||
           (mode==='cost' && b.textContent==='Cost Upload') ||
           (mode==='guide' && b.textContent==='Guide') ||
           (mode==='devguide' && b.textContent==='Dev Guide') ||
           (mode==='prereq' && b.textContent==='Prerequisite'))
            b.classList.add('active');
    });
    if(mode==='guide') buildGuide();
    if(mode==='devguide') buildDevGuide();
    if(mode==='prereq') buildPrereq();
    if(mode==='tool'){ renderBeats(); if(getActiveBeat()) renderRows(); }
    if(mode==='mh'){ renderBeatsMH(); populateBeatSelect(); if(getActiveBeat()) mhRenderRows(); }
    if(mode==='om'){ renderBeatsOM(); populateBeatSelect(); if(getActiveBeat()) omRenderRows(); }
    if(mode==='cost'){ populateBeatSelect(); costRenderEntries(); }
}

// ==================== GUIDE ====================
function buildGuide(){
    const root = document.getElementById('mode-guide');
    if(root.children.length > 0) return;
    root.innerHTML =
    '<div class="gc">' +
        '<h2>Tracking Links</h2>' +
        '<p>Generate trackable campaign links with structured UTM parameters and consistent naming. Three tools cover different marketing channels, each with its own campaign name pattern:</p>' +
        '<ul>' +
        '<li><strong>Influencer</strong> \u2014 track creator and influencer partnerships (YouTube, Twitch, TikTok, etc.).</li>' +
        '<li><strong>Media Houses</strong> \u2014 track paid media buying placements (display, video, high-impact ads).</li>' +
        '<li><strong>Organic Media</strong> \u2014 track organic activities like PR, articles, social posts, and newsletters.</li>' +
        '</ul>' +
        '<p>All three tools share the same <strong>beats</strong> (campaign periods) and enforce <strong>globally unique short keys</strong> across every tab and beat.</p>' +
    '</div>' +
    '<div class="gc">' +
        '<h2>Campaign Name Patterns</h2>' +
        '<p>Each tool assembles a campaign name from the game\u2019s project code, the active beat, and the per-row fields. UTM parameters are appended to the destination URL.</p>' +
        '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:14px;margin:8px 0 12px;font-family:\'SF Mono\',\'Fira Code\',monospace;font-size:.82rem;line-height:2.2">' +
            '<div><strong style="font-family:-apple-system,sans-serif;color:#475569;font-size:.78rem">INFLUENCER</strong></div>' +
            '<span style="color:#6366f1;font-weight:600">{project}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#8b5cf6;font-weight:600">{persona}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#10b981;font-weight:600">{lang}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#f59e0b;font-weight:600">{beat}</span><span style="color:#d97706;font-weight:700">_</span><span style="color:#d97706;font-weight:600">{date}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#0ea5e9;font-weight:600">{platform}</span><span style="color:#94a3b8;font-weight:700">_</span><span style="color:#0ea5e9;font-weight:600">{type}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#ec4899;font-weight:600">{creator}</span>' +
            '<div style="margin-top:8px"><strong style="font-family:-apple-system,sans-serif;color:#475569;font-size:.78rem">MEDIA HOUSES</strong></div>' +
            '<span style="color:#6366f1;font-weight:600">{project}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#a855f7;font-weight:600">MediaHouse</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#8b5cf6;font-weight:600">{strategy}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#10b981;font-weight:600">{geo}</span><span style="color:#d97706;font-weight:700">_</span><span style="color:#d97706;font-weight:600">{date}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#0ea5e9;font-weight:600">{placement}</span><span style="color:#94a3b8;font-weight:700">_</span><span style="color:#0ea5e9;font-weight:600">{adType}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#ec4899;font-weight:600">{mediaHouse}</span>' +
            '<div style="margin-top:8px"><strong style="font-family:-apple-system,sans-serif;color:#475569;font-size:.78rem">ORGANIC MEDIA</strong></div>' +
            '<span style="color:#6366f1;font-weight:600">{project}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#a855f7;font-weight:600">Organic</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#f59e0b;font-weight:600">{beat}</span><span style="color:#d97706;font-weight:700">_</span><span style="color:#d97706;font-weight:600">{date}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#0ea5e9;font-weight:600">{activity}</span><span style="color:#94a3b8;font-weight:700">-</span>' +
            '<span style="color:#ec4899;font-weight:600">{placement}</span>' +
            '<div style="margin-top:8px;font-family:-apple-system,sans-serif;font-size:.78rem;color:#64748b">' +
                '<code style="background:#f1f5f9;padding:1px 5px;border-radius:3px;font-size:.78rem;color:var(--primary)">-</code> separates independent groups &nbsp;\u2022&nbsp; ' +
                '<code style="background:#f1f5f9;padding:1px 5px;border-radius:3px;font-size:.78rem;color:var(--primary)">_</code> joins related parts (beat+date, platform+type)' +
            '</div>' +
        '</div>' +
        '<div class="callout callout-blue" style="flex-direction:column;gap:6px">' +
            '<div style="display:flex;align-items:flex-start;gap:10px"><span>\u2139\ufe0f</span><span><strong>No spaces allowed.</strong> Names must not contain any spaces. All values are automatically stripped of whitespace during link generation.</span></div>' +
            '<div style="display:flex;align-items:flex-start;gap:10px"><span>\u2705</span><span><strong>Custom values are supported.</strong> Each tab has its own set of dropdown fields. Expand <strong>Available Fields</strong> in any tab to add or remove custom values inline. Custom values are saved separately per tab.</span></div>' +
        '</div>' +
    '</div>' +
    '<div class="gc">' +
        '<h2>Working with Beats</h2>' +
        '<p><strong>Beats organize your links by campaign period.</strong> Each beat is a separate workspace with its own set of rows per tab. Beats are shared across all three tabs \u2014 create a beat in one tab and it appears in the others.</p>' +
        '<ul>' +
        '<li><strong>Select a beat</strong> \u2014 use the dropdown to pick an existing beat.</li>' +
        '<li><strong>Create a beat</strong> \u2014 type a name (e.g. "Launch") and click "Create". Beat names must be unique per game.</li>' +
        '<li><strong>Duplicate</strong> \u2014 copies a beat\u2019s structure (all tabs) for a new campaign period. Short keys are cleared on the copy since they must be globally unique.</li>' +
        '<li><strong>Delete</strong> \u2014 removes the beat and all its rows across every tab (with confirmation).</li>' +
        '</ul>' +
    '</div>' +
    '<div class="gc">' +
        '<h2>Short Keys &amp; Short Links</h2>' +
        '<p><strong>Each row needs a unique short key</strong> \u2014 a URL-safe identifier (e.g. "pewds", "ign-takeover"). The short key serves two purposes:</p>' +
        '<ul>' +
        '<li>It becomes the <code>utm_content</code> value for analytics attribution.</li>' +
        '<li>It becomes the vanity path in the branded short URL: <code>https://connect.yourgame.com/<strong>{short_key}</strong></code></li>' +
        '</ul>' +
        '<div class="callout callout-amber">' +
            '<span>\u26a0\ufe0f</span><span><strong>Short keys must be unique across all beats and all tabs.</strong> If a key is already in use anywhere (Influencer, Media Houses, or Organic Media), the input field will be highlighted in red.</span>' +
        '</div>' +
        '<p>In the production app, short links are powered by <strong>game-branded domains</strong>. The client sets up a DNS record for <code>connect.{gamedomain}</code> pointing to TRACKS, and TRACKS serves as the shortening service. In this POC, short link generation is simulated.</p>' +
    '</div>' +
    '<div class="gc">' +
        '<h2>Cost Upload</h2>' +
        '<p><strong>Review and annotate cost data across all tracking tools.</strong> The Cost Upload tab aggregates entries from Influencer, Media Houses, and Organic Media into a single read-only view, with editable cost fields alongside.</p>' +
        '<ul>' +
        '<li><strong>Source data is read-only</strong> \u2014 Status, Source, Name, and Short Key are pulled from the other tabs. Edit source data in its original tab.</li>' +
        '<li><strong>Only entries with a Short Key appear</strong> \u2014 entries without a short key cannot be identified and are excluded.</li>' +
        '<li><strong>Status badges</strong> \u2014 <span style="background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;font-size:.75rem;font-weight:700">NEW</span> (no cost data yet), <span style="background:#dbeafe;color:#1e40af;padding:1px 6px;border-radius:3px;font-size:.75rem;font-weight:700">UPDATED</span> (source row changed since cost was last saved), <span style="background:#d1fae5;color:#065f46;padding:1px 6px;border-radius:3px;font-size:.75rem;font-weight:700">\u2713</span> (complete, source unchanged).</li>' +
        '<li><strong>Editable cost fields</strong> \u2014 Budget, End Date, Days, Handle, Hashtags, and Notes. Changes save automatically.</li>' +
        '<li><strong>Download CSV</strong> \u2014 export all entries with cost data and status for reporting.</li>' +
        '</ul>' +
        '<div class="callout callout-blue">' +
            '<span>\u2139\ufe0f</span><span>Cost Upload does not create its own rows. Create entries in Influencer, Media Houses, or Organic Media first, then annotate them here.</span>' +
        '</div>' +
    '</div>' +
    '<div class="gc">' +
        '<h2>Export &amp; Bulk Actions</h2>' +
        '<p>Each tab has its own action buttons:</p>' +
        '<ul>' +
        '<li><strong>Copy All Links</strong> \u2014 copies all generated links to the clipboard in tab-separated format (Influencer, Media Houses, Organic Media tabs).</li>' +
        '<li><strong>Download CSV</strong> \u2014 exports a full CSV with all fields specific to that tab, including campaign name, full link, and short link.</li>' +
        '<li><strong>Cost Upload CSV</strong> \u2014 includes beat, source, name, short key, all cost fields, status, and last-updated timestamp.</li>' +
        '</ul>' +
        '<div class="callout callout-amber">' +
            '<span>\u26a0\ufe0f</span><span><strong>POC limitation:</strong> Beats and links are saved to your browser\u2019s local storage. Use "Download CSV" to export before clearing browser data. In the TRACKS app, everything is saved to the database automatically.</span>' +
        '</div>' +
    '</div>';
}

// ==================== DEV GUIDE ====================
function buildDevGuide(){
    const root = document.getElementById('mode-devguide');
    root.innerHTML = '';

    // Helper to create a card
    function card(html){
        const c = document.createElement('div');
        c.className = 'card dg';
        c.innerHTML = html;
        root.appendChild(c);
    }

    // ─── Card 1: POC Overview ───
    card(
        '<h2>POC Overview</h2>'+
        '<p>This proof-of-concept validates the <strong>UI patterns, link generation logic, and data model</strong> for Tracking Links that will be integrated into the TRACKS platform. It is a single self-contained HTML file with no external dependencies.</p>'+

        '<h3>Purpose</h3>'+
        '<p>Give marketing teams a way to <strong>generate, manage, and shorten</strong> tracked campaign links across three channels \u2014 Influencer, Media Houses, and Organic Media \u2014 with structured UTM parameters and campaign names, plus a <strong>Cost Upload</strong> tab to annotate entries with cost/campaign metadata. Consistent naming ensures accurate attribution in analytics without relying on manual spreadsheet workflows.</p>'+

        '<h3>Core Concepts</h3>'+
        '<ul>'+
        '<li><strong>Game-scoped tool</strong> \u2014 like the Naming Convention and UTM Links tools, Tracking Links is scoped to a game via <code>/games/:game_id/tools/tracking_links</code>. The game name and project code are inherited from the <code>Game</code> model (read-only). The destination URL is set per row, allowing each link to point to a different landing page.</li>'+
        '<li><strong>Four tabs</strong> \u2014 <strong>Influencer</strong> (creator partnerships), <strong>Media Houses</strong> (paid media placements), <strong>Organic Media</strong> (PR, articles, social), and <strong>Cost Upload</strong> (read-only aggregation + editable cost fields). The first three generate tracking links; Cost Upload aggregates from all three for cost annotation.</li>'+
        '<li><strong>Beat management</strong> \u2014 links are organized by beat (campaign period). Users can add, select, duplicate, and delete beats. Each beat has its own set of rows per tab. Beats are stored in the shared <code>Game::NamingBeat</code> model and are available to both this tool and the Naming Convention Builder.</li>'+
        '<li><strong>Per-row fields</strong> \u2014 each row within a beat captures tab-specific fields plus a Destination URL and Short Key. All fields are required to generate a link.</li>'+
        '<li><strong>Three campaign name patterns</strong> \u2014 each tab has its own pattern (see section 2 below). Assembled from setup + row fields, appended as UTM params to the destination URL.</li>'+
        '<li><strong>Short links</strong> \u2014 game-branded short URLs via TRACKS\u2019s own shortening service. <code>connect.{game_domain}/{short_key}</code> 301-redirects to the full tracking URL. Managed internally by the TRACKS server \u2014 no external API call.</li>'+
        '<li><strong>Custom values</strong> \u2014 each tab has its own set of dropdown fields. Users can add custom options inline. Persisted in <code>localStorage</code> (POC) or the database (Rails app).</li>'+
        '<li><strong>Cost Upload</strong> \u2014 a fourth tab that aggregates entries (by short key) from all three link tabs, displaying source data read-only with editable cost fields (budget, end date, duration, handle, hashtags, notes). Status badges track NEW / UPDATED / COMPLETE state via source hash comparison.</li>'+
        '</ul>'+

        '<h3>Features Validated</h3>'+
        '<table><thead><tr><th>Feature</th><th>What it proves</th></tr></thead><tbody>'+
        '<tr><td><strong>Beat management</strong></td><td>Full beat CRUD: add, select, duplicate, delete. Each beat has its own set of rows per tab. Beat names must be unique per game. Duplicate clears short keys and cost data. In the Rails app, beats are stored in <code>Game::NamingBeat</code> (shared with the Naming Convention tool).</td></tr>'+
        '<tr><td><strong>Short key uniqueness</strong></td><td>Short keys are validated for uniqueness across all beats and all three link tabs. Duplicate keys are highlighted in red in real-time. This maps to a unique index on <code>[game_id, short_key]</code> in the database.</td></tr>'+
        '<tr><td><strong>Link generation (3 tabs)</strong></td><td>Structured campaign names with UTM parameters are assembled in real-time from setup + active beat + row fields. Each tab has its own pattern. All values are stripped of spaces.</td></tr>'+
        '<tr><td><strong>Short link integration</strong></td><td>Per-row "Get Short Link" calls the shortening service. UI handles loading, success, error, and retry states. In production, TRACKS is the shortening service (internal call, no CORS). In the POC, this fails gracefully with an error alert.</td></tr>'+
        '<tr><td><strong>Custom values (3 tabs)</strong></td><td>Inline value management via collapsible Available Fields section per tab. Values shown as tags with add/remove. Custom values immediately available in all table row dropdowns.</td></tr>'+
        '<tr><td><strong>Cost Upload</strong></td><td>Aggregates entries from all 3 link tabs. Read-only source columns + editable cost fields. Status badges (NEW/UPDATED/COMPLETE) based on source hash comparison. CSV export.</td></tr>'+
        '<tr><td><strong>Bulk actions</strong></td><td>"Copy All Links" (clipboard) and "Download CSV" (full export) per link tab. Cost Upload has its own CSV with cost fields + status.</td></tr>'+
        '<tr><td><strong>Row management</strong></td><td>Add, duplicate, and remove rows per link tab. Duplicate preserves all field values but clears the short link.</td></tr>'+
        '<tr><td><strong>Live stats</strong></td><td>Stat bars track totals, ready, shortened (link tabs) or total, new, updated, complete (cost tab) in real time.</td></tr>'+
        '</tbody></table>'
    );

    // ─── Card 2: Implementation Plan (was Card 3) ───
    card(
        '<h2>Implementation Plan \u2014 TRACKS App</h2>'+
        '<p>Step-by-step plan for integrating the Tracking Links into the <strong>TRACKS</strong> application. TRACKS is a <strong>Rails 8.1 / Hotwire (Turbo + Stimulus) / PostgreSQL</strong> app using <strong>Tabler Core</strong> UI, <strong>Vite</strong> for asset bundling, and <strong>I18n</strong> for all user-facing strings.</p>'+
        '<div class="warn"><strong>POC reference file:</strong> The single-file HTML proof-of-concept at <code>Desktop/TRACKS Tools/tracking_links.html</code> is the behavioral source of truth. All link generation logic, field definitions, known values, UI interactions, and Cost Upload behavior are implemented there. Extract and port to Ruby/Stimulus as described below.</div>'+
        '<div class="info"><strong>Shared foundation:</strong> This tool <strong>creates</strong> the <code>Game::NamingBeat</code> model and <code>game_naming_beats</code> table as shared infrastructure. The <strong>Naming Convention Builder</strong> (implemented later) will extend this model with campaign/ad group/creative associations. Beat management (add, select, duplicate, delete) is implemented here first and the data is shared by both tools.</div>'+

        '<h3>0. TRACKS Codebase Conventions</h3>'+
        '<p>This tool is <strong>significantly more complex</strong> than the existing UTM Links tool (which is a simple YAML-driven URL builder with 3 controller actions). Tracking Links introduces new patterns to the codebase: Turbo Stream responses, debounced autosave, complex Stimulus controllers, and DB-backed known values. Understand these conventions before starting:</p>'+
        '<table><thead><tr><th style="width:30%">Convention</th><th>Detail</th></tr></thead><tbody>'+
        '<tr><td><strong>UUID primary keys</strong></td><td>All tables use <code>id: :uuid</code>. All <code>t.references</code> need <code>type: :uuid</code>. This is set in <code>config/initializers/generators.rb</code>.</td></tr>'+
        '<tr><td><strong>SQL schema format</strong></td><td>Migrations produce <code>db/structure.sql</code> (not <code>schema.rb</code>). Use <code>rails db:migrate</code> as normal.</td></tr>'+
        '<tr><td><strong>Table naming</strong></td><td><code>Game::*</code> models use <code>game_</code>-prefixed tables (e.g. <code>Game::Entry</code> \u2192 <code>game_entries</code>). Each model sets <code>self.table_name</code> explicitly.</td></tr>'+
        '<tr><td><strong>Model pattern</strong></td><td><code>belongs_to :game, inverse_of: :</code>. Use <code>acts_as_list scope: :game_id</code> for sortable models. Add corresponding <code>has_many</code> to <code>Game</code> model.</td></tr>'+
        '<tr><td><strong>Controller pattern</strong></td><td><code>include Controller::GameLookup</code> + <code>before_action :find_game, :reject_demo</code>. Auth is handled by GameLookup (<code>before_action :authenticate</code>). No <code>Tools::BaseController</code> exists \u2014 inherit from <code>ApplicationController</code>.</td></tr>'+
        '<tr><td><strong>Routing</strong></td><td>Tools are nested inside <code>resources :games</code> under <code>namespace :tools</code>. See existing <code>utm_links</code> pattern.</td></tr>'+
        '<tr><td><strong>Views</strong></td><td>Use Tabler CSS classes (<code>.card</code>, <code>.table</code>, <code>.badge</code>, <code>.btn</code>, etc.). Use <code>content_for :pretitle, :title, :image_title, :image_subtitle</code>. Wrap tool content in <code>render "games/subpage_wrapper"</code>. Icons via <code>&lt;%= i :icon_name %&gt;</code> helper.</td></tr>'+
        '<tr><td><strong>Stimulus</strong></td><td>Currently only 4 basic controllers exist (clipboard, collapse, dropdown, hello). This tool introduces the first complex Stimulus controllers to the codebase. Place in <code>app/javascript/controllers/</code>.</td></tr>'+
        '<tr><td><strong>Turbo</strong></td><td>The existing codebase uses minimal Turbo (mostly <code>data-turbo-method: :delete</code>). This tool introduces <strong>Turbo Streams</strong> and <strong>Turbo Frames</strong> as new patterns. Expect to establish conventions other tools will follow.</td></tr>'+
        '<tr><td><strong>Code style</strong></td><td>Double quotes, trailing commas in multiline arrays/hashes (not in method args), 120-char max line length. <code>frozen_string_literal: true</code> in all Ruby files.</td></tr>'+
        '<tr><td><strong>Testing</strong></td><td>RSpec with fixtures (not FactoryBot). Feature specs in <code>spec/features/</code> for wiring. Unit specs with mocks. Max 1 expectation per example (use <code>:aggregate_failures</code> or compound matchers). VCR for HTTP. Every code file needs a corresponding spec file.</td></tr>'+
        '<tr><td><strong>Known values vs YAML</strong></td><td>The existing UTM Links tool loads channel configs from a static YAML file (<code>UtmChannel</code> model). Tracking Links uses <strong>DB-backed known values</strong> instead, because users need to add custom values per-game inline. This is a deliberate departure from the YAML pattern.</td></tr>'+
        '<tr><td><strong>Demo game</strong></td><td><code>Game::Demo</code> is a virtual, non-persisted game. <code>reject_demo</code> blocks write actions. Tracking Links should show read-only demo data or redirect, matching the existing pattern.</td></tr>'+
        '</tbody></table>'+

        // ─── 1. Architecture Overview ───
        '<h3>1. Architecture Overview</h3>'+
        '<p>The tool has <strong>four tabs</strong> \u2014 three link generators and one cost aggregator:</p>'+
        '<table><thead><tr><th>Tab</th><th>Purpose</th><th>Creates rows?</th><th>Model</th></tr></thead><tbody>'+
        '<tr><td><strong>Influencer</strong></td><td>Creator/influencer partnerships</td><td>Yes</td><td><code>Game::InfluencerLink</code></td></tr>'+
        '<tr><td><strong>Media Houses</strong></td><td>Paid media placements</td><td>Yes</td><td><code>Game::MediaHouseLink</code></td></tr>'+
        '<tr><td><strong>Organic Media</strong></td><td>PR, articles, social, newsletters</td><td>Yes</td><td><code>Game::OrganicMediaLink</code></td></tr>'+
        '<tr><td><strong>Cost Upload</strong></td><td>Cost annotation across all tabs</td><td>No (read-only aggregation)</td><td><code>Game::TrackingCostEntry</code></td></tr>'+
        '</tbody></table>'+
        '<p><strong>Shared infrastructure:</strong> All four tabs share the same beats (<code>Game::NamingBeat</code>), enforce globally unique short keys (<code>[game_id, short_key]</code>), and use the same short link service (<code>Game::ShortLink</code>). Cost Upload reads from the other three models and writes only its own cost data.</p>'+

        // ─── 2. Link Generation Patterns ───
        '<h3>2. Link Generation Patterns (All 3 Tabs)</h3>'+
        '<p>Each tab has its own campaign name pattern and UTM mapping. All patterns strip spaces from values and use the same separator conventions: <code>-</code> between groups, <code>_</code> between related parts.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Campaign Name Patterns</p>'+
        '<table><thead><tr><th style="width:15%">Tab</th><th style="width:55%">Pattern</th><th style="width:30%">Example</th></tr></thead><tbody>'+
        '<tr><td>Influencer</td><td><code>{project}-{persona}-{lang}-{beat}_{date}-{platform}_{type}-{creator}</code></td><td><code>ENS-Creator-EN-Launch_260219-YouTube_VOD-PewDiePie</code></td></tr>'+
        '<tr><td>Media Houses</td><td><code>{project}-MediaHouse-{strategy}-{geo}_{date}-{placement}_{adType}-{house}</code></td><td><code>ENS-MediaHouse-Awareness-DE_260301-Takeover_Display-IGN</code></td></tr>'+
        '<tr><td>Organic Media</td><td><code>{project}-Organic-{beat}_{date}-{activity}-{placement}</code></td><td><code>ENS-Organic-Launch_260219-PR-Instagram</code></td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">UTM Parameters per Tab</p>'+
        '<table><thead><tr><th style="width:20%">Parameter</th><th style="width:27%">Influencer</th><th style="width:27%">Media Houses</th><th style="width:26%">Organic Media</th></tr></thead><tbody>'+
        '<tr><td><code>campaign_name</code></td><td>Full name (with creator)</td><td>Full name (with house)</td><td>Full campaign name</td></tr>'+
        '<tr><td><code>ad_group_name</code></td><td>Creator name</td><td>House name</td><td>Placement</td></tr>'+
        '<tr><td><code>utm_source</code></td><td>Creator name</td><td>House name</td><td>Placement (lowercase)</td></tr>'+
        '<tr><td><code>utm_medium</code></td><td><code>"creator"</code></td><td><code>"mediahouse"</code></td><td><code>"organic"</code></td></tr>'+
        '<tr><td><code>utm_campaign</code></td><td>Parent campaign (no creator suffix)</td><td>Parent campaign (no house suffix)</td><td>Same as campaign_name</td></tr>'+
        '<tr><td><code>utm_content</code></td><td>Short key</td><td>Short key</td><td>Short key</td></tr>'+
        '</tbody></table>'+
        '<p><strong>Key differences:</strong> Influencer and Media Houses have a parent_campaign (campaign_name minus the last entity suffix). Organic Media uses the full campaign_name as utm_campaign (no separate parent). Organic Media\u2019s utm_source is lowercased; the other two preserve casing.</p>'+

        // ─── 3. Field Definitions ───
        '<h3>3. Field Definitions (All 3 Tabs)</h3>'+
        '<p>Shared fields (present in all tabs): <code>project</code> (read-only from Game), <code>beat</code> (shared NamingBeat), <code>dest_url</code> (per-row), <code>short_key</code> (globally unique per game), <code>date</code> (date picker).</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Influencer-specific fields</p>'+
        '<table><thead><tr><th style="width:16%">Field</th><th style="width:14%">DB Column</th><th>Description</th><th style="width:14%">Type</th></tr></thead><tbody>'+
        '<tr><td>Creator</td><td><code>creator</code></td><td>Creator/influencer name (free text, no spaces)</td><td>string, required</td></tr>'+
        '<tr><td>Language</td><td><code>lang</code></td><td>Content language code</td><td>known values</td></tr>'+
        '<tr><td>Platform</td><td><code>platform</code></td><td>Publishing platform (YouTube, Twitch\u2026)</td><td>known values</td></tr>'+
        '<tr><td>Type</td><td><code>content_type</code></td><td>Content type (VOD, Stream, Short\u2026)</td><td>known values</td></tr>'+
        '<tr><td>Persona</td><td><code>persona</code></td><td>Relationship tier (Creator, Influencer\u2026)</td><td>known values</td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Media Houses-specific fields</p>'+
        '<table><thead><tr><th style="width:16%">Field</th><th style="width:14%">DB Column</th><th>Description</th><th style="width:14%">Type</th></tr></thead><tbody>'+
        '<tr><td>Media House</td><td><code>house</code></td><td>Media house name (IGN, Webedia\u2026)</td><td>known values</td></tr>'+
        '<tr><td>GEO</td><td><code>geo</code></td><td>Geographic targeting (EN, DE\u2026)</td><td>known values</td></tr>'+
        '<tr><td>Placement</td><td><code>placement</code></td><td>Ad placement type (Takeover, Banner\u2026)</td><td>known values</td></tr>'+
        '<tr><td>Ad Type</td><td><code>ad_type</code></td><td>Creative format (Display, Video, High Impact)</td><td>known values</td></tr>'+
        '<tr><td>Strategy</td><td><code>strategy</code></td><td>Campaign strategy (Awareness, Consideration)</td><td>known values</td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Organic Media-specific fields</p>'+
        '<table><thead><tr><th style="width:16%">Field</th><th style="width:14%">DB Column</th><th>Description</th><th style="width:14%">Type</th></tr></thead><tbody>'+
        '<tr><td>Activity</td><td><code>activity</code></td><td>Activity type (PR, Article, News\u2026)</td><td>known values</td></tr>'+
        '<tr><td>Placement</td><td><code>placement</code></td><td>Channel/platform (Instagram, Discord\u2026)</td><td>known values</td></tr>'+
        '</tbody></table>'+
        '<p><strong>Note:</strong> Organic Media has fewer fields. It has no <code>lang</code>, no <code>persona</code>, and its campaign name includes <code>{beat}</code> directly (unlike Influencer/MH where beat is implicit in the beat context). Organic Media\u2019s <code>utm_campaign</code> equals <code>campaign_name</code> (no parent/child distinction).</p>'+

        // ─── 4. Known Values ───
        '<h3>4. Known Values &amp; Custom Values (All 3 Tabs)</h3>'+
        '<p>Each tab has its own known values model. Default values are seeded via YAML config. Custom values can be added per-game inline via the collapsible <strong>Available Fields</strong> section without approval.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Influencer known values \u2192 <code>Game::InfluencerKnownValue</code></p>'+
        '<table><thead><tr><th style="width:18%">Field</th><th>Default Known Values</th></tr></thead><tbody>'+
        '<tr><td>lang</td><td><code>EN</code>, <code>DE</code>, <code>FR</code>, <code>ES</code>, <code>IT</code>, <code>PT</code>, <code>PL</code>, <code>JP</code>, <code>KR</code>, <code>CN</code></td></tr>'+
        '<tr><td>platform</td><td><code>YouTube</code>, <code>Twitch</code>, <code>TikTok</code>, <code>Instagram</code>, <code>X</code>, <code>Kick</code></td></tr>'+
        '<tr><td>content_type</td><td><code>VOD</code>, <code>Stream</code>, <code>Short</code>, <code>Post</code>, <code>Story</code>, <code>Reel</code></td></tr>'+
        '<tr><td>persona</td><td><code>Creator</code>, <code>Influencer</code>, <code>Ambassador</code>, <code>Partner</code></td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Media Houses known values \u2192 <code>Game::MediaHouseKnownValue</code></p>'+
        '<table><thead><tr><th style="width:18%">Field</th><th>Default Known Values</th></tr></thead><tbody>'+
        '<tr><td>house</td><td><code>IGN</code>, <code>Publisher Collective</code>, <code>Webedia</code></td></tr>'+
        '<tr><td>geo</td><td><code>EN</code>, <code>DE</code>, <code>FR</code>, <code>ES</code>, <code>IT</code>, <code>PT</code>, <code>PL</code>, <code>JP</code>, <code>KR</code>, <code>CN</code></td></tr>'+
        '<tr><td>placement</td><td><code>Takeover</code>, <code>Interstitial</code>, <code>Banner</code>, <code>Siteskin</code>, <code>PreRoll</code>, <code>Roadblock</code>, <code>Exclusive Day</code>, <code>Video Wall</code></td></tr>'+
        '<tr><td>ad_type</td><td><code>Display</code>, <code>Video</code>, <code>High Impact</code></td></tr>'+
        '<tr><td>strategy</td><td><code>Awareness</code>, <code>Consideration</code></td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Organic Media known values \u2192 <code>Game::OrganicMediaKnownValue</code></p>'+
        '<table><thead><tr><th style="width:18%">Field</th><th>Default Known Values</th></tr></thead><tbody>'+
        '<tr><td>activity</td><td><code>PR</code>, <code>Article</code>, <code>News</code>, <code>Social</code>, <code>Content</code>, <code>Guide</code>, <code>Newsletter</code></td></tr>'+
        '<tr><td>placement</td><td><code>Post</code>, <code>Instagram</code>, <code>Discord</code>, <code>Twitch</code>, <code>Kick</code>, <code>Steam</code>, <code>Community</code>, <code>Blog</code>, <code>X</code>, <code>Facebook</code>, <code>TikTok</code>, <code>BlueSky</code>, <code>YouTube</code>, <code>IGN</code>, <code>Press Release</code>, <code>LinkedIn</code></td></tr>'+
        '</tbody></table>'+

        '<p><strong>Custom values lifecycle (same for all 3 tabs):</strong></p>'+
        '<ol>'+
        '<li>User expands <strong>Available Fields</strong> in any tab, types a new value, and clicks +.</li>'+
        '<li>The value is immediately added to all matching dropdown selects in that tab\u2019s table.</li>'+
        '<li>In the Rails app, a <code>POST</code> to the tab\u2019s known values controller creates the record and returns a Turbo Stream that appends <code>&lt;option&gt;</code> tags to all matching selects.</li>'+
        '</ol>'+
        '<p>Each tab has its own known values model and controller. The three models (<code>Game::InfluencerKnownValue</code>, <code>Game::MediaHouseKnownValue</code>, <code>Game::OrganicMediaKnownValue</code>) are structurally identical \u2014 they share the same schema (<code>game_id</code>, <code>field_key</code>, <code>value</code>) but use separate tables for clean scoping.</p>'+

        // ─── 5. Cost Upload Tab ───
        '<h3>5. Cost Upload Tab</h3>'+
        '<p>The Cost Upload tab is a <strong>read-only aggregation</strong> of entries from all three link tabs, with <strong>editable cost fields</strong> alongside. It does not create its own source rows.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">How it works</p>'+
        '<ol>'+
        '<li>User selects a beat (no beat creation in this tab \u2014 beat dropdown only).</li>'+
        '<li>The tab aggregates all entries (from <code>influencer_links</code>, <code>media_house_links</code>, <code>organic_media_links</code>) that belong to the selected beat and have a <code>short_key</code>. Entries without a short key are excluded.</li>'+
        '<li>Each entry shows read-only source columns (status badge, source tab name, entity name, short key) plus 6 editable cost fields.</li>'+
        '<li>Cost data is saved per <code>[game_id, naming_beat_id, short_key]</code> in the <code>tracking_cost_entries</code> table.</li>'+
        '</ol>'+

        '<p style="font-weight:600;margin:10px 0 4px">Table columns (11 total)</p>'+
        '<table><thead><tr><th style="width:10%">#</th><th style="width:15%">Column</th><th style="width:12%">Type</th><th>Notes</th></tr></thead><tbody>'+
        '<tr><td>1</td><td>Status</td><td>badge</td><td>NEW / UPDATED / \u2713 (computed, not stored)</td></tr>'+
        '<tr><td>2</td><td>Source</td><td>read-only</td><td>"Influencer" / "Media House" / "Organic"</td></tr>'+
        '<tr><td>3</td><td>Name</td><td>read-only</td><td>Creator / house / activity name from source row</td></tr>'+
        '<tr><td>4</td><td>Short Key</td><td>read-only link</td><td>Links to <code>connect.{domain}/{key}</code></td></tr>'+
        '<tr><td>5</td><td>Budget</td><td>text input</td><td>Free text (e.g. "5000", "5,000 EUR")</td></tr>'+
        '<tr><td>6</td><td>End Date</td><td>date input</td><td>Campaign end date</td></tr>'+
        '<tr><td>7</td><td>Days</td><td>number input</td><td>Activation duration in days</td></tr>'+
        '<tr><td>8</td><td>Handle</td><td>text input</td><td>e.g. @username</td></tr>'+
        '<tr><td>9</td><td>Hashtags</td><td>text input</td><td>e.g. #game, #ad</td></tr>'+
        '<tr><td>10</td><td>Notes</td><td>text input</td><td>Free text</td></tr>'+
        '<tr><td>11</td><td>Updated</td><td>read-only</td><td>Last save timestamp (DD.MM.YYYY HH:MM)</td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Status badge logic</p>'+
        '<pre>IF no cost entry exists OR all cost fields empty \u2192 NEW (amber badge)\nELSE IF stored source_hash \u2260 current source hash   \u2192 UPDATED (blue badge)\nELSE                                                \u2192 COMPLETE (green \u2713)</pre>'+
        '<p><strong>Source hash:</strong> <code>JSON.stringify</code> of the source row with sorted keys. Stored when cost data is saved. Compared against the current source row data to detect if the source was edited since the cost was last saved. In the Rails app, use <code>Digest::SHA256.hexdigest</code> of the sorted source attributes.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Cost data model</p>'+
        '<pre>'+
'# tracking_cost_entries table\n'+
'game_id:        FK to games\n'+
'naming_beat_id: FK to game_naming_beats\n'+
'short_key:      string, not null\n'+
'budget:         string          # free text\n'+
'end_date:       date            # optional\n'+
'duration:       integer         # days, optional\n'+
'handle:         string          # optional\n'+
'hashtags:       string          # optional\n'+
'notes:          text            # optional\n'+
'source_hash:    string          # for change detection\n'+
'timestamps                      # updated_at = last saved\n'+
'\n'+
'Unique index: [game_id, naming_beat_id, short_key]</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Edge cases</p>'+
        '<ul>'+
        '<li><strong>Empty beat:</strong> Shows empty message, stats all 0.</li>'+
        '<li><strong>Entries without short key:</strong> Excluded (can\u2019t be identified).</li>'+
        '<li><strong>Deleted source entries:</strong> Orphaned cost entries don\u2019t render (harmless).</li>'+
        '<li><strong>Short key changed in source:</strong> Old cost data orphaned, new key shows as NEW.</li>'+
        '<li><strong>Beat duplication:</strong> Cost data cleared on clone (short keys are cleared, so cost data becomes orphaned).</li>'+
        '<li><strong>Tab switching:</strong> Re-aggregates from latest source data, catching changes made in other tabs.</li>'+
        '</ul>'+

        '<p style="font-weight:600;margin:10px 0 4px">Stats bar</p>'+
        '<p>4 stats: <strong>Entries</strong> (total), <strong>New</strong> (no cost data), <strong>Updated</strong> (source changed), <strong>Complete</strong> (has cost data, source unchanged).</p>'+

        // ─── 6. Short Link Integration ───
        '<h3>6. Short Link Integration (Game-Branded Short Links)</h3>'+
        '<p>TRACKS offers <strong>game-branded short links</strong>. Clients configure a subdomain (e.g. <code>connect.enshrouded.com</code>) that points to the TRACKS infrastructure via DNS. Once DNS is set up, <strong>TRACKS itself is the shortening service</strong> \u2014 no external API call is needed.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">How it works (production)</p>'+
        '<ol>'+
        '<li><strong>DNS prerequisite:</strong> The client adds a CNAME or A record for <code>connect.{gamedomain}</code> pointing to TRACKS. This is a one-time setup per game, managed in game settings.</li>'+
        '<li><strong>Short link creation:</strong> When a user clicks "Get Short Link" in any of the 3 link tabs, the Stimulus controller calls <code>POST /games/:game_id/tools/{tab}_links/:id/shorten</code> on the TRACKS server.</li>'+
        '<li><strong>TRACKS creates the redirect:</strong> The Rails controller calls the shared <code>TrackingShortLinkService</code> which creates a <code>ShortLink</code> record (key + destination URL) scoped to the game\u2019s connect domain, and stores the resulting short URL on the link record.</li>'+
        '<li><strong>Branded redirect:</strong> When someone visits <code>https://connect.enshrouded.com/{short_key}</code>, TRACKS looks up the key, logs the click, and 301-redirects to the full tracking URL with all UTM parameters.</li>'+
        '</ol>'+

        '<p style="font-weight:600;margin:10px 0 4px">Short link URL format</p>'+
        '<pre>https://connect.{game_domain}/{short_key}\n\nExample: https://connect.enshrouded.com/pewdiepie\n  \u2192 301 redirect to https://store.steampowered.com/app/...?campaign_name=ENS-Creator-EN-Launch_260219-YouTube_VOD-PewDiePie&amp;...</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Game settings: connect domain</p>'+
        '<pre>'+
'# On the Game model\n'+
'game.connect_domain  # e.g. "connect.enshrouded.com"\n'+
'game.connect_domain? # true if DNS is configured and verified</pre>'+

        '<div class="warn"><strong>DNS verification:</strong> Before enabling short links for a game, TRACKS should verify that the connect domain resolves to TRACKS infrastructure. If DNS is not configured, the "Get Short Link" button should be disabled with a tooltip explaining the prerequisite.</div>'+

        '<p style="font-weight:600;margin:10px 0 4px">Why it fails in the POC</p>'+
        '<p>The POC tries to call <code>https://connect.{hostname}/shorten</code> directly from the browser. This fails because no shortening service exists at that domain. In the production app, shortening is handled internally by TRACKS \u2014 it\u2019s a server-side <code>POST</code> to the same Rails app, no external API call, no CORS issue.</p>'+

        // ─── 7. Database Schema ───
        '<h3>7. Database Schema</h3>'+
        '<p>This tool creates the shared <code>game_naming_beats</code> table, three link tables (one per tab), three known values tables, one cost entries table, and optionally the shared <code>game_short_links</code> table. <strong>All tables use UUID primary keys</strong> (TRACKS convention).</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Shared: game_naming_beats</p>'+
        '<pre>'+
'create_table :game_naming_beats, id: :uuid do |t|\n'+
'  t.references :game, null: false, foreign_key: true, type: :uuid\n'+
'  t.string  :beat,     null: false\n'+
'  t.integer :position\n'+
'  t.timestamps\n'+
'end\n'+
'add_index :game_naming_beats, [:game_id, :beat], unique: true</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Link tables (one per tab \u2014 structurally similar)</p>'+
        '<table><thead><tr><th style="width:25%">Table</th><th style="width:50%">Tab-specific columns (beyond shared)</th><th style="width:25%">Short key index</th></tr></thead><tbody>'+
        '<tr><td><code>game_influencer_links</code></td><td><code>creator</code>, <code>lang</code>, <code>platform</code>, <code>content_type</code>, <code>persona</code>, <code>publish_date</code></td><td><code>[game_id, short_key]</code> unique</td></tr>'+
        '<tr><td><code>game_media_house_links</code></td><td><code>house</code>, <code>geo</code>, <code>placement</code>, <code>ad_type</code>, <code>strategy</code>, <code>publish_date</code></td><td><code>[game_id, short_key]</code> unique</td></tr>'+
        '<tr><td><code>game_organic_media_links</code></td><td><code>activity</code>, <code>placement</code>, <code>publish_date</code></td><td><code>[game_id, short_key]</code> unique</td></tr>'+
        '</tbody></table>'+
        '<p>All three link tables use <code>id: :uuid</code> and share these columns: <code>game_id</code> (uuid FK), <code>user_id</code> (uuid FK), <code>naming_beat_id</code> (uuid FK to <code>game_naming_beats</code>), <code>dest_url</code>, <code>short_key</code>, <code>generated_url</code>, <code>short_url</code>, <code>position</code>, <code>timestamps</code>.</p>'+
        '<div class="warn"><strong>Short key uniqueness:</strong> Short keys must be unique across ALL three link tables within a game. Options: (a) three separate unique indexes + application-level cross-table validation, or (b) a shared <code>game_tracking_short_keys</code> reservation table with <code>[game_id, short_key]</code> unique index. Option (a) is simpler; option (b) guarantees DB-level uniqueness. The POC uses option (a) with JS-level cross-tab validation.</div>'+

        '<p style="font-weight:600;margin:10px 0 4px">Known values tables (one per tab)</p>'+
        '<p>All three use <code>id: :uuid</code> and have identical structure: <code>game_id</code> (uuid FK), <code>field_key</code>, <code>value</code>, <code>timestamps</code>. Unique index on <code>[game_id, field_key, value]</code>.</p>'+
        '<table><thead><tr><th style="width:35%">Table</th><th>Valid field_key values</th></tr></thead><tbody>'+
        '<tr><td><code>game_influencer_known_values</code></td><td><code>lang</code>, <code>platform</code>, <code>content_type</code>, <code>persona</code></td></tr>'+
        '<tr><td><code>game_media_house_known_values</code></td><td><code>house</code>, <code>geo</code>, <code>placement</code>, <code>ad_type</code>, <code>strategy</code></td></tr>'+
        '<tr><td><code>game_organic_media_known_values</code></td><td><code>activity</code>, <code>placement</code></td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Cost entries table</p>'+
        '<pre>'+
'create_table :game_tracking_cost_entries, id: :uuid do |t|\n'+
'  t.references :game, null: false, foreign_key: true, type: :uuid\n'+
'  t.references :naming_beat, null: false, foreign_key: { to_table: :game_naming_beats }, type: :uuid\n'+
'  t.string  :short_key,   null: false\n'+
'  t.string  :budget\n'+
'  t.date    :end_date\n'+
'  t.integer :duration                  # days\n'+
'  t.string  :handle\n'+
'  t.string  :hashtags\n'+
'  t.text    :notes\n'+
'  t.string  :source_hash               # for change detection\n'+
'  t.timestamps\n'+
'end\n'+
'add_index :game_tracking_cost_entries, [:game_id, :naming_beat_id, :short_key],\n'+
'          unique: true, name: "idx_cost_entries_unique"</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Shared: game_short_links + connect_domain</p>'+
        '<p>Create only if not already present from another tool. <strong>Short links are a separate deliverable</strong> \u2014 implement as a follow-up once the core link tabs are working. Stub the shorten button as disabled until this is built.</p>'+
        '<pre>'+
'# games table addition\n'+
'add_column :games, :connect_domain, :string\n'+
'add_index  :games, :connect_domain, unique: true\n'+
'\n'+
'# short links table\n'+
'create_table :game_short_links, id: :uuid do |t|\n'+
'  t.references :game, null: false, foreign_key: true, type: :uuid\n'+
'  t.string :key,             null: false\n'+
'  t.text   :destination_url, null: false\n'+
'  t.string :source                        # "influencer_link", "media_house_link", etc.\n'+
'  t.timestamps\n'+
'end\n'+
'add_index :game_short_links, [:game_id, :key], unique: true</pre>'+

        // ─── 8. YAML Configs ───
        '<h3>8. YAML Configs (One Per Tab)</h3>'+
        '<p>Each tab has a YAML config defining its campaign pattern and default known values. Place these alongside the model that loads them in <code>app/models/</code> (following the existing <code>app/models/utm_channels.yml</code> pattern).</p>'+
        '<div class="info"><strong>Note:</strong> Unlike <code>UtmChannel</code> (which is entirely YAML-driven with no database), Tracking Links uses YAML only for <strong>default seed values</strong> and <strong>campaign pattern definitions</strong>. The actual known values are stored in the database so users can add custom values per-game. The YAML is read once during seeding and for pattern reference.</div>'+
        '<table><thead><tr><th style="width:35%">File</th><th style="width:40%">campaign_pattern</th><th>utm_medium</th></tr></thead><tbody>'+
        '<tr><td><code>app/models/influencer_link_config.yml</code></td><td><code>{project}-{persona}-{lang}-{beat}_{date}-{platform}_{type}-{creator}</code></td><td><code>"creator"</code></td></tr>'+
        '<tr><td><code>app/models/media_house_link_config.yml</code></td><td><code>{project}-MediaHouse-{strategy}-{geo}_{date}-{placement}_{adType}-{house}</code></td><td><code>"mediahouse"</code></td></tr>'+
        '<tr><td><code>app/models/organic_media_link_config.yml</code></td><td><code>{project}-Organic-{beat}_{date}-{activity}-{placement}</code></td><td><code>"organic"</code></td></tr>'+
        '</tbody></table>'+
        '<p>Each YAML file defines: <code>campaign_pattern</code>, <code>utm_params</code> mapping, <code>fields</code> with <code>default_known_values</code>, <code>date_format: YYMMDD</code>, and <code>validations</code>.</p>'+

        // ─── 9. Models ───
        '<h3>9. Models</h3>'+
        '<p>All <code>Game::*</code> models follow the existing pattern: <code>self.table_name</code>, <code>belongs_to :game, inverse_of:</code>, <code>acts_as_list</code> for sortable records. Each new model requires a corresponding <code>has_many</code> on the <code>Game</code> model.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Additions to Game model (app/models/game.rb)</p>'+
        '<pre>'+
'# Add these has_many associations to the existing Game model:\n'+
'has_many :naming_beats,\n'+
'         class_name: "Game::NamingBeat",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy\n'+
'\n'+
'has_many :influencer_links,\n'+
'         class_name: "Game::InfluencerLink",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy\n'+
'\n'+
'has_many :media_house_links,\n'+
'         class_name: "Game::MediaHouseLink",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy\n'+
'\n'+
'has_many :organic_media_links,\n'+
'         class_name: "Game::OrganicMediaLink",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy\n'+
'\n'+
'has_many :tracking_cost_entries,\n'+
'         class_name: "Game::TrackingCostEntry",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy\n'+
'\n'+
'has_many :short_links,\n'+
'         class_name: "Game::ShortLink",\n'+
'         inverse_of: :game,\n'+
'         dependent:  :destroy</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Game::NamingBeat (shared) \u2014 app/models/game/naming_beat.rb</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class Game::NamingBeat &lt; ApplicationRecord\n'+
'  self.table_name = :game_naming_beats\n'+
'\n'+
'  belongs_to :game, inverse_of: :naming_beats\n'+
'\n'+
'  has_many :influencer_links,\n'+
'           class_name: "Game::InfluencerLink",\n'+
'           inverse_of: :naming_beat,\n'+
'           dependent:  :nullify\n'+
'\n'+
'  has_many :media_house_links,\n'+
'           class_name: "Game::MediaHouseLink",\n'+
'           inverse_of: :naming_beat,\n'+
'           dependent:  :nullify\n'+
'\n'+
'  has_many :organic_media_links,\n'+
'           class_name: "Game::OrganicMediaLink",\n'+
'           inverse_of: :naming_beat,\n'+
'           dependent:  :nullify\n'+
'\n'+
'  has_many :tracking_cost_entries,\n'+
'           class_name: "Game::TrackingCostEntry",\n'+
'           inverse_of: :naming_beat,\n'+
'           dependent:  :destroy\n'+
'\n'+
'  validates :beat, presence:   true,\n'+
'                   uniqueness: { scope: :game_id }\n'+
'\n'+
'  acts_as_list scope: :game_id\n'+
'end</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Link models (all three follow this pattern)</p>'+
        '<p>Showing <code>Game::InfluencerLink</code> as the reference. <code>Game::MediaHouseLink</code> and <code>Game::OrganicMediaLink</code> follow the same structure with their respective fields and service objects.</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class Game::InfluencerLink &lt; ApplicationRecord\n'+
'  self.table_name = :game_influencer_links\n'+
'\n'+
'  belongs_to :game, inverse_of: :influencer_links\n'+
'  belongs_to :user\n'+
'  belongs_to :naming_beat,\n'+
'             class_name: "Game::NamingBeat",\n'+
'             inverse_of: :influencer_links\n'+
'\n'+
'  validates :creator, :lang, :platform, :content_type,\n'+
'            :persona, :publish_date, :short_key, :dest_url,\n'+
'            presence: true\n'+
'\n'+
'  validates :short_key, uniqueness: { scope: :game_id },\n'+
'                        format:     { with: /\\A[a-zA-Z0-9_-]+\\z/ }\n'+
'\n'+
'  before_save :generate_tracking_url\n'+
'\n'+
'  acts_as_list scope: :naming_beat_id\n'+
'\n'+
'  delegate :beat, to: :naming_beat\n'+
'\n'+
'  def campaign_name  = InfluencerLinkService.build_campaign_name(self)\n'+
'  def parent_campaign = InfluencerLinkService.build_parent_campaign(self)\n'+
'\n'+
'  private\n'+
'\n'+
'  def generate_tracking_url\n'+
'    self.generated_url = InfluencerLinkService.build_tracking_url(self)\n'+
'  end\n'+
'end</pre>'+
        '<p><strong>Differences for MH</strong> (<code>self.table_name = :game_media_house_links</code>): Validates <code>:house, :geo, :placement, :ad_type, :strategy</code>. Uses <code>MediaHouseLinkService</code>. <strong>For OM</strong> (<code>self.table_name = :game_organic_media_links</code>): Validates <code>:activity, :placement</code>. Uses <code>OrganicMediaLinkService</code>. OM\u2019s <code>campaign_name</code> has no parent (utm_campaign = campaign_name).</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Game::TrackingCostEntry \u2014 app/models/game/tracking_cost_entry.rb</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class Game::TrackingCostEntry &lt; ApplicationRecord\n'+
'  self.table_name = :game_tracking_cost_entries\n'+
'\n'+
'  belongs_to :game, inverse_of: :tracking_cost_entries\n'+
'  belongs_to :naming_beat,\n'+
'             class_name: "Game::NamingBeat",\n'+
'             inverse_of: :tracking_cost_entries\n'+
'\n'+
'  validates :short_key, presence:   true,\n'+
'                        uniqueness: { scope: [:game_id, :naming_beat_id] }\n'+
'\n'+
'  # Find the source link record across all 3 link tables\n'+
'  def source_link\n'+
'    game.influencer_links.find_by(short_key: short_key, naming_beat: naming_beat) ||\n'+
'      game.media_house_links.find_by(short_key: short_key, naming_beat: naming_beat) ||\n'+
'      game.organic_media_links.find_by(short_key: short_key, naming_beat: naming_beat)\n'+
'  end\n'+
'\n'+
'  def source_changed?\n'+
'    link = source_link\n'+
'    return false unless link &amp;&amp; source_hash.present?\n'+
'\n'+
'    compute_source_hash(link) != source_hash\n'+
'  end\n'+
'\n'+
'  def status\n'+
'    return "new" if [budget, end_date, duration, handle, hashtags, notes].all?(&amp;:blank?)\n'+
'    return "updated" if source_changed?\n'+
'\n'+
'    "complete"\n'+
'  end\n'+
'\n'+
'  def compute_source_hash(link)\n'+
'    attrs = link.attributes.except("id", "created_at", "updated_at",\n'+
'                                   "generated_url", "short_url", "position")\n'+
'    Digest::SHA256.hexdigest(attrs.sort.to_json)\n'+
'  end\n'+
'end</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">Known value models (all three identical structure)</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'# Game::InfluencerKnownValue, Game::MediaHouseKnownValue, Game::OrganicMediaKnownValue\n'+
'# Each sets self.table_name to its game_*_known_values table.\n'+
'class Game::InfluencerKnownValue &lt; ApplicationRecord\n'+
'  self.table_name = :game_influencer_known_values\n'+
'\n'+
'  belongs_to :game, inverse_of: :influencer_known_values\n'+
'\n'+
'  VALID_FIELDS = %w[lang platform content_type persona].freeze\n'+
'\n'+
'  validates :field_key, inclusion: { in: VALID_FIELDS }\n'+
'  validates :value, presence:   true,\n'+
'                    uniqueness: { scope: [:game_id, :field_key] }\n'+
'end\n'+
'# MH: self.table_name = :game_media_house_known_values\n'+
'#     VALID_FIELDS = %w[house geo placement ad_type strategy]\n'+
'# OM: self.table_name = :game_organic_media_known_values\n'+
'#     VALID_FIELDS = %w[activity placement]</pre>'+

        // ─── 10. Services ───
        '<h3>10. Service Objects</h3>'+
        '<p>One link service per tab (campaign name + URL generation), one shared short link service, one cost aggregation service. All in <code>app/services/</code>.</p>'+
        '<div class="info"><strong>Pattern note:</strong> The existing codebase has one service (<code>BlogFeed</code>) using adapter-based dependency injection. The link services are simpler class-method services \u2014 they have no external dependencies, so adapters are unnecessary. If external API calls are added later (e.g., URL validation), consider the adapter pattern then.</div>'+

        '<p style="font-weight:600;margin:10px 0 4px">InfluencerLinkService (reference) \u2014 app/services/influencer_link_service.rb</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class InfluencerLinkService\n'+
'  class &lt;&lt; self\n'+
'    def build_campaign_name(link)\n'+
'      project = link.game.project_code\n'+
'      date    = link.publish_date.strftime("%y%m%d")\n'+
'      beat    = link.beat.gsub(/\\s+/, "")\n'+
'      parent  = "#{project}-#{link.persona}-#{link.lang}-#{beat}_#{date}-#{link.platform}_#{link.content_type}"\n'+
'      "#{parent}-#{link.creator.gsub(/\\s+/, "")}"\n'+
'    end\n'+
'\n'+
'    def build_parent_campaign(link)\n'+
'      # Campaign name without the final -creator suffix\n'+
'      project = link.game.project_code\n'+
'      date    = link.publish_date.strftime("%y%m%d")\n'+
'      beat    = link.beat.gsub(/\\s+/, "")\n'+
'      "#{project}-#{link.persona}-#{link.lang}-#{beat}_#{date}-#{link.platform}_#{link.content_type}"\n'+
'    end\n'+
'\n'+
'    def build_tracking_url(link)\n'+
'      base      = link.dest_url.chomp("/")\n'+
'      connector = base.include?("?") ? "&amp;" : "?"\n'+
'      params    = {\n'+
'        campaign_name: build_campaign_name(link),\n'+
'        ad_group_name: link.creator,\n'+
'        utm_source:    link.creator,\n'+
'        utm_medium:    "creator",\n'+
'        utm_campaign:  build_parent_campaign(link),\n'+
'        utm_content:   link.short_key,\n'+
'      }.to_query\n'+
'      "#{base}#{connector}#{params}"\n'+
'    end\n'+
'  end\n'+
'end</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">MediaHouseLinkService differences</p>'+
        '<pre>'+
'# Campaign name: {project}-MediaHouse-{strategy}-{geo}_{date}-{placement}_{adType}-{house}\n'+
'# utm_medium: "mediahouse"\n'+
'# utm_source: house name\n'+
'# utm_campaign: parent (without -house suffix)\n'+
'# ad_group_name: house name</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">OrganicMediaLinkService differences</p>'+
        '<pre>'+
'# Campaign name: {project}-Organic-{beat}_{date}-{activity}-{placement}\n'+
'# utm_medium: "organic"\n'+
'# utm_source: placement.downcase\n'+
'# utm_campaign: same as campaign_name (no parent/child)\n'+
'# ad_group_name: placement</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">TrackingShortLinkService (shared \u2014 separate deliverable)</p>'+
        '<div class="warn"><strong>Implement after core link tabs are working.</strong> Short links require <code>connect_domain</code> on Game + DNS verification + redirect controller. Stub the shorten button as disabled initially.</div>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class TrackingShortLinkService\n'+
'  Result = Struct.new(:success?, :error, keyword_init: true)\n'+
'\n'+
'  def self.call(link)\n'+
'    game = link.game\n'+
'    return Result.new(success?: false, error: "Connect domain not configured") unless game.connect_domain?\n'+
'    return Result.new(success?: false, error: "No generated URL") if link.generated_url.blank?\n'+
'\n'+
'    short_link = game.short_links.find_or_initialize_by(key: link.short_key)\n'+
'    short_link.destination_url = link.generated_url\n'+
'    short_link.source = link.class.name.demodulize.underscore\n'+
'\n'+
'    if short_link.save\n'+
'      link.update!(short_url: "https://#{game.connect_domain}/#{link.short_key}")\n'+
'      Result.new(success?: true)\n'+
'    else\n'+
'      Result.new(success?: false, error: short_link.errors.full_messages.join(", "))\n'+
'    end\n'+
'  end\n'+
'end</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">TrackingCostAggregationService \u2014 app/services/tracking_cost_aggregation_service.rb</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class TrackingCostAggregationService\n'+
'  Entry = Struct.new(:source, :name, :short_key, :link, :source_hash, keyword_init: true)\n'+
'\n'+
'  def self.aggregate(game, beat)\n'+
'    entries = []\n'+
'\n'+
'    game.influencer_links.where(naming_beat: beat).where.not(short_key: [nil, ""]).find_each do |l|\n'+
'      entries &lt;&lt; Entry.new(source: "Influencer", name: l.creator, short_key: l.short_key,\n'+
'                            link: l, source_hash: compute_hash(l))\n'+
'    end\n'+
'\n'+
'    game.media_house_links.where(naming_beat: beat).where.not(short_key: [nil, ""]).find_each do |l|\n'+
'      entries &lt;&lt; Entry.new(source: "Media House", name: l.house, short_key: l.short_key,\n'+
'                            link: l, source_hash: compute_hash(l))\n'+
'    end\n'+
'\n'+
'    game.organic_media_links.where(naming_beat: beat).where.not(short_key: [nil, ""]).find_each do |l|\n'+
'      entries &lt;&lt; Entry.new(source: "Organic", name: l.activity, short_key: l.short_key,\n'+
'                            link: l, source_hash: compute_hash(l))\n'+
'    end\n'+
'\n'+
'    entries\n'+
'  end\n'+
'\n'+
'  def self.compute_hash(link)\n'+
'    attrs = link.attributes.except("id", "created_at", "updated_at",\n'+
'                                   "generated_url", "short_url", "position")\n'+
'    Digest::SHA256.hexdigest(attrs.sort.to_json)\n'+
'  end\n'+
'end</pre>'+

        // ─── 11. Controllers ───
        '<h3>11. Controllers</h3>'+
        '<p>Each of the 3 link tabs has its own links controller + known values controller. Cost Upload has its own controller. Beat management is shared. All controllers follow the TRACKS pattern: inherit from <code>ApplicationController</code>, include <code>Controller::GameLookup</code>.</p>'+
        '<div class="info"><strong>New to codebase:</strong> These controllers introduce <strong>Turbo Stream responses</strong> (for in-place row updates) and <strong>JSON responses</strong> (for autosave). The existing UTM Links controller only uses full-page renders and redirects. This tool establishes the pattern for Turbo-driven tools.</div>'+

        '<p style="font-weight:600;margin:10px 0 4px">Pattern: all 3 link controllers follow the same structure</p>'+
        '<p>Showing the structure for Influencer. <code>MediaHouseLinksController</code> and <code>OrganicMediaLinksController</code> are structurally identical \u2014 same CRUD + shorten actions, different <code>link_params</code> and service objects.</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class Tools::InfluencerLinksController &lt; ApplicationController\n'+
'  include Controller::GameLookup\n'+
'\n'+
'  before_action :find_game\n'+
'  before_action :reject_demo\n'+
'\n'+
'  # GET /games/:game_id/tools/influencer_links\n'+
'  def index\n'+
'    @beats = @game.naming_beats.order(:position)\n'+
'    @beat  = @game.naming_beats.find(params[:beat_id]) if params[:beat_id]\n'+
'    @links = @beat&amp;.influencer_links&amp;.order(:position) || []\n'+
'    @known_values = @game.influencer_known_values.group_by(&amp;:field_key)\n'+
'  end\n'+
'\n'+
'  # POST /games/:game_id/tools/influencer_links\n'+
'  def create\n'+
'    @link = @game.influencer_links.new(link_params.merge(user: current_user))\n'+
'    if @link.save\n'+
'      respond_to do |f|\n'+
'        f.turbo_stream\n'+
'        f.html { redirect_to action: :index, beat_id: @link.naming_beat_id }\n'+
'      end\n'+
'    else\n'+
'      head :unprocessable_entity\n'+
'    end\n'+
'  end\n'+
'\n'+
'  # PATCH /games/:game_id/tools/influencer_links/:id\n'+
'  def update\n'+
'    @link = @game.influencer_links.find(params[:id])\n'+
'    if @link.update(link_params)\n'+
'      respond_to do |f|\n'+
'        f.turbo_stream\n'+
'        f.html { redirect_to action: :index, beat_id: @link.naming_beat_id }\n'+
'      end\n'+
'    else\n'+
'      head :unprocessable_entity\n'+
'    end\n'+
'  end\n'+
'\n'+
'  # DELETE /games/:game_id/tools/influencer_links/:id\n'+
'  def destroy\n'+
'    @link = @game.influencer_links.find(params[:id])\n'+
'    @link.destroy\n'+
'    respond_to do |f|\n'+
'      f.turbo_stream\n'+
'      f.html { redirect_to action: :index, beat_id: @link.naming_beat_id }\n'+
'    end\n'+
'  end\n'+
'\n'+
'  # POST /games/:game_id/tools/influencer_links/:id/shorten\n'+
'  def shorten\n'+
'    @link = @game.influencer_links.find(params[:id])\n'+
'    result = TrackingShortLinkService.call(@link)\n'+
'    respond_to do |f|\n'+
'      f.turbo_stream\n'+
'    end\n'+
'  end\n'+
'\n'+
'  private\n'+
'\n'+
'  def link_params\n'+
'    params.require(:game_influencer_link).permit(\n'+
'      :naming_beat_id, :creator, :lang, :platform, :content_type,\n'+
'      :persona, :publish_date, :short_key, :dest_url,\n'+
'    )\n'+
'  end\n'+
'end</pre>'+

        '<p style="font-weight:600;margin:10px 0 4px">TrackingCostEntriesController</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class Tools::TrackingCostEntriesController &lt; ApplicationController\n'+
'  include Controller::GameLookup\n'+
'\n'+
'  before_action :find_game\n'+
'  before_action :reject_demo\n'+
'\n'+
'  # GET /games/:game_id/tools/tracking_cost_entries?beat_id=X\n'+
'  def index\n'+
'    @beats = @game.naming_beats.order(:position)\n'+
'    @beat  = @game.naming_beats.find(params[:beat_id]) if params[:beat_id]\n'+
'    if @beat\n'+
'      @entries   = TrackingCostAggregationService.aggregate(@game, @beat)\n'+
'      @cost_data = @game.tracking_cost_entries\n'+
'                        .where(naming_beat: @beat)\n'+
'                        .index_by(&amp;:short_key)\n'+
'    end\n'+
'  end\n'+
'\n'+
'  # POST /games/:game_id/tools/tracking_cost_entries (upsert by short_key + beat)\n'+
'  def create\n'+
'    @entry = @game.tracking_cost_entries.find_or_initialize_by(\n'+
'      naming_beat_id: params[:naming_beat_id],\n'+
'      short_key:      params[:short_key],\n'+
'    )\n'+
'    @entry.assign_attributes(cost_params)\n'+
'    link = @entry.source_link\n'+
'    @entry.source_hash = @entry.compute_source_hash(link) if link\n'+
'\n'+
'    if @entry.save\n'+
'      respond_to { |f| f.turbo_stream }\n'+
'    else\n'+
'      head :unprocessable_entity\n'+
'    end\n'+
'  end\n'+
'\n'+
'  # PATCH /games/:game_id/tools/tracking_cost_entries/:id\n'+
'  def update\n'+
'    @entry = @game.tracking_cost_entries.find(params[:id])\n'+
'    if @entry.update(cost_params)\n'+
'      link = @entry.source_link\n'+
'      @entry.update_column(:source_hash, @entry.compute_source_hash(link)) if link\n'+
'      respond_to { |f| f.turbo_stream }\n'+
'    else\n'+
'      head :unprocessable_entity\n'+
'    end\n'+
'  end\n'+
'\n'+
'  def download_csv\n'+
'    @beat   = @game.naming_beats.find(params[:beat_id])\n'+
'    entries = TrackingCostAggregationService.aggregate(@game, @beat)\n'+
'    cost_data = @game.tracking_cost_entries.where(naming_beat: @beat).index_by(&amp;:short_key)\n'+
'    send_data csv_content(entries, cost_data),\n'+
'              filename: "cost_upload_#{@beat.beat}_#{Date.today}.csv"\n'+
'  end\n'+
'\n'+
'  private\n'+
'\n'+
'  def cost_params\n'+
'    params.require(:tracking_cost_entry).permit(\n'+
'      :budget, :end_date, :duration, :handle, :hashtags, :notes,\n'+
'    )\n'+
'  end\n'+
'end</pre>'+

        // ─── 12. Routes ───
        '<h3>12. Routes</h3>'+
        '<p>Add inside the existing <code>resources :games</code> block, under <code>namespace :tools</code> (alongside <code>utm_links</code>):</p>'+
        '<pre>'+
'# config/routes.rb \u2014 inside the existing resources :games block\n'+
'resources :games, only: %i[new create show edit update] do\n'+
'  # ... existing routes ...\n'+
'\n'+
'  get "tools", to: "tools#index", as: :tools\n'+
'  namespace :tools do\n'+
'    resources :utm_links, only: %i[index create destroy]  # existing\n'+
'\n'+
'    # Tracking Links \u2014 Influencer tab\n'+
'    resources :influencer_links, only: %i[index create update destroy] do\n'+
'      member { post :shorten }\n'+
'    end\n'+
'    resources :influencer_known_values, only: %i[create destroy]\n'+
'\n'+
'    # Tracking Links \u2014 Media Houses tab\n'+
'    resources :media_house_links, only: %i[index create update destroy] do\n'+
'      member { post :shorten }\n'+
'    end\n'+
'    resources :media_house_known_values, only: %i[create destroy]\n'+
'\n'+
'    # Tracking Links \u2014 Organic Media tab\n'+
'    resources :organic_media_links, only: %i[index create update destroy] do\n'+
'      member { post :shorten }\n'+
'    end\n'+
'    resources :organic_media_known_values, only: %i[create destroy]\n'+
'\n'+
'    # Tracking Links \u2014 Cost Upload tab\n'+
'    resources :tracking_cost_entries, only: %i[index create update] do\n'+
'      collection { get :download_csv }\n'+
'    end\n'+
'\n'+
'    # Shared beat management\n'+
'    resources :naming_beats, only: %i[create destroy] do\n'+
'      member { post :duplicate }\n'+
'    end\n'+
'  end\n'+
'end\n'+
'\n'+
'# Short link redirect (separate deliverable \u2014 add when connect_domain is implemented)\n'+
'# constraints -&gt;(req) { Game.exists?(connect_domain: req.host) } do\n'+
'#   get "/:key", to: "short_links#show"\n'+
'# end</pre>'+

        // ─── 13. Short Link Service ───
        '<h3>13. Short Link Service &amp; Redirect Controller</h3>'+
        '<div class="warn"><strong>Separate deliverable.</strong> Short links (connect domain, DNS verification, redirect controller, click logging) should be implemented as a follow-up after the core link tabs are working. Stub the "Get Short Link" button as disabled until this is built. The service code in section 10 is ready to be wired in when this deliverable is started.</div>'+
        '<p>When implemented, the <code>ShortLinksController</code> handles branded redirects. Note: TRACKS uses custom JWT auth (not Devise), so the skip is for the <code>authenticate</code> method from <code>ApplicationController</code>:</p>'+
        '<pre>'+
'# frozen_string_literal: true\n'+
'\n'+
'class ShortLinksController &lt; ApplicationController\n'+
'  skip_before_action :authenticate\n'+
'\n'+
'  def show\n'+
'    game = Game.find_by!(connect_domain: request.host)\n'+
'    short_link = game.short_links.find_by!(key: params[:key])\n'+
'    # Optional: log click for analytics\n'+
'    redirect_to short_link.destination_url, status: :moved_permanently, allow_other_host: true\n'+
'  end\n'+
'end</pre>'+
        '<p>The <code>Game::ShortLink</code> model (<code>self.table_name = :game_short_links</code>) validates <code>key</code> uniqueness scoped to <code>game_id</code>, format <code>/\\A[a-zA-Z0-9_-]+\\z/</code>, and presence of <code>destination_url</code>.</p>'+

        // ─── 14. Stimulus Controllers ───
        '<h3>14. Stimulus Controllers</h3>'+
        '<div class="warn"><strong>Complexity note:</strong> The existing TRACKS codebase has only 4 simple Stimulus controllers (<code>clipboard</code>, <code>collapse</code>, <code>dropdown</code>, <code>hello</code>). This tool introduces significantly more complex controllers with debounced autosave, <code>AbortController</code> per row, real-time link preview, and stats management. This is a <strong>major step up</strong> in frontend complexity for the codebase. Consider building incrementally: start with basic CRUD (full-page reloads), then layer in Turbo Streams, then autosave.</div>'+
        '<p>All controllers go in <code>app/javascript/controllers/</code> and are auto-registered via <code>app/javascript/controllers/index.js</code>. The existing <code>clipboard_controller.js</code> can be reused for "Copy All Links" functionality.</p>'+
        '<table><thead><tr><th style="width:45%">Controller</th><th>Purpose</th></tr></thead><tbody>'+
        '<tr><td><code>tracking_link_controller.js</code></td><td>Shared across all 3 link tabs: debounced autosave per row (800ms), <code>AbortController</code> per row to cancel in-flight saves, real-time link preview on field change, stats counter update, short key duplicate detection.</td></tr>'+
        '<tr><td><code>tracking_shorten_controller.js</code></td><td>Shared per-row shorten button: loading spinner, success (show short URL), error (show retry). State machine: idle \u2192 loading \u2192 success|error.</td></tr>'+
        '<tr><td><code>tracking_cost_controller.js</code></td><td>Cost Upload tab: debounced upsert on field change, in-place badge + timestamp refresh (no full re-render), stats update, CSV download trigger.</td></tr>'+
        '</tbody></table>'+
        '<p><strong>Recommended incremental approach:</strong></p>'+
        '<ol>'+
        '<li><strong>Phase 1:</strong> Basic CRUD with full-page reloads (like existing UTM Links). Validate all data flows work.</li>'+
        '<li><strong>Phase 2:</strong> Add Turbo Stream responses for in-place row add/remove/update. Replace redirects with turbo_stream responses.</li>'+
        '<li><strong>Phase 3:</strong> Add <code>tracking_link_controller.js</code> for debounced autosave + real-time link preview. Add <code>tracking_shorten_controller.js</code>.</li>'+
        '<li><strong>Phase 4:</strong> Add <code>tracking_cost_controller.js</code> for cost tab interactivity.</li>'+
        '</ol>'+

        // ─── 15. Views ───
        '<h3>15. Views</h3>'+
        '<p>Views follow the existing TRACKS patterns. Use Tabler CSS components and the established layout helpers:</p>'+
        '<pre>'+
'# Standard view setup (same as UTM Links):\n'+
'&lt;% content_for :pretitle do %&gt;\n'+
'  &lt;%= link_to @game.name, game_path(@game) %&gt; /\n'+
'  &lt;%= link_to t("games.tools"), game_tools_path(@game) %&gt;\n'+
'&lt;% end %&gt;\n'+
'&lt;% content_for :title, t("tools.influencer_links.title") %&gt;\n'+
'&lt;% content_for :image_title, "..." %&gt;\n'+
'&lt;% content_for :image_subtitle, "..." %&gt;\n'+
'&lt;%= render "games/title_actions" %&gt;\n'+
'&lt;%= render "games/subpage_wrapper" do %&gt;\n'+
'  &lt;!-- tool content here --&gt;\n'+
'&lt;% end %&gt;</pre>'+
        '<p><strong>Tabler components used:</strong> <code>.card</code>, <code>.card-header</code>, <code>.card-body</code>, <code>.table .table-vcenter</code>, <code>.badge .bg-green-lt</code> / <code>.bg-yellow-lt</code> / <code>.bg-azure-lt</code>, <code>.btn .btn-primary .btn-sm</code>, <code>.form-control</code>, <code>.row .col</code>, <code>data-bs-toggle="tooltip"</code>. Icons via <code>&lt;%= i :icon_name %&gt;</code>.</p>'+

        '<p style="font-weight:600;margin:10px 0 4px">Per link tab (Influencer shown, MH/OM identical structure)</p>'+
        '<table><thead><tr><th style="width:45%">File</th><th>Purpose</th></tr></thead><tbody>'+
        '<tr><td><code>tools/influencer_links/index.html.erb</code></td><td>Main tab page: beat selector + beat cards + stats bar + table + field values + bulk actions</td></tr>'+
        '<tr><td><code>tools/influencer_links/_link_row.html.erb</code></td><td>Single table row partial with inputs + link preview + shorten button. Wrapped in <code>&lt;turbo-frame&gt;</code> for in-place updates.</td></tr>'+
        '<tr><td><code>tools/influencer_links/_beat_cards.html.erb</code></td><td>Beat management: dropdown + "New Beat" input + beat card grid</td></tr>'+
        '<tr><td><code>tools/influencer_links/_field_values.html.erb</code></td><td>Collapsible inline field values with add/remove tags (uses existing <code>collapse_controller</code>)</td></tr>'+
        '<tr><td><code>tools/influencer_links/create.turbo_stream.erb</code></td><td>Append new row to table</td></tr>'+
        '<tr><td><code>tools/influencer_links/update.turbo_stream.erb</code></td><td>Replace row in-place (preserves focus via Stimulus)</td></tr>'+
        '<tr><td><code>tools/influencer_links/destroy.turbo_stream.erb</code></td><td>Remove row + update stats</td></tr>'+
        '<tr><td><code>tools/influencer_links/shorten.turbo_stream.erb</code></td><td>Replace short link cell with result</td></tr>'+
        '</tbody></table>'+

        '<p style="font-weight:600;margin:10px 0 4px">Cost Upload tab views</p>'+
        '<table><thead><tr><th style="width:45%">File</th><th>Purpose</th></tr></thead><tbody>'+
        '<tr><td><code>tools/tracking_cost_entries/index.html.erb</code></td><td>Beat dropdown (no create), stats bar (total/new/updated/complete), 11-column table, CSV download button, info callout</td></tr>'+
        '<tr><td><code>tools/tracking_cost_entries/_cost_row.html.erb</code></td><td>Single row: 4 read-only source cells + 6 editable cost inputs + updated timestamp</td></tr>'+
        '<tr><td><code>tools/tracking_cost_entries/update.turbo_stream.erb</code></td><td>In-place update of badge + timestamp (no full re-render to preserve focus)</td></tr>'+
        '</tbody></table>'+

        // ─── 16. Autosave ───
        '<h3>16. Autosave Strategy</h3>'+
        '<div class="info"><strong>New pattern for TRACKS.</strong> The existing codebase has no autosave. This tool introduces debounced PATCH requests as a new convention. Implement this in Phase 3 (after basic CRUD works with full-page reloads).</div>'+
        '<p><strong>Link tabs:</strong> Debounced PATCH per row (800ms). Each row is independent. <code>AbortController</code> per row cancels in-flight requests. Client-side link preview updates instantly; server-side <code>generated_url</code> computed in <code>before_save</code>. Use <code>fetch</code> with <code>Accept: text/vnd.turbo-stream.html</code> header for Turbo Stream responses.</p>'+
        '<p><strong>Cost Upload:</strong> Debounced upsert (POST/PATCH) per cost entry on field change. Uses <code>[naming_beat_id, short_key]</code> to find-or-create. Updates <code>source_hash</code> on save. Badge and timestamp updated in-place via Turbo Stream (no full table re-render to preserve input focus).</p>'+
        '<p><strong>Error handling:</strong> On save failure, show a subtle inline error indicator (red border on the row). Do not block the user from continuing to edit. Retry on next field change.</p>'+

        // ─── 17. I18n ───
        '<h3>17. I18n Strings</h3>'+
        '<p>TRACKS currently uses a single <code>config/locales/en.yml</code> file. The existing <code>tools.utm_links.*</code> namespace shows the pattern. Add new namespaces for each tab under <code>en.tools</code>:</p>'+
        '<table><thead><tr><th style="width:35%">Namespace</th><th>Keys</th></tr></thead><tbody>'+
        '<tr><td><code>en.tools.influencer_links.*</code></td><td>title, subtitle, column headers, field labels, stats labels, shorten button states, error messages, bulk action labels</td></tr>'+
        '<tr><td><code>en.tools.media_house_links.*</code></td><td>Same structure as influencer (different labels)</td></tr>'+
        '<tr><td><code>en.tools.organic_media_links.*</code></td><td>Same structure (fewer fields)</td></tr>'+
        '<tr><td><code>en.tools.tracking_cost_entries.*</code></td><td>title, subtitle, status badge labels (new/updated/complete), cost field labels, stats labels, callout text, CSV button</td></tr>'+
        '<tr><td><code>en.tools.naming_beats.*</code></td><td>Shared beat management labels: add, select, duplicate, delete, confirmation messages</td></tr>'+
        '</tbody></table>'+
        '<p>If the single <code>en.yml</code> file becomes unwieldy, it can be split into separate files under <code>config/locales/en/</code> \u2014 Rails auto-loads all YAML files in the locales directory tree. But start with the single file to match the existing convention.</p>'+

        // ─── 18. File Map ───
        '<h3>18. Complete File Map</h3>'+
        '<p>Organized by layer with <strong>full paths</strong> relative to Rails root. <em>\u00d73</em> means one file per link tab (Influencer, MH, OM). Files marked <em>(later)</em> are part of the short links deliverable.</p>'+
        '<table><thead><tr><th style="width:58%">File</th><th>Purpose</th></tr></thead><tbody>'+
        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Migrations (db/migrate/)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_naming_beats.rb</code></td><td>Shared beats table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_influencer_links.rb</code></td><td>Influencer links table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_media_house_links.rb</code></td><td>MH links table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_organic_media_links.rb</code></td><td>OM links table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_influencer_known_values.rb</code></td><td>Influencer known values (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_media_house_known_values.rb</code></td><td>MH known values (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_organic_media_known_values.rb</code></td><td>OM known values (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_tracking_cost_entries.rb</code></td><td>Cost entries table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_create_game_short_links.rb</code> <em>(later)</em></td><td>Shared short links table (id: :uuid)</td></tr>'+
        '<tr><td><code>YYYYMMDD_add_connect_domain_to_games.rb</code> <em>(later)</em></td><td>Connect domain on games</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Models (app/models/game/)</td></tr>'+
        '<tr><td><code>app/models/game/naming_beat.rb</code></td><td>Shared beat model</td></tr>'+
        '<tr><td><code>app/models/game/influencer_link.rb</code></td><td>Influencer link model</td></tr>'+
        '<tr><td><code>app/models/game/media_house_link.rb</code></td><td>MH link model</td></tr>'+
        '<tr><td><code>app/models/game/organic_media_link.rb</code></td><td>OM link model</td></tr>'+
        '<tr><td><code>app/models/game/influencer_known_value.rb</code></td><td>Influencer custom values</td></tr>'+
        '<tr><td><code>app/models/game/media_house_known_value.rb</code></td><td>MH custom values</td></tr>'+
        '<tr><td><code>app/models/game/organic_media_known_value.rb</code></td><td>OM custom values</td></tr>'+
        '<tr><td><code>app/models/game/tracking_cost_entry.rb</code></td><td>Cost entry model</td></tr>'+
        '<tr><td><code>app/models/game/short_link.rb</code> <em>(later)</em></td><td>Shared short link model</td></tr>'+
        '<tr><td><code>app/models/game.rb</code> <em>(modify)</em></td><td>Add has_many associations for all new models</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">YAML Configs (app/models/)</td></tr>'+
        '<tr><td><code>app/models/influencer_link_config.yml</code></td><td>Influencer campaign pattern + default known values</td></tr>'+
        '<tr><td><code>app/models/media_house_link_config.yml</code></td><td>MH campaign pattern + default known values</td></tr>'+
        '<tr><td><code>app/models/organic_media_link_config.yml</code></td><td>OM campaign pattern + default known values</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Services (app/services/)</td></tr>'+
        '<tr><td><code>app/services/influencer_link_service.rb</code></td><td>Influencer campaign name + URL generation</td></tr>'+
        '<tr><td><code>app/services/media_house_link_service.rb</code></td><td>MH campaign name + URL generation</td></tr>'+
        '<tr><td><code>app/services/organic_media_link_service.rb</code></td><td>OM campaign name + URL generation</td></tr>'+
        '<tr><td><code>app/services/tracking_short_link_service.rb</code> <em>(later)</em></td><td>Shared: creates ShortLink for any link type</td></tr>'+
        '<tr><td><code>app/services/tracking_cost_aggregation_service.rb</code></td><td>Aggregates entries from all 3 link tables</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Controllers (app/controllers/)</td></tr>'+
        '<tr><td><code>app/controllers/tools/influencer_links_controller.rb</code></td><td>CRUD + shorten</td></tr>'+
        '<tr><td><code>app/controllers/tools/media_house_links_controller.rb</code></td><td>CRUD + shorten</td></tr>'+
        '<tr><td><code>app/controllers/tools/organic_media_links_controller.rb</code></td><td>CRUD + shorten</td></tr>'+
        '<tr><td><code>app/controllers/tools/influencer_known_values_controller.rb</code></td><td>Custom values create/destroy</td></tr>'+
        '<tr><td><code>app/controllers/tools/media_house_known_values_controller.rb</code></td><td>Custom values create/destroy</td></tr>'+
        '<tr><td><code>app/controllers/tools/organic_media_known_values_controller.rb</code></td><td>Custom values create/destroy</td></tr>'+
        '<tr><td><code>app/controllers/tools/tracking_cost_entries_controller.rb</code></td><td>Cost tab: index, create/update, CSV download</td></tr>'+
        '<tr><td><code>app/controllers/tools/naming_beats_controller.rb</code></td><td>Shared beat management: create, destroy, duplicate</td></tr>'+
        '<tr><td><code>app/controllers/short_links_controller.rb</code> <em>(later)</em></td><td>Branded short link redirect</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Views (app/views/tools/)</td></tr>'+
        '<tr><td><code>tools/{tab}_links/index.html.erb</code> (\u00d73)</td><td>Main tab page</td></tr>'+
        '<tr><td><code>tools/{tab}_links/_link_row.html.erb</code> (\u00d73)</td><td>Row partial (turbo-frame wrapped)</td></tr>'+
        '<tr><td><code>tools/{tab}_links/_beat_cards.html.erb</code> (\u00d73)</td><td>Beat management partial</td></tr>'+
        '<tr><td><code>tools/{tab}_links/_field_values.html.erb</code> (\u00d73)</td><td>Field values partial</td></tr>'+
        '<tr><td><code>tools/{tab}_links/*.turbo_stream.erb</code> (\u00d73)</td><td>CRUD + shorten Turbo Streams</td></tr>'+
        '<tr><td><code>tools/tracking_cost_entries/index.html.erb</code></td><td>Cost tab main page</td></tr>'+
        '<tr><td><code>tools/tracking_cost_entries/_cost_row.html.erb</code></td><td>Cost row partial</td></tr>'+
        '<tr><td><code>tools/tracking_cost_entries/update.turbo_stream.erb</code></td><td>In-place badge + timestamp update</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Stimulus (app/javascript/controllers/)</td></tr>'+
        '<tr><td><code>tracking_link_controller.js</code></td><td>Shared: debounced autosave, link preview, stats, short key validation</td></tr>'+
        '<tr><td><code>tracking_shorten_controller.js</code></td><td>Shared shorten button state machine</td></tr>'+
        '<tr><td><code>tracking_cost_controller.js</code></td><td>Cost tab: debounced save, badges, stats</td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">I18n</td></tr>'+
        '<tr><td><code>config/locales/en.yml</code> <em>(modify)</em></td><td>Add <code>en.tools.influencer_links.*</code>, <code>media_house_links.*</code>, <code>organic_media_links.*</code>, <code>tracking_cost_entries.*</code>, <code>naming_beats.*</code></td></tr>'+

        '<tr><td colspan="2" style="background:#f1f5f9;font-weight:700;color:var(--primary)">Specs</td></tr>'+
        '<tr><td><code>spec/models/game/*_spec.rb</code></td><td>Unit specs for all new models (1 per model)</td></tr>'+
        '<tr><td><code>spec/services/*_spec.rb</code></td><td>Unit specs for all services (campaign name assembly is critical)</td></tr>'+
        '<tr><td><code>spec/features/games/influencer_links_spec.rb</code></td><td>Feature spec: full Influencer tab flow</td></tr>'+
        '<tr><td><code>spec/features/games/media_house_links_spec.rb</code></td><td>Feature spec: MH tab flow</td></tr>'+
        '<tr><td><code>spec/features/games/organic_media_links_spec.rb</code></td><td>Feature spec: OM tab flow</td></tr>'+
        '<tr><td><code>spec/features/games/tracking_cost_entries_spec.rb</code></td><td>Feature spec: Cost Upload flow</td></tr>'+
        '<tr><td><code>spec/features/games/naming_beats_spec.rb</code></td><td>Feature spec: Beat management</td></tr>'+
        '</tbody></table>'+

        // ─── 19. Implementation Order ───
        '<h3>19. Implementation Order</h3>'+
        '<p>Ordered for incremental, testable progress. Each step should be deployable independently.</p>'+
        '<ol>'+
        '<li><strong>Prerequisite: Project code on Game model</strong> \u2014 Must already be implemented. All campaign name patterns depend on <code>game.project_code</code>.</li>'+
        '<li><strong>Shared foundation: NamingBeat + Game associations</strong> \u2014 Create <code>game_naming_beats</code> migration (UUID PK) + <code>Game::NamingBeat</code> model. Add <code>has_many</code> associations to <code>Game</code> model. Add routes for <code>naming_beats</code>. Add <code>Tools::NamingBeatsController</code> (create, destroy, duplicate). Write model specs + feature spec for beat CRUD.</li>'+
        '<li><strong>Influencer tab (Phase 1: basic CRUD)</strong> \u2014 Migration (UUID PK), model, known values model + seed data, YAML config, <code>InfluencerLinkService</code>, controller (full-page renders first, no Turbo Streams yet), routes, views (Tabler table with form inputs), I18n strings. Write service specs (campaign name assembly must match POC exactly) + feature spec. <strong>This is the reference implementation.</strong></li>'+
        '<li><strong>Influencer tab (Phase 2: Turbo Streams)</strong> \u2014 Add Turbo Stream responses to create/update/destroy. Wrap rows in <code>&lt;turbo-frame&gt;</code>. Replace redirects with turbo_stream format. Known values create/destroy via Turbo Stream (append/remove <code>&lt;option&gt;</code> tags).</li>'+
        '<li><strong>Influencer tab (Phase 3: Stimulus)</strong> \u2014 Add <code>tracking_link_controller.js</code> (debounced autosave, link preview, stats, short key duplicate detection). This establishes the Stimulus pattern for all tabs.</li>'+
        '<li><strong>Media Houses tab</strong> \u2014 Follow the Influencer pattern. Migration, model, known values, YAML config (MH campaign pattern + UTM mapping), service, controller, views. Reuse <code>tracking_link_controller.js</code> (Stimulus targets differ per tab). Spec MH-specific campaign name assembly.</li>'+
        '<li><strong>Organic Media tab</strong> \u2014 Follow the Influencer pattern. Note OM differences: fewer fields, <code>utm_campaign = campaign_name</code> (no parent), <code>utm_source = placement.downcase</code>. Spec accordingly.</li>'+
        '<li><strong>Cross-tab short key validation</strong> \u2014 Add application-level validation that checks short_key uniqueness across all 3 link tables within the game. Add Stimulus-level real-time duplicate highlighting (same as POC behavior).</li>'+
        '<li><strong>Cost Upload tab</strong> \u2014 Create <code>game_tracking_cost_entries</code> migration + model. Create <code>TrackingCostAggregationService</code>. Controller (index, create/update upsert, CSV download). Views (beat dropdown only, 11-column table, stats bar). <code>tracking_cost_controller.js</code> (debounced save, in-place badge/timestamp refresh). Spec status logic + aggregation.</li>'+
        '<li><strong>Navigation + I18n</strong> \u2014 Add Tracking Links to tools index page (alongside UTM Links). Add all I18n strings to <code>config/locales/en.yml</code>.</li>'+
        '<li><strong>Short links (separate deliverable)</strong> \u2014 Add <code>connect_domain</code> to games. Create <code>game_short_links</code> table + model. Create <code>TrackingShortLinkService</code>. Create <code>ShortLinksController</code> + redirect route. Add <code>tracking_shorten_controller.js</code>. Wire shorten action into all 3 link controllers. Add DNS verification to game settings. Enable the previously-stubbed "Get Short Link" buttons.</li>'+
        '</ol>'+

        '<div class="warn"><strong>Testing strategy (matching TRACKS conventions):</strong><br>'+
        '\u2022 <strong>Every code file gets a corresponding spec file</strong> \u2014 this is a TRACKS requirement.<br>'+
        '\u2022 <strong>Unit specs</strong> (mock-based): All 3 link services (campaign name assembly must match POC exactly), <code>TrackingCostAggregationService</code> (correct aggregation), <code>TrackingCostEntry#status</code> (NEW/UPDATED/COMPLETE logic), all models (validations, associations).<br>'+
        '\u2022 <strong>Feature specs</strong> (<code>spec/features/</code>): Full flow per tab \u2014 add beat, add row, fill fields, verify link preview, copy link, download CSV. Cost Upload: select beat, verify aggregation, edit cost fields, verify badges. Beat management: create, duplicate, delete.<br>'+
        '\u2022 <strong>Max 1 expectation per example</strong> \u2014 use <code>:aggregate_failures</code> or compound matchers (<code>have_attributes</code>, <code>.and</code>).<br>'+
        '\u2022 <strong>Test data</strong>: Use fixtures (not FactoryBot) following the existing pattern.</div>'
    );
}

// ==================== PREREQUISITE ====================
function buildPrereq(){
    const root = document.getElementById('mode-prereq');
    if(root.children.length > 0) return;

    function card(html){
        const c = document.createElement('div');
        c.className = 'card dg';
        c.innerHTML = html;
        root.appendChild(c);
    }

    card(
        '<h2>Prerequisite \u2014 Project Code on Game Model</h2>'+
        '<p>The <code>project_code</code> field on the <code>Game</code> model <strong>must already exist</strong> before implementing Tracking Links. All three campaign name patterns begin with the project code (e.g. <code>ENS-Creator-EN-Launch_...</code>, <code>ENS-MediaHouse-Awareness-DE_...</code>, <code>ENS-Organic-Launch_...</code>). This is implemented as a standalone feature prior to Tracking Links.</p>'+

        '<h3>What it is</h3>'+
        '<p>A short, uppercase alphanumeric code (typically 2\u20134 characters) that uniquely identifies a game within the organization. Examples: <code>ENS</code> (Enshrouded), <code>SWB</code> (Snowbreak), <code>DSL</code> (Dusklight). It serves as the first segment in every campaign name across all tools (Tracking Links, Naming Conventions).</p>'+

        '<h3>Implementation</h3>'+
        '<table><thead><tr><th style="width:25%">Aspect</th><th>Detail</th></tr></thead><tbody>'+
        '<tr><td><strong>Migration</strong></td><td><code>add_column :games, :project_code, :string, limit: 10</code> \u2014 nullable initially for backfill. Add unique index: <code>[:project_code]</code>.</td></tr>'+
        '<tr><td><strong>Validation</strong></td><td>Presence, uniqueness (case-insensitive), format: <code>/\\A[A-Z0-9]{2,10}\\z/</code>. Uppercase only, no spaces or special characters.</td></tr>'+
        '<tr><td><strong>UI (users)</strong></td><td>Add to game settings form (<code>games#edit</code>). Show as a short text field with a hint: "2\u201310 character code used in campaign names (e.g. ENS)". Read-only in Tracking Links views \u2014 users set it once in game settings.</td></tr>'+
        '<tr><td><strong>Avo Admin</strong></td><td>Add <code>project_code</code> as an <strong>editable text field</strong> in the Avo Game resource (<code>app/avo/resources/game.rb</code>). Place it after <code>:name</code> in the <code>fields</code> method. This is <strong>critical for backfill</strong>: admins may need to replace auto-generated or incorrect codes on existing games. The field should be editable on both show and edit views (not disabled).</td></tr>'+
        '<tr><td><strong>Backfill</strong></td><td>Existing games need a project code before Tracking Links can be used. Either: (a) require it on next game edit, or (b) auto-generate from the first 3 letters of the game name (uppercase) and let admins correct via Avo.</td></tr>'+
        '<tr><td><strong>Access</strong></td><td><code>game.project_code</code> \u2014 used by all link services: <code>link.game.project_code</code>. Tracking Links tab should show a clear message if project code is not yet set, with a link to game settings.</td></tr>'+
        '</tbody></table>'+

        '<h3>Verification</h3>'+
        '<ol>'+
        '<li>Game settings form shows project code field with validation</li>'+
        '<li>Existing games can have project code added</li>'+
        '<li><code>Game.find(id).project_code</code> returns the code (e.g. <code>"ENS"</code>)</li>'+
        '<li>Uniqueness is enforced \u2014 two games cannot share the same code</li>'+
        '<li>Avo admin interface shows project code as an editable field on Game resource</li>'+
        '<li>Admin can change a backfilled project code via Avo and it saves correctly</li>'+
        '<li>Tracking Links tools check for presence and show a helpful message if missing</li>'+
        '</ol>'
    );

    card(
        '<h2>Claude Code Implementation Prompt</h2>'+
        '<p>Copy and use this prompt to implement the project_code feature:</p>'+
        '<pre style="white-space:pre-wrap;font-size:.78rem;background:#1a1a2e;color:#e2e8f0;padding:16px;border-radius:6px;line-height:1.5">'+
'Add a `project_code` field to the Game model in the TRACKS Rails app.\n'+
'\n'+
'## What it is\n'+
'\n'+
'A short uppercase alphanumeric code (2\u201310 characters) that uniquely identifies a game\n'+
'within the organization. Examples: ENS (Enshrouded), SWB (Snowbreak). It is used as\n'+
'the first segment in campaign names across Tracking Links and Naming Convention tools\n'+
'(e.g. ENS-Creator-EN-Launch_260219-YouTube_VOD-PewDiePie).\n'+
'\n'+
'## Requirements\n'+
'\n'+
'### 1. Migration\n'+
'- Add `project_code` column to the `games` table: `string, limit: 10`\n'+
'- Make it nullable (existing games don\u2019t have one yet)\n'+
'- Add a unique index on `project_code` (case-insensitive uniqueness is handled at\n'+
'  the model level, but the DB index ensures data integrity)\n'+
'- TRACKS uses SQL schema format (`db/structure.sql`), so run `rails db:migrate`\n'+
'  as normal and the structure file will update automatically\n'+
'\n'+
'### 2. Model changes (`app/models/game.rb`)\n'+
'- Add validation: `validates :project_code, uniqueness: { case_sensitive: false },\n'+
'  format: { with: /\\A[A-Z0-9]{2,10}\\z/, message: "must be 2\u201310 uppercase letters\n'+
'  or digits" }, allow_blank: true`\n'+
'- Allow blank because existing games won\u2019t have it yet. Tracking Links will check\n'+
'  for presence at the tool level and show a message directing users to game settings.\n'+
'- Add a convenience method: `def project_code? = project_code.present?`\n'+
'- Add a normalizer that strips whitespace and uppercases on assignment:\n'+
'  `normalizes :project_code, with: -&gt;(v) { v.strip.upcase }`\n'+
'\n'+
'### 3. Controller changes (`app/controllers/games_controller.rb`)\n'+
'- Add `:project_code` to `create_params` and `update_params` so it is permitted\n'+
'  in both the `expect(game: [...])` calls\n'+
'\n'+
'### 4. Form changes (`app/views/games/_form.html.erb`)\n'+
'- Add a project code field in the form, placed directly AFTER the Name field\n'+
'  and BEFORE the Platforms checkboxes\n'+
'- Follow the exact same pattern as the existing form fields. Use a text input:\n'+
'\n'+
'```erb\n'+
'&lt;div class="mb-4"&gt;\n'+
'  &lt;%= form.label :project_code, class: "form-label" do %&gt;\n'+
'    &lt;span&gt;&lt;%= t("games.project_code_label") %&gt;&lt;/span&gt;\n'+
'    &lt;small class="text-secondary"&gt;\n'+
'      &lt;em&gt;&lt;%= t("games.project_code_hint") %&gt;&lt;/em&gt;\n'+
'    &lt;/small&gt;\n'+
'  &lt;% end %&gt;\n'+
'  &lt;%= form.text_field :project_code, class: "form-control",\n'+
'                      autocomplete: "off",\n'+
'                      style: "max-width: 200px; text-transform: uppercase",\n'+
'                      maxlength: 10,\n'+
'                      placeholder: "e.g. ENS" %&gt;\n'+
'\n'+
'  &lt;% if form.object.errors.include? :project_code %&gt;\n'+
'    &lt;div class="text-danger"&gt;\n'+
'      &lt;small&gt;\n'+
'        &lt;%= form.object.errors.full_messages_for(:project_code).to_sentence %&gt;\n'+
'      &lt;/small&gt;\n'+
'    &lt;/div&gt;\n'+
'  &lt;% end %&gt;\n'+
'&lt;/div&gt;\n'+
'```\n'+
'\n'+
'### 5. I18n (`config/locales/en.yml`)\n'+
'- Add under the existing `en.games` namespace:\n'+
'  - `project_code_label: "Project Code"`\n'+
'  - `project_code_hint: "2\u201310 character code for campaign names (e.g. ENS)"`\n'+
'\n'+
'### 6. Avo admin resource (`app/avo/resources/game.rb`)\n'+
'- Add `project_code` as an editable text field in the `fields` method, placed\n'+
'  directly AFTER the `:name` field and BEFORE `:live`\n'+
'- This field must NOT be disabled \u2014 admins need to edit backfilled codes\n'+
'- Follow the exact same pattern as other text fields in the resource:\n'+
'  `field :project_code, as: :text`\n'+
'- Also add it to `index_fields` so admins can see project codes in the game list:\n'+
'  `field :project_code, as: :text, sortable: true`\n'+
'- The Avo resource file already exists \u2014 edit it, do not create a new one\n'+
'- Important context: users cannot edit project codes in Avo (Avo is admin-only,\n'+
'  authenticated via `User#admin?`). This is the primary way admins will correct\n'+
'  backfilled or incorrect project codes on existing games.\n'+
'\n'+
'### 7. Fixtures (`spec/fixtures/games.yml`)\n'+
'- Add `project_code` to fixture games that need it for testing:\n'+
'  - `one`: project_code: "EXG"\n'+
'  - `two`: project_code: "SCG"\n'+
'  - `live_game`: project_code: "LGM"\n'+
'  - `empty`: leave project_code blank (tests the blank case)\n'+
'\n'+
'### 8. Model spec (`spec/models/game_spec.rb`)\n'+
'Add specs for the new field. Follow the existing patterns in the file:\n'+
'- `it { is_expected.to allow_values("ENS", "AB", "ABCDEFGHIJ", "A1B2").for(:project_code) }`\n'+
'- `it { is_expected.not_to allow_values("a", "ens", "A", "ABCDEFGHIJK", "EN S",\n'+
'  "EN-S", "en!").for(:project_code) }`\n'+
'- `it { is_expected.to allow_value(nil, "").for(:project_code) }` (blank allowed)\n'+
'- Test uniqueness: create a game with project_code "ENS", then validate that another\n'+
'  game with "ENS" is invalid\n'+
'- Test the normalizer: `game.project_code = " ens "; expect(game.project_code).to eq("ENS")`\n'+
'- Test `project_code?`: returns true when set, false when blank\n'+
'\n'+
'### 9. Feature spec (`spec/features/games/settings_spec.rb`)\n'+
'Add a test for the project code field in the game settings form:\n'+
'- Fill in the project code field with "TST"\n'+
'- Submit the form\n'+
'- Verify `game.reload.project_code` equals "TST"\n'+
'- Test validation: fill in an invalid value (e.g. "a"), submit, verify error shown\n'+
'- Test case normalization: fill in "ens", verify it saves as "ENS"\n'+
'\n'+
'## Codebase conventions to follow\n'+
'- Double quotes for all strings\n'+
'- `frozen_string_literal: true` at top of all Ruby files\n'+
'- Max 1 expectation per RSpec example (use `:aggregate_failures` or compound matchers)\n'+
'- Run `bundle exec rubocop` and `bundle exec rspec` before committing\n'+
'- Commit message: short summary line, blank line, description paragraph</pre>'
    );
}

// ==================== MH SYNC / RENDER ====================
function mhSyncActiveRows(){
    const beat = getActiveBeat();
    if(!beat) return;
    beat.mhRows = [];
    document.querySelectorAll('#table-mh tbody tr.row-inputs').forEach(row => {
        beat.mhRows.push({
            house:    row.querySelector('.m-house').value,
            dest:     row.querySelector('.m-dest').value,
            geo:      row.querySelector('.m-geo').value,
            placement:row.querySelector('.m-placement').value,
            adtype:   row.querySelector('.m-adtype').value,
            strategy: row.querySelector('.m-strategy').value,
            date:     row.querySelector('.m-date').value,
            shortKey: row.querySelector('.m-key').value
        });
    });
}

function mhCreateSelect(opts, cls, selected){
    let h = '<select class="' + cls + '" onchange="mhOnRowChange()"><option value="" disabled' + (!selected ? ' selected' : '') + '>Select...</option>';
    opts.forEach(o => { h += '<option value="' + o + '"' + (o === selected ? ' selected' : '') + '>' + o + '</option>'; });
    h += '</select>';
    return h;
}

function mhAddRow(data){
    data = data || {};
    const tbody = document.querySelector('#table-mh tbody');

    const tr1 = document.createElement('tr');
    tr1.className = 'row-inputs';
    tr1.innerHTML =
        '<td>' + mhCreateSelect(mhLists.houses, 'm-house', data.house) + '</td>' +
        '<td><input type="text" class="m-dest" placeholder="https://example.com" value="' + escHtml(data.dest || '') + '" oninput="mhOnRowChange()"></td>' +
        '<td>' + mhCreateSelect(mhLists.geos, 'm-geo', data.geo) + '</td>' +
        '<td>' + mhCreateSelect(mhLists.placements, 'm-placement', data.placement) + '</td>' +
        '<td>' + mhCreateSelect(mhLists.adtypes, 'm-adtype', data.adtype) + '</td>' +
        '<td>' + mhCreateSelect(mhLists.strategies, 'm-strategy', data.strategy) + '</td>' +
        '<td><input type="date" class="m-date" value="' + (data.date || todayISO()) + '" oninput="mhOnRowChange()"></td>' +
        '<td><input type="text" class="m-key" placeholder="key" value="' + escHtml(data.shortKey || '') + '" oninput="mhOnRowChange()"></td>' +
        '<td><div class="row-actions">' +
            '<button class="btn-dup" onclick="mhDuplicateRow(this)" title="Duplicate">&#128196;</button>' +
            '<button class="btn-remove" onclick="mhRemoveRow(this)" title="Remove">&#10005;</button>' +
        '</div></td>';

    const tr2 = document.createElement('tr');
    tr2.className = 'row-links';
    tr2.innerHTML =
        '<td colspan="9"><div class="row-links-inner">' +
            '<div class="short-area">' +
                '<span class="short-result"></span>' +
                '<input type="text" class="short-input" placeholder="\u2014" readonly style="display:none">' +
                '<button class="btn-shorten" onclick="mhFetchShortLink(this)" disabled>Get Short Link</button>' +
            '</div>' +
            '<div class="link-box empty" data-long-url="" data-short-key="">Fill all fields...</div>' +
        '</div></td>';

    tbody.appendChild(tr1);
    tbody.appendChild(tr2);
    mhUpdateStats();
}

function mhRenderRows(){
    const tbody = document.querySelector('#table-mh tbody');
    tbody.innerHTML = '';
    const beat = getActiveBeat();
    if(!beat){ mhUpdateStats(); return; }
    if(!beat.mhRows || beat.mhRows.length === 0){ mhAddRow(); return; }
    beat.mhRows.forEach(r => mhAddRow(r));
    mhUpdateAllLinks();
}

function mhRemoveRow(btn){
    const tbody = document.querySelector('#table-mh tbody');
    const tr1 = btn.closest('tr');
    const tr2 = tr1.nextElementSibling;
    tr1.remove();
    if(tr2 && tr2.classList.contains('row-links')) tr2.remove();
    if(tbody.querySelectorAll('tr.row-inputs').length === 0) mhAddRow();
    mhOnRowChange();
}

function mhDuplicateRow(btn){
    const origRow1 = btn.closest('tr');
    const origRow2 = origRow1.nextElementSibling;
    const cloneRow1 = origRow1.cloneNode(true);
    const cloneRow2 = origRow2.cloneNode(true);
    const origInputs1 = origRow1.querySelectorAll('input, select');
    const cloneInputs1 = cloneRow1.querySelectorAll('input, select');
    origInputs1.forEach((el, i) => { cloneInputs1[i].value = el.value; });
    cloneRow1.querySelector('.m-key').value = '';
    cloneRow2.querySelector('.short-input').value = '';
    const shortResult = cloneRow2.querySelector('.short-result');
    shortResult.innerHTML = '';
    shortResult.style.display = 'none';
    const shortenBtn = cloneRow2.querySelector('.btn-shorten');
    shortenBtn.textContent = 'Get Short Link';
    shortenBtn.disabled = true;
    shortenBtn.style.display = '';
    shortenBtn.style.background = '';
    origRow2.parentNode.insertBefore(cloneRow1, origRow2.nextSibling);
    cloneRow1.parentNode.insertBefore(cloneRow2, cloneRow1.nextSibling);
    mhOnRowChange();
}

function mhOnRowChange(){
    mhUpdateAllLinks();
    mhValidateShortKeys();
    mhSyncActiveRows();
    saveState();
    renderBeatsMH();
}

// ==================== MH LINK GENERATION ====================
function mhUpdateAllLinks(){
    const proj = document.getElementById('mh_project').value;
    const beat = getActiveBeat();
    const beatName = beat ? beat.name.replace(/\s+/g, '') : '';

    document.querySelectorAll('#table-mh tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const house     = row.querySelector('.m-house').value.trim().replace(/\s+/g, '');
        const dest      = row.querySelector('.m-dest').value.trim().replace(/\/$/,'');
        const geo       = row.querySelector('.m-geo').value;
        const placement = row.querySelector('.m-placement').value.trim().replace(/\s+/g, '');
        const adtype    = row.querySelector('.m-adtype').value.trim().replace(/\s+/g, '');
        const strategy  = row.querySelector('.m-strategy').value;
        const dateRaw   = row.querySelector('.m-date').value;
        const shortKey  = row.querySelector('.m-key').value.trim().replace(/\s+/g, '');
        const outBox    = linksRow.querySelector('.link-box');
        const shortenBtn = linksRow.querySelector('.btn-shorten');

        if(!house || !dest || !geo || !placement || !adtype || !strategy || !shortKey || !beatName){
            outBox.innerHTML = 'Fill all fields...';
            outBox.className = 'link-box empty';
            outBox.setAttribute('data-long-url', '');
            outBox.setAttribute('data-short-key', '');
            shortenBtn.disabled = true;
            return;
        }

        const date = formatDate(dateRaw);
        const prefix = proj ? proj + '-' : '';
        const parentCamp = prefix + 'MediaHouse-' + strategy + '-' + geo + '_' + date + '-' + placement + '_' + adtype;
        const campName = parentCamp + '-' + house;

        const connector = dest.includes('?') ? '&' : '?';
        const params = new URLSearchParams();
        params.set('campaign_name', campName);
        params.set('ad_group_name', house);
        params.set('utm_source', house);
        params.set('utm_medium', 'mediahouse');
        params.set('utm_campaign', parentCamp);
        params.set('utm_content', shortKey);

        const fullLink = dest + connector + params.toString();

        outBox.className = 'link-box';
        outBox.innerHTML = '<a href="' + fullLink + '" target="_blank">' + fullLink + '</a>';
        outBox.setAttribute('data-long-url', fullLink);
        outBox.setAttribute('data-short-key', shortKey);
        shortenBtn.disabled = false;
    });

    mhUpdateStats();
}

// ==================== MH SHORT LINK ====================
async function mhFetchShortLink(btn){
    const linksRow = btn.closest('tr');
    const inputsRow = linksRow.previousElementSibling;
    const linkBox = linksRow.querySelector('.link-box');
    const shortInput = linksRow.querySelector('.short-input');
    const longUrl = linkBox.getAttribute('data-long-url');
    const shortKey = linkBox.getAttribute('data-short-key');
    const destVal = inputsRow.querySelector('.m-dest').value;

    if(!longUrl || !shortKey) return;

    let hostname;
    try { hostname = new URL(destVal).hostname.replace(/^www\./,''); }
    catch(e){ shortInput.value = 'Invalid URL'; return; }

    const apiUrl = `https://connect.${hostname}/shorten`;

    btn.textContent = 'Shortening...';
    btn.disabled = true;
    shortInput.value = '';

    const shortResult = linksRow.querySelector('.short-result');
    try {
        const requestUrl = `${apiUrl}?url=${encodeURIComponent(longUrl)}&short_key=${encodeURIComponent(shortKey)}`;
        const response = await fetch(requestUrl, { method: 'GET' });
        if(!response.ok) throw new Error('Network Error');
        const data = await response.json();
        if(data.short_url){
            shortInput.value = data.short_url;
            shortResult.innerHTML = '<a href="' + data.short_url + '" target="_blank">' + data.short_url + '</a>';
            shortResult.style.display = '';
            btn.style.display = 'none';
        } else {
            shortInput.value = 'Error';
            btn.textContent = 'Retry';
            btn.disabled = false;
        }
    } catch(error){
        console.error(error);
        shortInput.value = 'API Error';
        btn.textContent = 'Retry';
        btn.disabled = false;
        alert('Failed to shorten link.\nIn the production app, TRACKS handles shortening internally.\nThe POC cannot shorten because no service exists at "connect.' + hostname + '".');
    }

    mhUpdateStats();
}

// ==================== MH BULK ACTIONS ====================
function mhCopyAllLinks(){
    const links = [];
    document.querySelectorAll('#table-mh tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        const shortUrl = linksRow.querySelector('.short-input').value;
        const house = row.querySelector('.m-house').value.trim();
        if(url){
            links.push(shortUrl ? `${house}\t${shortUrl}\t${url}` : `${house}\t\t${url}`);
        }
    });
    if(!links.length){ alert('No links to copy.'); return; }
    const text = 'Media House\tShort Link\tFull Link\n' + links.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('[onclick="mhCopyAllLinks()"]');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = 'var(--green)';
        btn.style.color = '#fff';
        setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
    });
}

function mhDownloadCSV(){
    const beat = getActiveBeat();
    const beatName = beat ? beat.name : 'unknown';
    const rows = [['Beat','MediaHouse','DestURL','GEO','Placement','AdType','Strategy','Date','ShortKey','CampaignName','FullLink','ShortLink']];
    document.querySelectorAll('#table-mh tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const house     = row.querySelector('.m-house').value.trim();
        const destUrl   = row.querySelector('.m-dest').value.trim();
        const geo       = row.querySelector('.m-geo').value;
        const placement = row.querySelector('.m-placement').value;
        const adtype    = row.querySelector('.m-adtype').value;
        const strategy  = row.querySelector('.m-strategy').value;
        const dateVal   = row.querySelector('.m-date').value;
        const shortKey  = row.querySelector('.m-key').value.trim();
        const longUrl   = linksRow.querySelector('.link-box').getAttribute('data-long-url') || '';
        const shortUrl  = linksRow.querySelector('.short-input').value || '';

        let campName = '';
        if(longUrl){
            try { campName = new URL(longUrl).searchParams.get('campaign_name') || ''; } catch(e){}
        }

        if(house) rows.push([beatName, house, destUrl, geo, placement, adtype, strategy, dateVal, shortKey, campName, longUrl, shortUrl]);
    });

    if(rows.length <= 1){ alert('No data to export.'); return; }

    const csv = rows.map(r => r.map(c => '"' + (c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'mediahouse_links_' + beatName + '_' + todayISO() + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ==================== MH STATS ====================
function mhUpdateStats(){
    let total = 0, ready = 0, shortened = 0;
    document.querySelectorAll('#table-mh tbody tr.row-inputs').forEach(row => {
        total++;
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        if(url) ready++;
        const shortVal = linksRow.querySelector('.short-input').value;
        if(shortVal && !shortVal.startsWith('Error') && !shortVal.startsWith('API')) shortened++;
    });
    document.getElementById('mh-stat-total').textContent = total;
    document.getElementById('mh-stat-ready').textContent = ready;
    document.getElementById('mh-stat-shortened').textContent = shortened;
}

// ==================== MH FIELD VALUES ====================
function mhToggleFieldValues(){
    const body = document.getElementById('mh-field-vals-body');
    const chev = document.getElementById('mh-field-vals-chev');
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : 'block';
    chev.style.transform = open ? 'rotate(-90deg)' : 'rotate(0)';
    if(!open) mhRenderFieldValues();
}

function mhRenderFieldValues(){
    const body = document.getElementById('mh-field-vals-body');
    body.innerHTML = '';
    MH_FIELD_META.forEach(fm => {
        const row = document.createElement('div'); row.className = 'field-vals-row';
        const lbl = document.createElement('div'); lbl.className = 'field-vals-label'; lbl.textContent = fm.label;
        row.appendChild(lbl);
        const valContainer = document.createElement('div'); valContainer.className = 'values-list';
        mhRenderValsList(valContainer, fm.key);
        const addWrap = document.createElement('span'); addWrap.className = 'val-add';
        const addInp = document.createElement('input'); addInp.placeholder = 'Add…';
        addInp.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); mhCommitInlineAdd(fm.key, addInp); }});
        addWrap.appendChild(addInp);
        const addBtn = document.createElement('button'); addBtn.textContent = '+';
        addBtn.addEventListener('click', () => mhCommitInlineAdd(fm.key, addInp));
        addWrap.appendChild(addBtn);
        valContainer.appendChild(addWrap);
        row.appendChild(valContainer);
        body.appendChild(row);
    });
    const note = document.createElement('div');
    note.style.cssText = 'font-size:.7rem;color:#10b981;margin-top:4px;font-style:italic;padding-bottom:8px';
    note.textContent = '\u270e custom values are saved in your browser';
    body.appendChild(note);
}

function mhRenderValsList(container, key){
    (mhLists[key] || []).forEach(x => {
        const t = document.createElement('span');
        const isCustom = MH_CUSTOM[key] && MH_CUSTOM[key].has(x);
        t.className = 'val-tag' + (isCustom ? ' custom' : '');
        t.textContent = x;
        if(isCustom){
            const rm = document.createElement('span'); rm.className = 'val-rm'; rm.textContent = '\u00d7';
            rm.addEventListener('click', () => { mhRemoveCustomValue(key, x); });
            t.appendChild(rm);
        }
        container.appendChild(t);
    });
}

function mhCommitInlineAdd(key, input){
    const val = input.value.trim().replace(/\s+/g, '');
    if(!val) return;
    if(mhLists[key].includes(val)){ input.value = ''; return; }
    mhLists[key].push(val);
    if(!MH_CUSTOM[key]) MH_CUSTOM[key] = new Set();
    MH_CUSTOM[key].add(val);
    saveMHLists();
    mhRefreshSelects(key);
    input.value = '';
    mhRenderFieldValues();
}

function mhRemoveCustomValue(key, val){
    const idx = mhLists[key].indexOf(val);
    if(idx > -1) mhLists[key].splice(idx, 1);
    if(MH_CUSTOM[key]) MH_CUSTOM[key].delete(val);
    saveMHLists();
    mhRefreshSelects(key);
    mhRenderFieldValues();
}

function mhRefreshSelects(key){
    const fm = MH_FIELD_META.find(f => f.key === key);
    if(!fm) return;
    document.querySelectorAll('.' + fm.selectCls).forEach(sel => {
        const current = sel.value;
        sel.innerHTML = '<option value="" disabled>Select...</option>';
        mhLists[key].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v;
            if(v === current) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

// ==================== OM SYNC / RENDER ====================
function omSyncActiveRows(){
    const beat = getActiveBeat();
    if(!beat) return;
    beat.omRows = [];
    document.querySelectorAll('#table-om tbody tr.row-inputs').forEach(row => {
        beat.omRows.push({
            activity:  row.querySelector('.o-activity').value,
            dest:      row.querySelector('.o-dest').value,
            placement: row.querySelector('.o-placement').value,
            date:      row.querySelector('.o-date').value,
            shortKey:  row.querySelector('.o-key').value
        });
    });
}

function omCreateSelect(opts, cls, selected){
    let h = '<select class="' + cls + '" onchange="omOnRowChange()"><option value="" disabled' + (!selected ? ' selected' : '') + '>Select...</option>';
    opts.forEach(o => { h += '<option value="' + o + '"' + (o === selected ? ' selected' : '') + '>' + o + '</option>'; });
    h += '</select>';
    return h;
}

function omAddRow(data){
    data = data || {};
    const tbody = document.querySelector('#table-om tbody');

    const tr1 = document.createElement('tr');
    tr1.className = 'row-inputs';
    tr1.innerHTML =
        '<td>' + omCreateSelect(omLists.activities, 'o-activity', data.activity) + '</td>' +
        '<td><input type="text" class="o-dest" placeholder="https://example.com" value="' + escHtml(data.dest || '') + '" oninput="omOnRowChange()"></td>' +
        '<td>' + omCreateSelect(omLists.omPlacements, 'o-placement', data.placement) + '</td>' +
        '<td><input type="date" class="o-date" value="' + (data.date || todayISO()) + '" oninput="omOnRowChange()"></td>' +
        '<td><input type="text" class="o-key" placeholder="key" value="' + escHtml(data.shortKey || '') + '" oninput="omOnRowChange()"></td>' +
        '<td><div class="row-actions">' +
            '<button class="btn-dup" onclick="omDuplicateRow(this)" title="Duplicate">&#128196;</button>' +
            '<button class="btn-remove" onclick="omRemoveRow(this)" title="Remove">&#10005;</button>' +
        '</div></td>';

    const tr2 = document.createElement('tr');
    tr2.className = 'row-links';
    tr2.innerHTML =
        '<td colspan="6"><div class="row-links-inner">' +
            '<div class="short-area">' +
                '<span class="short-result"></span>' +
                '<input type="text" class="short-input" placeholder="\u2014" readonly style="display:none">' +
                '<button class="btn-shorten" onclick="omFetchShortLink(this)" disabled>Get Short Link</button>' +
            '</div>' +
            '<div class="link-box empty" data-long-url="" data-short-key="">Fill all fields...</div>' +
        '</div></td>';

    tbody.appendChild(tr1);
    tbody.appendChild(tr2);
    omUpdateStats();
}

function omRenderRows(){
    const tbody = document.querySelector('#table-om tbody');
    tbody.innerHTML = '';
    const beat = getActiveBeat();
    if(!beat){ omUpdateStats(); return; }
    if(!beat.omRows || beat.omRows.length === 0){ omAddRow(); return; }
    beat.omRows.forEach(r => omAddRow(r));
    omUpdateAllLinks();
}

function omRemoveRow(btn){
    const tbody = document.querySelector('#table-om tbody');
    const tr1 = btn.closest('tr');
    const tr2 = tr1.nextElementSibling;
    tr1.remove();
    if(tr2 && tr2.classList.contains('row-links')) tr2.remove();
    if(tbody.querySelectorAll('tr.row-inputs').length === 0) omAddRow();
    omOnRowChange();
}

function omDuplicateRow(btn){
    const origRow1 = btn.closest('tr');
    const origRow2 = origRow1.nextElementSibling;
    const cloneRow1 = origRow1.cloneNode(true);
    const cloneRow2 = origRow2.cloneNode(true);
    const origInputs1 = origRow1.querySelectorAll('input, select');
    const cloneInputs1 = cloneRow1.querySelectorAll('input, select');
    origInputs1.forEach((el, i) => { cloneInputs1[i].value = el.value; });
    cloneRow1.querySelector('.o-key').value = '';
    cloneRow2.querySelector('.short-input').value = '';
    const shortResult = cloneRow2.querySelector('.short-result');
    shortResult.innerHTML = '';
    shortResult.style.display = 'none';
    const shortenBtn = cloneRow2.querySelector('.btn-shorten');
    shortenBtn.textContent = 'Get Short Link';
    shortenBtn.disabled = true;
    shortenBtn.style.display = '';
    shortenBtn.style.background = '';
    origRow2.parentNode.insertBefore(cloneRow1, origRow2.nextSibling);
    cloneRow1.parentNode.insertBefore(cloneRow2, cloneRow1.nextSibling);
    omOnRowChange();
}

function omOnRowChange(){
    omUpdateAllLinks();
    omValidateShortKeys();
    omSyncActiveRows();
    saveState();
    renderBeatsOM();
}

// ==================== OM LINK GENERATION ====================
function omUpdateAllLinks(){
    const proj = document.getElementById('om_project').value;
    const beat = getActiveBeat();
    const beatName = beat ? beat.name.replace(/\s+/g, '') : '';

    document.querySelectorAll('#table-om tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const activity  = row.querySelector('.o-activity').value.trim().replace(/\s+/g, '');
        const dest      = row.querySelector('.o-dest').value.trim().replace(/\/$/,'');
        const placement = row.querySelector('.o-placement').value.trim().replace(/\s+/g, '');
        const dateRaw   = row.querySelector('.o-date').value;
        const shortKey  = row.querySelector('.o-key').value.trim().replace(/\s+/g, '');
        const outBox    = linksRow.querySelector('.link-box');
        const shortenBtn = linksRow.querySelector('.btn-shorten');

        if(!activity || !dest || !placement || !shortKey || !beatName){
            outBox.innerHTML = 'Fill all fields...';
            outBox.className = 'link-box empty';
            outBox.setAttribute('data-long-url', '');
            outBox.setAttribute('data-short-key', '');
            shortenBtn.disabled = true;
            return;
        }

        const date = formatDate(dateRaw);
        const prefix = proj ? proj + '-' : '';
        const campName = prefix + 'Organic-' + beatName + '_' + date + '-' + activity + '-' + placement;

        const connector = dest.includes('?') ? '&' : '?';
        const params = new URLSearchParams();
        params.set('campaign_name', campName);
        params.set('ad_group_name', placement);
        params.set('utm_source', placement.toLowerCase());
        params.set('utm_medium', 'organic');
        params.set('utm_campaign', campName);
        params.set('utm_content', shortKey);

        const fullLink = dest + connector + params.toString();

        outBox.className = 'link-box';
        outBox.innerHTML = '<a href="' + fullLink + '" target="_blank">' + fullLink + '</a>';
        outBox.setAttribute('data-long-url', fullLink);
        outBox.setAttribute('data-short-key', shortKey);
        shortenBtn.disabled = false;
    });

    omUpdateStats();
}

// ==================== OM SHORT LINK ====================
async function omFetchShortLink(btn){
    const linksRow = btn.closest('tr');
    const inputsRow = linksRow.previousElementSibling;
    const linkBox = linksRow.querySelector('.link-box');
    const shortInput = linksRow.querySelector('.short-input');
    const longUrl = linkBox.getAttribute('data-long-url');
    const shortKey = linkBox.getAttribute('data-short-key');
    const destVal = inputsRow.querySelector('.o-dest').value;

    if(!longUrl || !shortKey) return;

    let hostname;
    try { hostname = new URL(destVal).hostname.replace(/^www\./,''); }
    catch(e){ shortInput.value = 'Invalid URL'; return; }

    const apiUrl = `https://connect.${hostname}/shorten`;

    btn.textContent = 'Shortening...';
    btn.disabled = true;
    shortInput.value = '';

    const shortResult = linksRow.querySelector('.short-result');
    try {
        const requestUrl = `${apiUrl}?url=${encodeURIComponent(longUrl)}&short_key=${encodeURIComponent(shortKey)}`;
        const response = await fetch(requestUrl, { method: 'GET' });
        if(!response.ok) throw new Error('Network Error');
        const data = await response.json();
        if(data.short_url){
            shortInput.value = data.short_url;
            shortResult.innerHTML = '<a href="' + data.short_url + '" target="_blank">' + data.short_url + '</a>';
            shortResult.style.display = '';
            btn.style.display = 'none';
        } else {
            shortInput.value = 'Error';
            btn.textContent = 'Retry';
            btn.disabled = false;
        }
    } catch(error){
        console.error(error);
        shortInput.value = 'API Error';
        btn.textContent = 'Retry';
        btn.disabled = false;
        alert('Failed to shorten link.\nIn the production app, TRACKS handles shortening internally.\nThe POC cannot shorten because no service exists at "connect.' + hostname + '".');
    }

    omUpdateStats();
}

// ==================== OM BULK ACTIONS ====================
function omCopyAllLinks(){
    const links = [];
    document.querySelectorAll('#table-om tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        const shortUrl = linksRow.querySelector('.short-input').value;
        const activity = row.querySelector('.o-activity').value.trim();
        const placement = row.querySelector('.o-placement').value.trim();
        if(url){
            links.push(shortUrl ? `${activity}\t${placement}\t${shortUrl}\t${url}` : `${activity}\t${placement}\t\t${url}`);
        }
    });
    if(!links.length){ alert('No links to copy.'); return; }
    const text = 'Activity\tPlacement\tShort Link\tFull Link\n' + links.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('[onclick="omCopyAllLinks()"]');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = 'var(--green)';
        btn.style.color = '#fff';
        setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
    });
}

function omDownloadCSV(){
    const beat = getActiveBeat();
    const beatName = beat ? beat.name : 'unknown';
    const rows = [['Beat','Activity','DestURL','Placement','Date','ShortKey','CampaignName','FullLink','ShortLink']];
    document.querySelectorAll('#table-om tbody tr.row-inputs').forEach(row => {
        const linksRow = row.nextElementSibling;
        const activity  = row.querySelector('.o-activity').value.trim();
        const destUrl   = row.querySelector('.o-dest').value.trim();
        const placement = row.querySelector('.o-placement').value;
        const dateVal   = row.querySelector('.o-date').value;
        const shortKey  = row.querySelector('.o-key').value.trim();
        const longUrl   = linksRow.querySelector('.link-box').getAttribute('data-long-url') || '';
        const shortUrl  = linksRow.querySelector('.short-input').value || '';

        let campName = '';
        if(longUrl){
            try { campName = new URL(longUrl).searchParams.get('campaign_name') || ''; } catch(e){}
        }

        if(activity) rows.push([beatName, activity, destUrl, placement, dateVal, shortKey, campName, longUrl, shortUrl]);
    });

    if(rows.length <= 1){ alert('No data to export.'); return; }

    const csv = rows.map(r => r.map(c => '"' + (c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'organic_links_' + beatName + '_' + todayISO() + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ==================== OM STATS ====================
function omUpdateStats(){
    let total = 0, ready = 0, shortened = 0;
    document.querySelectorAll('#table-om tbody tr.row-inputs').forEach(row => {
        total++;
        const linksRow = row.nextElementSibling;
        const url = linksRow.querySelector('.link-box').getAttribute('data-long-url');
        if(url) ready++;
        const shortVal = linksRow.querySelector('.short-input').value;
        if(shortVal && !shortVal.startsWith('Error') && !shortVal.startsWith('API')) shortened++;
    });
    document.getElementById('om-stat-total').textContent = total;
    document.getElementById('om-stat-ready').textContent = ready;
    document.getElementById('om-stat-shortened').textContent = shortened;
}

// ==================== OM FIELD VALUES ====================
function omToggleFieldValues(){
    const body = document.getElementById('om-field-vals-body');
    const chev = document.getElementById('om-field-vals-chev');
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : 'block';
    chev.style.transform = open ? 'rotate(-90deg)' : 'rotate(0)';
    if(!open) omRenderFieldValues();
}

function omRenderFieldValues(){
    const body = document.getElementById('om-field-vals-body');
    body.innerHTML = '';
    OM_FIELD_META.forEach(fm => {
        const row = document.createElement('div'); row.className = 'field-vals-row';
        const lbl = document.createElement('div'); lbl.className = 'field-vals-label'; lbl.textContent = fm.label;
        row.appendChild(lbl);
        const valContainer = document.createElement('div'); valContainer.className = 'values-list';
        omRenderValsList(valContainer, fm.key);
        const addWrap = document.createElement('span'); addWrap.className = 'val-add';
        const addInp = document.createElement('input'); addInp.placeholder = 'Add…';
        addInp.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); omCommitInlineAdd(fm.key, addInp); }});
        addWrap.appendChild(addInp);
        const addBtn = document.createElement('button'); addBtn.textContent = '+';
        addBtn.addEventListener('click', () => omCommitInlineAdd(fm.key, addInp));
        addWrap.appendChild(addBtn);
        valContainer.appendChild(addWrap);
        row.appendChild(valContainer);
        body.appendChild(row);
    });
    const note = document.createElement('div');
    note.style.cssText = 'font-size:.7rem;color:#10b981;margin-top:4px;font-style:italic;padding-bottom:8px';
    note.textContent = '\u270e custom values are saved in your browser';
    body.appendChild(note);
}

function omRenderValsList(container, key){
    (omLists[key] || []).forEach(x => {
        const t = document.createElement('span');
        const isCustom = OM_CUSTOM[key] && OM_CUSTOM[key].has(x);
        t.className = 'val-tag' + (isCustom ? ' custom' : '');
        t.textContent = x;
        if(isCustom){
            const rm = document.createElement('span'); rm.className = 'val-rm'; rm.textContent = '\u00d7';
            rm.addEventListener('click', () => { omRemoveCustomValue(key, x); });
            t.appendChild(rm);
        }
        container.appendChild(t);
    });
}

function omCommitInlineAdd(key, input){
    const val = input.value.trim();
    if(!val) return;
    if(omLists[key].includes(val)){ input.value = ''; return; }
    omLists[key].push(val);
    if(!OM_CUSTOM[key]) OM_CUSTOM[key] = new Set();
    OM_CUSTOM[key].add(val);
    saveOMLists();
    omRefreshSelects(key);
    input.value = '';
    omRenderFieldValues();
}

function omRemoveCustomValue(key, val){
    const idx = omLists[key].indexOf(val);
    if(idx > -1) omLists[key].splice(idx, 1);
    if(OM_CUSTOM[key]) OM_CUSTOM[key].delete(val);
    saveOMLists();
    omRefreshSelects(key);
    omRenderFieldValues();
}

function omRefreshSelects(key){
    const fm = OM_FIELD_META.find(f => f.key === key);
    if(!fm) return;
    document.querySelectorAll('.' + fm.selectCls).forEach(sel => {
        const current = sel.value;
        sel.innerHTML = '<option value="" disabled>Select...</option>';
        omLists[key].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v;
            if(v === current) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

// ==================== COST UPLOAD ====================
function costFormatTimestamp(iso){
    if(!iso) return '\u2014';
    const d = new Date(iso);
    const pad = n => String(n).padStart(2,'0');
    return pad(d.getDate()) + '.' + pad(d.getMonth()+1) + '.' + d.getFullYear() + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
}

function computeSourceHash(row){
    const keys = Object.keys(row).sort();
    const sorted = {};
    keys.forEach(k => { sorted[k] = row[k]; });
    return JSON.stringify(sorted);
}

function costConnectUrl(row, shortKey){
    const dest = row.dest || row.destUrl || '';
    if(!dest) return '';
    try {
        const hostname = new URL(dest).hostname.replace(/^www\./,'');
        return 'https://connect.' + hostname + '/' + encodeURIComponent(shortKey);
    } catch(e){ return ''; }
}

function costAggregateEntries(beat){
    const entries = [];
    (beat.rows || []).forEach(r => {
        if(!r.shortKey) return;
        entries.push({ source: 'Influencer', name: r.creator || '', shortKey: r.shortKey, sourceRow: r, sourceHash: computeSourceHash(r), connectUrl: costConnectUrl(r, r.shortKey) });
    });
    (beat.mhRows || []).forEach(r => {
        if(!r.shortKey) return;
        entries.push({ source: 'Media House', name: r.house || '', shortKey: r.shortKey, sourceRow: r, sourceHash: computeSourceHash(r), connectUrl: costConnectUrl(r, r.shortKey) });
    });
    (beat.omRows || []).forEach(r => {
        if(!r.shortKey) return;
        entries.push({ source: 'Organic', name: r.activity || '', shortKey: r.shortKey, sourceRow: r, sourceHash: computeSourceHash(r), connectUrl: costConnectUrl(r, r.shortKey) });
    });
    return entries;
}

function costGetStatus(entry, costEntry){
    if(!costEntry || (!costEntry.budget && !costEntry.endDate && !costEntry.duration && !costEntry.handle && !costEntry.hashtags && !costEntry.notes)) return 'new';
    if(costEntry.sourceHash !== entry.sourceHash) return 'updated';
    return 'complete';
}

function costRenderEntries(){
    const beat = getActiveBeat();
    const section = document.getElementById('active-cost-section');
    const tbody = document.querySelector('#table-cost tbody');
    if(!beat){
        section.style.display = 'none';
        tbody.innerHTML = '';
        costUpdateStats(0, 0, 0, 0);
        return;
    }
    section.style.display = 'block';
    document.getElementById('cost-tracker-title').textContent = 'Cost Upload \u2014 ' + beat.name;
    const costData = beat.costData || {};
    const entries = costAggregateEntries(beat);

    if(entries.length === 0){
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:24px;color:#94a3b8;font-style:italic">No entries with short keys found. Add entries with short keys in the Influencer, Media Houses, or Organic Media tabs first.</td></tr>';
        costUpdateStats(0, 0, 0, 0);
        return;
    }

    let statNew = 0, statUpdated = 0, statComplete = 0;
    let html = '';
    entries.forEach(entry => {
        const cd = costData[entry.shortKey] || {};
        const status = costGetStatus(entry, cd);
        if(status === 'new') statNew++;
        else if(status === 'updated') statUpdated++;
        else statComplete++;

        const badgeCls = status === 'new' ? 'cost-badge-new' : status === 'updated' ? 'cost-badge-updated' : 'cost-badge-complete';
        const badgeText = status === 'new' ? 'NEW' : status === 'updated' ? 'UPDATED' : '\u2713';

        html += '<tr class="row-inputs">' +
            '<td><span class="cost-badge ' + badgeCls + '" data-cost-sk="' + escHtml(entry.shortKey) + '">' + badgeText + '</span></td>' +
            '<td><span class="cost-source">' + escHtml(entry.source) + '</span></td>' +
            '<td><span class="cost-name" title="' + escHtml(entry.name) + '">' + escHtml(entry.name) + '</span></td>' +
            '<td>' + (entry.connectUrl ? '<a class="cost-shortlink" href="' + escHtml(entry.connectUrl) + '" target="_blank" title="' + escHtml(entry.connectUrl) + '">' + escHtml(entry.shortKey) + '</a>' : '<span class="cost-shortlink">' + escHtml(entry.shortKey) + '</span>') + '</td>' +
            '<td><input type="text" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="budget" value="' + escHtml(cd.budget || '') + '" placeholder="e.g. 5000" onchange="costOnFieldChange()"></td>' +
            '<td><input type="date" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="endDate" value="' + escHtml(cd.endDate || '') + '" onchange="costOnFieldChange()"></td>' +
            '<td><input type="number" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="duration" value="' + escHtml(cd.duration || '') + '" placeholder="Days" min="0" onchange="costOnFieldChange()"></td>' +
            '<td><input type="text" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="handle" value="' + escHtml(cd.handle || '') + '" placeholder="@username" onchange="costOnFieldChange()"></td>' +
            '<td><input type="text" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="hashtags" value="' + escHtml(cd.hashtags || '') + '" placeholder="#game, #ad" onchange="costOnFieldChange()"></td>' +
            '<td><input type="text" class="cost-field" data-cost-sk="' + escHtml(entry.shortKey) + '" data-cost-field="notes" value="' + escHtml(cd.notes || '') + '" placeholder="Notes..." onchange="costOnFieldChange()"></td>' +
            '<td><span class="cost-updated" data-cost-ts="' + escHtml(entry.shortKey) + '">' + costFormatTimestamp(cd.lastSaved) + '</span></td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
    costUpdateStats(entries.length, statNew, statUpdated, statComplete);
}

function costOnFieldChange(){
    const beat = getActiveBeat();
    if(!beat) return;
    if(!beat.costData) beat.costData = {};
    const entries = costAggregateEntries(beat);
    const entryMap = {};
    entries.forEach(e => { entryMap[e.shortKey] = e; });

    const shortKeys = new Set();
    document.querySelectorAll('#table-cost .cost-field').forEach(input => {
        shortKeys.add(input.dataset.costSk);
    });

    shortKeys.forEach(sk => {
        const fields = {};
        document.querySelectorAll('#table-cost .cost-field[data-cost-sk="' + sk + '"]').forEach(input => {
            fields[input.dataset.costField] = input.value;
        });
        const hasData = fields.budget || fields.endDate || fields.duration || fields.handle || fields.hashtags || fields.notes;
        if(hasData){
            const entry = entryMap[sk];
            beat.costData[sk] = {
                budget: fields.budget || '',
                endDate: fields.endDate || '',
                duration: fields.duration || '',
                handle: fields.handle || '',
                hashtags: fields.hashtags || '',
                notes: fields.notes || '',
                sourceHash: entry ? entry.sourceHash : '',
                lastSaved: new Date().toISOString()
            };
        } else {
            delete beat.costData[sk];
        }
    });
    saveState();
    costRefreshBadges(entries, beat);
}

function costRefreshBadges(entries, beat){
    const costData = beat.costData || {};
    let statNew = 0, statUpdated = 0, statComplete = 0;
    entries.forEach(entry => {
        const cd = costData[entry.shortKey] || {};
        const status = costGetStatus(entry, cd);
        if(status === 'new') statNew++;
        else if(status === 'updated') statUpdated++;
        else statComplete++;

        const badge = document.querySelector('#table-cost .cost-badge[data-cost-sk="' + entry.shortKey + '"]');
        if(badge){
            badge.className = 'cost-badge ' + (status === 'new' ? 'cost-badge-new' : status === 'updated' ? 'cost-badge-updated' : 'cost-badge-complete');
            badge.textContent = status === 'new' ? 'NEW' : status === 'updated' ? 'UPDATED' : '\u2713';
        }
        const ts = document.querySelector('#table-cost .cost-updated[data-cost-ts="' + entry.shortKey + '"]');
        if(ts) ts.textContent = costFormatTimestamp(cd.lastSaved);
    });
    costUpdateStats(entries.length, statNew, statUpdated, statComplete);
}

function costUpdateStats(total, nw, updated, complete){
    document.getElementById('cost-stat-total').textContent = total;
    document.getElementById('cost-stat-new').textContent = nw;
    document.getElementById('cost-stat-updated').textContent = updated;
    document.getElementById('cost-stat-complete').textContent = complete;
}

function costDownloadCSV(){
    const beat = getActiveBeat();
    if(!beat){ alert('No beat selected.'); return; }
    const beatName = beat.name;
    const costData = beat.costData || {};
    const entries = costAggregateEntries(beat);
    if(entries.length === 0){ alert('No data to export.'); return; }

    const rows = [['Beat','Source','Name','ShortKey','Budget','EndDate','Duration','Handle','Hashtags','Notes','Status','Updated']];
    entries.forEach(entry => {
        const cd = costData[entry.shortKey] || {};
        const status = costGetStatus(entry, cd);
        rows.push([
            beatName, entry.source, entry.name, entry.shortKey,
            cd.budget || '', cd.endDate || '', cd.duration || '',
            cd.handle || '', cd.hashtags || '', cd.notes || '',
            status.toUpperCase(), cd.lastSaved || ''
        ]);
    });

    const csv = rows.map(r => r.map(c => '"' + (c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'cost_upload_' + beatName + '_' + todayISO() + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ==================== INIT ====================
window.onload = function(){
    loadState();
    populateBeatSelect();
    renderBeats();
    if(getActiveBeat()) renderRows();
    buildGuide();
};
</script>

</body>
</html>
