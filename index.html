<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACKS Ad Ops Suite</title>
    <style>
        :root {
            /* BRAND COLOR */
            --primary: #ff0249; 
            
            /* UI Colors */
            --light: #f8f9fa;
            --grey: #eef2f5;
            --dark: #2c3e50;
            
            /* Tree Colors */
            --camp-border: #4a86e8;
            --camp-bg: #f1f6fd;
            --adg-border: #27ae60;
            --adg-bg: #e9f7ef;
            --cr-border: #ff0249;
            --cr-bg: #fff0f5;
            
            /* Platform Colors */
            --meta-blue: #0668E1;
            --reddit-orange: #FF4500;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: var(--grey); color: #333; padding-bottom: 100px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .app-header { display: flex; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; justify-content: space-between; align-items: center; }
        .header-branding { display: flex; align-items: center; gap: 15px; }
        .logo-link { text-decoration: none; display: block; transition: opacity 0.2s; cursor: pointer; }
        .logo-link:hover { opacity: 0.8; }
        .header-logo { height: 32px; width: auto; display: block; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); border: none; padding: 0; line-height: 1; }
        .nav-home { cursor: pointer; color: #555; font-weight: bold; display: none; align-items: center; gap: 5px; transition: 0.2s; }
        .nav-home:hover { color: var(--primary); }

        /* VIEWS */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px; }
        .tool-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 40px 30px; text-align: center; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--primary); }
        .card-icon { font-size: 3rem; margin-bottom: 20px; color: var(--primary); }
        .card-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--dark); }
        .card-desc { color: #777; line-height: 1.5; }

        /* INSTRUCTION GUIDE BOX */
        .guide-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .guide-step { display: flex; align-items: flex-start; gap: 10px; }
        .guide-icon { font-size: 1.2rem; background: #f0f0f0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
        .guide-text { font-size: 0.85rem; line-height: 1.4; color: #555; }
        .guide-text strong { color: #333; display: block; margin-bottom: 2px; }

        /* TREE BUILDER */
        .tree-container { margin-top: 20px; padding-bottom: 40px; }
        
        /* Blocks */
        .block-campaign, .block-adgroup, .block-creative { border-left: 5px solid #ccc; margin-bottom: 20px; padding: 15px; border-radius: 0 8px 8px 0; position: relative; transition: all 0.2s; }
        
        .block-campaign { border-color: var(--camp-border); background: var(--camp-bg); border: 1px solid #ddd; border-left: 6px solid var(--camp-border); }
        .block-header-camp { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; cursor: pointer; user-select: none; }
        .camp-label { font-weight: bold; color: var(--camp-border); font-size: 1.1rem; }

        .block-adgroup { margin-top: 15px; border-color: var(--adg-border); background: var(--adg-bg); border: 1px solid #ddd; border-left: 6px solid var(--adg-border); }
        .block-header-adg { display: flex; justify-content: space-between; align-items: center; padding-bottom: 5px; cursor: pointer; user-select: none; }
        .adg-label { font-weight: bold; color: var(--adg-border); font-size: 1rem; }

        .block-creative { margin-top: 10px; border-color: var(--cr-border); background: var(--cr-bg); border: 1px solid #ddd; border-left: 6px solid var(--cr-border); padding: 10px; }
        .block-header-cr { display: flex; justify-content: space-between; align-items: center; padding-bottom: 5px; cursor: pointer; user-select: none; margin-bottom: 5px; }
        .cr-label { font-weight: bold; color: var(--cr-border); font-size: 0.9rem; display: block; }

        .tree-line-camp, .tree-line-adg { border-left: 2px dotted #ccc; margin-left: 20px; padding-left: 20px; }
        .toggle-icon { margin-right: 8px; font-size: 0.8rem; display: inline-block; transition: transform 0.2s; }
        .collapsed .toggle-icon { transform: rotate(-90deg); }
        
        .block-body { display: block; }
        .collapsed .block-body { display: none !important; }
        
        .collapsed-summary { font-family: monospace; font-weight: normal; color: #555; font-size: 0.85rem; margin-left: 15px; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; display: none; border: 1px solid rgba(0,0,0,0.1); }
        .collapsed .collapsed-summary { display: inline-block; }

        .empty-state { border: 2px dashed #ccc; border-radius: 6px; padding: 15px; text-align: center; color: #888; font-size: 0.9rem; background: rgba(255,255,255,0.5); margin: 10px 0; }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); }
        .input-grid label { font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; color: #555; display: block; }
        
        .preview-wrapper { display: flex; align-items: center; background: white; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px; margin-bottom: 10px; overflow: hidden; position: relative; }
        .preview-box { font-family: monospace; font-size: 0.85rem; color: #333; padding: 8px; flex-grow: 1; border: none; background: transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-copy-preview { background: #f1f1f1; border: none; border-left: 1px solid #ccc; color: #555; cursor: pointer; padding: 0 12px; height: 32px; font-size: 0.9rem; transition: 0.2s; }
        .btn-copy-preview:hover { background: #e2e2e2; color: #000; }
        
        .char-count {
            font-size: 0.7rem; color: #999; padding: 0 8px;
            border-left: 1px solid #eee; display: flex; align-items: center; height: 32px;
            background: #fafafa;
        }

        /* UTILS */
        .top-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; min-width: 150px; flex-grow: 1; }
        .input-group label { font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; color: #555; display: block; }
        .custom-adder-wrapper { margin-left:auto; border-left:1px solid #ddd; padding-left:20px; min-width: 350px; display: flex; flex-direction: column; }
        .custom-adder-wrapper label { font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; color: #555; display: block; }
        
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        /* Buttons */
        .btn { cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-add-main { background: var(--camp-border); color: white; font-size: 1rem; padding: 10px 20px; }
        .btn-add-main:hover { background: #357ae8; }
        
        .btn-add-sub { background: white; border: 1px dashed var(--adg-border); color: var(--adg-border); width: 100%; }
        .btn-add-sub:hover { background: var(--adg-bg); border-style: solid; }
        
        .btn-add-cr { background: white; border: 1px dashed var(--cr-border); color: var(--cr-border); font-size: 0.8rem; width: 100%; }
        .btn-add-cr:hover { background: var(--cr-bg); border-style: solid; }
        
        /* ACTION BUTTONS (Text Style) */
        .btn-text-action {
            background: white; border: 1px solid #ccc; color: #555; 
            padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; 
            cursor: pointer; margin-left: 5px; font-weight: normal;
            transition: 0.2s;
        }
        .btn-text-action:hover { background: #f0f0f0; border-color: #999; color: #333; }
        .btn-text-delete { color: #e74c3c; border-color: #fadbd8; }
        .btn-text-delete:hover { background: #fdedec; border-color: #e74c3c; }
        
        /* Highlighted Action (Copy) */
        .btn-text-copy-data { color: #f39c12; border-color: #fcd596; }
        .btn-text-copy-data:hover { background: #fef9e7; border-color: #f39c12; }

        /* PASTE BUTTONS */
        .btn-paste { 
            background: white; border: 1px solid #f39c12; color: #f39c12; 
            margin-left: 10px; opacity: 0.5; cursor: not-allowed; font-size: 0.75rem;
            padding: 4px 8px; border-radius: 4px; font-weight: normal; transition: 0.2s;
        }
        .btn-paste.enabled { opacity: 1; cursor: pointer; background: #fef9e7; }
        .btn-paste.enabled:hover { background: #f39c12; color: white; }
        
        .btn-download { background: #27ae60; color: white; font-size: 0.9rem; display: inline-block; text-decoration: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; border: none; margin-right: 10px;}
        .btn-download:hover { background: #219150; }
        .btn-download-master { background: var(--dark); color: white; font-size: 1rem; padding: 12px 20px; width: 100%; margin-bottom: 15px; }
        .btn-download-master:hover { background: #1a252f; }
        
        /* PLATFORM EXPORT BUTTONS */
        .btn-download-meta { background: var(--meta-blue); color: white; font-size: 0.9rem; padding: 10px 20px; border-radius: 4px; cursor: pointer; border: none; display: inline-block; text-decoration: none; margin-right: 10px; }
        .btn-download-meta:hover { background: #0456be; }
        .btn-download-reddit { background: #FF4500; color: white; font-size: 0.9rem; padding: 10px 20px; border-radius: 4px; cursor: pointer; border: none; display: inline-block; text-decoration: none; margin-right: 10px; }
        .btn-download-reddit:hover { background: #cc3700; }

        .warning-box { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 15px; border-radius: 6px; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }

        /* Influencer / UTM Styles */
        .table-wrapper { overflow-x: auto; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; min-width: 1200px; table-layout: fixed; }
        th { text-align: left; font-size: 0.8rem; font-weight: bold; color: #555; padding: 10px; background: transparent; border-bottom: 2px solid #ddd; white-space: nowrap; vertical-align: middle; }
        td { padding: 8px; vertical-align: top; border-bottom: 1px solid #eee; word-wrap: break-word; }
        td:last-child { white-space: nowrap; }
        
        .base-input-box { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 30px; }
        .base-url-input { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--primary); border-radius: 6px; }
        .utm-link-box { background: #f4f4f4; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.75rem; color: #555; border: 1px solid #ddd; word-break: break-all; white-space: normal; }
        .utm-link-box a { color: var(--primary); }
        .btn-copy { background: #333; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-shorten { background: var(--dark); color: white; border: none; padding: 5px 10px; font-size: 0.75rem; border-radius: 3px; cursor: pointer; margin-top: 5px; width: 100%; }
        .btn-remove { background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; margin-left: 5px; }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .tooltip-wrapper { display: flex; align-items: center; gap: 5px; cursor: help; position: relative; width: 100%; }
        .info-icon { display: inline-block; width: 16px; height: 16px; background: #ccc; color: white; border-radius: 50%; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold; }
        .tooltip-text { visibility: hidden; width: 250px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 100; right: 0; top: 140%; opacity: 0; transition: opacity 0.3s; font-weight: normal; font-size: 0.75rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2); line-height: 1.4; white-space: normal; }
        .tooltip-wrapper:hover .tooltip-text { visibility: visible; opacity: 1; }
        .fill-down-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #eee; border: 1px solid #ccc; color: #555; cursor: pointer; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; }
        .fill-down-btn:hover { background: #ddd; color: #000; }
        
        h2 { color: var(--primary); margin-top: 0; margin-bottom: 20px; }
        
        .btn-wrapper { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <div class="header-branding">
            <a href="#" class="logo-link" onclick="switchView('dashboard'); return false;">
                <img src="https://tracks.secondstage.io/vite/assets/tracks-signup-logo-J-NQw5DE.png" alt="TRACKS Logo" class="header-logo">
            </a>
            <h1>Ad Ops Suite</h1>
        </div>
        <div class="nav-home" id="nav-home" onclick="switchView('dashboard')"><span>&larr; Back to Home</span></div>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="color:#333; font-size: 2rem;">Welcome to Ad Ops Helper</h2>
            <p style="color:#666;">Select a tool to get started.</p>
        </div>
        <div class="dashboard-grid">
            <div class="tool-card" onclick="switchView('wizard')"><div class="card-icon">‚ö°</div><div class="card-title">Ad Ops Wizard</div><div class="card-desc">Tree-based generator for Campaigns, Ad Groups, and Creatives.</div></div>
            <div class="tool-card" onclick="switchView('utm')"><div class="card-icon">üîó</div><div class="card-title">UTM Link Builder</div><div class="card-desc">Generate tracking links for paid media channels.</div></div>
            <div class="tool-card" onclick="switchView('influencer')"><div class="card-icon">ü§≥</div><div class="card-title">Influencer Link Builder</div><div class="card-desc">Generate specific tracking links for Influencers and Creators.</div></div>
        </div>
    </div>

    <div id="view-wizard" class="view-section">
        <h2>Ad Ops Wizard</h2>
        
        <div class="guide-box">
            <div class="guide-step"><div class="guide-icon">üèóÔ∏è</div><div class="guide-text"><strong>Build Structure</strong><br>Add Campaigns, nest Ad Groups inside them, and Creatives inside Ad Groups.</div></div>
            <div class="guide-step"><div class="guide-icon">üìÑ</div><div class="guide-text"><strong>Duplicate</strong><br>Use the duplicate button in headers to clone blocks immediately.</div></div>
            <div class="guide-step"><div class="guide-icon">üìã</div><div class="guide-text"><strong>Copy & Paste</strong><br>Use Copy Ad Group / Copy Creative to store a block, then Paste it.</div></div>
            <div class="guide-step"><div class="guide-icon">üì•</div><div class="guide-text"><strong>Export</strong><br>Download full CSVs at the bottom for platform upload.</div></div>
        </div>

        <div class="top-bar">
            <div class="input-group"><label>Project Code</label><input type="text" id="g_project" value="2s" oninput="updateAllPreviews()"></div>
            <div class="input-group"><label>Beat / Phase</label><input type="text" id="g_phase" value="Update_251125" oninput="updateAllPreviews()"></div>
            <div class="custom-adder-wrapper">
                 <label>Quick Add Custom Option</label>
                 <div style="display:flex; gap:5px;">
                     <select id="custom_cat" style="width: 40%;">
                         <optgroup label="Campaign Level">
                             <option value="platforms">Platform</option>
                             <option value="strategies">Strategy</option>
                             <option value="objectives">Objective</option>
                         </optgroup>
                         <optgroup label="Ad Group Level">
                             <option value="audiences">Audience</option>
                             <option value="audTypes">Audience Type</option>
                         </optgroup>
                         <optgroup label="Creative Level">
                             <option value="formats">Format</option>
                             <option value="lps">Landing Page</option>
                         </optgroup>
                     </select>
                     <input type="text" id="custom_val" placeholder="New Value..." style="width: 40%;">
                     <button onclick="addCustom('custom_cat', 'custom_val')" style="background:#27ae60; color:white; border:none; border-radius:3px; width: 20%; font-weight: bold;">Add +</button>
                 </div>
            </div>
        </div>

        <div id="tree-root" class="tree-container"></div>
        <button class="btn btn-add-main" onclick="addCampaignBlock()">+ Add New Campaign</button>

        <div class="warning-box">
            <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
            <div style="width:100%;">
                <strong>Export Data:</strong>
                <div style="margin-top:15px;">
                    <button class="btn btn-download-master" onclick="exportTree('master')">üì• Download Master Flat File (All Levels)</button>
                    
                    <div style="border-top: 1px solid #e6cd96; padding-top: 10px; margin-top: 10px; font-size: 0.9rem;">
                        <span style="margin-right: 10px; font-weight:bold;">Separate Levels:</span>
                        <button class="btn-download" onclick="exportTree('camp')">Campaigns</button>
                        <button class="btn-download" onclick="exportTree('adg')">Ad Groups</button>
                        <button class="btn-download" onclick="exportTree('cr')">Creatives</button>
                    </div>

                    <div style="border-top: 1px solid #e6cd96; padding-top: 10px; margin-top: 10px; font-size: 0.9rem;">
                        <span style="margin-right: 10px; font-weight:bold;">Platform Imports:</span>
                        <button class="btn-download-meta" onclick="exportMeta()">Meta</button>
                        <button class="btn-download-reddit" onclick="exportReddit()">Reddit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-utm" class="view-section">
        <h2>UTM Link Builder</h2>
        <div class="base-input-box">
            <label style="font-weight:bold; display:block; margin-bottom:10px;">Paste Destination URL (Landing Page):</label>
            <input type="text" id="utm-base-url" class="base-url-input" value="https://secondstage.io" oninput="generateUTMs()">
        </div>
        <div class="table-wrapper"><table class="utm-table"><thead><tr><th style="width: 20%;">Platform</th><th>Generated Tracking Link</th><th style="width: 8%;">Action</th></tr></thead><tbody id="utm-tbody"></tbody></table></div>
    </div>

    <div id="view-influencer" class="view-section">
        <h2>Influencer Link Builder</h2>
        <div class="top-bar">
            <div class="input-group"><label>Game</label><input type="text" id="inf_project" value="" placeholder="Enter Game Name" oninput="updateInfTable()"></div>
            <div class="input-group"><label>Beat / Phase</label><input type="text" id="inf_phase" value="Update" oninput="updateInfTable()"></div>
            <div class="input-group" style="flex-grow: 2;"><label>Destination URL</label><input type="text" id="inf_dest" value="https://secondstage.io" oninput="updateInfTable()"></div>
            <div class="custom-adder-wrapper">
                 <label>Quick Add Custom Option</label>
                 <div style="display:flex; gap:5px;">
                     <select id="inf_custom_cat" style="width: 40%;"><option value="inf_langs">Language</option><option value="inf_plats">Platform</option><option value="inf_types">Content Type</option><option value="inf_personas">Persona</option></select>
                     <input type="text" id="inf_custom_val" placeholder="New Value..." style="width: 40%;">
                     <button onclick="addCustom('inf_custom_cat', 'inf_custom_val')" style="background:#27ae60; color:white; border:none; border-radius:3px; width: 20%; font-weight: bold;">Add +</button>
                 </div>
            </div>
        </div>
        <div class="table-wrapper">
        <table id="table-inf">
            <thead><tr>
                <th style="width:10%">Creator <button class="fill-down-btn" onclick="fillDown('table-inf', 0)">‚¨áÔ∏è</button></th>
                <th style="width:6%">Language <button class="fill-down-btn" onclick="fillDown('table-inf', 1)">‚¨áÔ∏è</button></th>
                <th style="width:8%">Platform <button class="fill-down-btn" onclick="fillDown('table-inf', 2)">‚¨áÔ∏è</button></th>
                <th style="width:7%">Type <button class="fill-down-btn" onclick="fillDown('table-inf', 3)">‚¨áÔ∏è</button></th>
                <th style="width:8%">Persona <button class="fill-down-btn" onclick="fillDown('table-inf', 4)">‚¨áÔ∏è</button></th>
                <th style="width:10%">Date <button class="fill-down-btn" onclick="fillDown('table-inf', 5)">‚¨áÔ∏è</button></th>
                <th style="width:10%">Short Key</th>
                <th>Generated Long Link</th>
                <th style="width:10%">Short Link</th>
                <th style="width:5%"></th>
            </tr></thead>
            <tbody></tbody>
        </table>
        </div>
        <button class="btn btn-add" onclick="addInfRow()">+ Add Creator Row</button>
    </div>

</div>

<div id="toast">Copied to Clipboard</div>

<script>
    // --- GLOBAL NAV ---
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-home').style.display = viewName === 'dashboard' ? 'none' : 'flex';
        if (viewName === 'dashboard') document.getElementById('view-dashboard').classList.add('active');
        else if (viewName === 'wizard') {
            document.getElementById('view-wizard').classList.add('active');
            if(document.getElementById('tree-root').children.length === 0) addCampaignBlock(); 
        }
        else if (viewName === 'utm') { document.getElementById('view-utm').classList.add('active'); generateUTMs(); }
        else if (viewName === 'influencer') {
            document.getElementById('view-influencer').classList.add('active');
            if(document.querySelector('#table-inf tbody').children.length === 0) addInfRow();
        }
    }

    // --- DATA ---
    const DEFAULTS = {
        platforms: ["GoogleSearch", "YouTube", "Meta", "Reddit", "TikTok", "DisplayVideo360", "X"],
        tiers: ["T1", "T2", "T3", "Global", "RoW"],
        strategies: ["Awareness", "Consideration", "Conversion", "Retention"],
        objectives: ["Traffic", "Reach", "Views", "AppInstall", "Purchase"],
        audiences: ["Core", "Secondary", "Aspirational", "Broad", "Mainstream", "Lookalike", "Retargeting"],
        audTypes: ["Prospecting", "Retargeting", "Retention"],
        formats: ["Video", "Static", "Carousel", "Collection", "HTML5"],
        lps: ["Website", "Steam", "Epic", "PS_Store"],
        inf_langs: ["EN","DE","FR","ES","IT","PT","PL"],
        inf_plats: ["YouTube","Twitch","TikTok","Instagram","X","Kick"],
        inf_types: ["VOD","Stream","Short","Post","Story"],
        inf_personas: ["Creator","Influencer","Ambassador","Partner"]
    };
    let lists = JSON.parse(JSON.stringify(DEFAULTS));
    let appClipboard = { type: null, data: null };

    window.onload = function() {
        const saved = localStorage.getItem('adOpsWizardLists');
        if(saved) lists = { ...DEFAULTS, ...JSON.parse(saved) };
        switchView('dashboard'); 
    };

    // ============================================================
    //  TREE BUILDER LOGIC (V47 Core)
    // ============================================================
    
    function addCampaignBlock() {
        const div = document.createElement('div');
        div.className = 'block-campaign';
        div.innerHTML = `
            <div class="block-header-camp" onclick="toggleBlock(this)">
                <div>
                    <span class="camp-label"><span class="toggle-icon">‚ñº</span> Campaign Level</span>
                    <span class="collapsed-summary"></span>
                </div>
                <div onclick="event.stopPropagation()">
                    <button class="btn-text-action" onclick="duplicateBlock(this, 'camp')">Duplicate Campaign</button>
                    <button class="btn-text-action btn-text-delete" onclick="removeBlock(this, 'camp')">Delete</button>
                </div>
            </div>
            <div class="block-body">
                <div class="input-grid">
                    <div><label>Platform</label>${createSelectHTML(lists.platforms, 'c-plat', 'platforms')}</div>
                    <div><label>Tier</label>${createSelectHTML(lists.tiers, 'c-tier', 'tiers')}</div>
                    <div><label>Geos</label><input type="text" class="c-geo" placeholder="UK, DE" oninput="updateBlockPreview(this)"></div>
                    <div><label>Strategy</label>${createSelectHTML(lists.strategies, 'c-strat', 'strategies')}</div>
                    <div><label>Objective</label>${createSelectHTML(lists.objectives, 'c-obj', 'objectives')}</div>
                    <div><label>Start Date</label><input type="date" class="c-date" value="${new Date().toISOString().split('T')[0]}" oninput="updateBlockPreview(this)"></div>
                    <div><label>Placeholder</label><input type="text" class="c-cust" placeholder="Optional" oninput="updateBlockPreview(this)"></div>
                </div>
                <div class="preview-wrapper">
                    <div class="preview-box preview-camp">...</div>
                    <span class="char-count">0 chars</span>
                    <button class="btn-copy-preview" onclick="copyPreview(this)" title="Copy Name">Copy Name</button>
                </div>
                <div class="tree-line-camp">
                    <div class="adgroups-container"><div class="empty-state">‚ö¨ No Ad Groups yet.</div></div>
                    <div class="btn-wrapper">
                        <button class="btn btn-add-sub" onclick="addAdGroupBlock(this)">+ Add Ad Group</button>
                        <button class="btn btn-paste btn-paste-adg" onclick="pasteBlock(this, 'adg')">Paste Ad Group</button>
                    </div>
                </div>
            </div>`;
        document.getElementById('tree-root').appendChild(div);
        updateBlockPreview(div.querySelector('input'));
        updatePasteButtons();
    }

    function addAdGroupBlock(btn) {
        const parentContainer = btn.closest('.tree-line-camp').querySelector('.adgroups-container');
        const empty = parentContainer.querySelector('.empty-state'); if(empty) empty.remove();
        
        const div = document.createElement('div');
        div.className = 'block-adgroup';
        div.innerHTML = `
            <div class="block-header-adg" onclick="toggleBlock(this)">
                <div>
                    <span class="adg-label"><span class="toggle-icon">‚ñº</span> Ad Group Level</span>
                    <span class="collapsed-summary"></span>
                </div>
                <div onclick="event.stopPropagation()">
                    <button class="btn-text-action btn-text-copy-data" onclick="copyStructure(this, 'adg')">Copy Ad Group</button>
                    <button class="btn-text-action" onclick="duplicateBlock(this, 'adg')">Duplicate Ad Group</button>
                    <button class="btn-text-action btn-text-delete" onclick="removeBlock(this, 'adg')">Delete</button>
                </div>
            </div>
            <div class="block-body">
                <div class="input-grid">
                    <div><label>Geo (Auto)</label><input type="text" class="g-geo" placeholder="Inherited" readonly style="background:#eee;"></div>
                    <div><label>Audience</label>${createSelectHTML(lists.audiences, 'g-aud', 'audiences')}</div>
                    <div><label>Type</label>${createSelectHTML(lists.audTypes, 'g-type', 'audTypes')}</div>
                    <div><label>Placeholder</label><input type="text" class="g-cust" oninput="updateBlockPreview(this)"></div>
                </div>
                <div class="preview-wrapper">
                    <div class="preview-box preview-adg">...</div>
                    <span class="char-count">0 chars</span>
                    <button class="btn-copy-preview" onclick="copyPreview(this)" title="Copy Name">Copy Name</button>
                </div>
                <div class="tree-line-adg">
                    <div class="creatives-container"><div class="empty-state" style="font-size:0.8rem; padding:10px;">‚ö¨ No Creatives.</div></div>
                    <div class="btn-wrapper">
                        <button class="btn btn-add-cr" onclick="addCreativeRowTree(this)">+ Add Creative</button>
                        <button class="btn btn-paste btn-paste-cr" onclick="pasteBlock(this, 'cr')">Paste Creative</button>
                    </div>
                </div>
            </div>`;
        parentContainer.appendChild(div);
        updateBlockPreview(div.querySelector('input'));
        updatePasteButtons();
        return div;
    }

    function addCreativeRowTree(btn) {
        const parentContainer = btn.closest('.tree-line-adg').querySelector('.creatives-container');
        const empty = parentContainer.querySelector('.empty-state'); if(empty) empty.remove();

        const div = document.createElement('div');
        div.className = 'block-creative';
        div.innerHTML = `
            <div class="block-header-cr" onclick="toggleBlock(this)">
                <div>
                    <span class="cr-label"><span class="toggle-icon">‚ñº</span> Creative Level</span>
                    <span class="collapsed-summary"></span>
                </div>
                <div onclick="event.stopPropagation()">
                    <button class="btn-text-action btn-text-copy-data" onclick="copyStructure(this, 'cr')">Copy Creative</button>
                    <button class="btn-text-action" onclick="duplicateBlock(this, 'cr')">Duplicate Creative</button>
                    <button class="btn-text-action btn-text-delete" onclick="removeBlock(this, 'cr')">Delete</button>
                </div>
            </div>
            <div class="block-body">
                <div class="input-grid">
                    <div><label>Format</label>${createSelectHTML(lists.formats, 'cr-fmt', 'formats')}</div>
                    <div><label>Dims</label><input type="text" class="cr-dim" placeholder="1920x1080" oninput="updateBlockPreview(this)"></div>
                    <div><label>LP</label>${createSelectHTML(lists.lps, 'cr-lp', 'lps')}</div>
                    <div><label>Ver</label><input type="text" class="cr-ver" value="v1" oninput="updateBlockPreview(this)"></div>
                    <div><label>Len</label><input type="text" class="cr-len" placeholder="15s" oninput="updateBlockPreview(this)"></div>
                    <div><label>Custom</label><input type="text" class="cr-cust" oninput="updateBlockPreview(this)"></div>
                </div>
                <div class="preview-wrapper">
                    <div class="preview-box preview-cr">...</div>
                    <span class="char-count">0 chars</span>
                    <button class="btn-copy-preview" onclick="copyPreview(this)" title="Copy Name">Copy Name</button>
                </div>
            </div>`;
        parentContainer.appendChild(div);
        updateBlockPreview(div.querySelector('input'));
        return div;
    }

    function createSelectHTML(opts, cls, cat) {
        let h = `<select class="${cls}" data-cat="${cat}" onchange="updateBlockPreview(this)"><option value="" disabled selected>Select...</option>`;
        opts.forEach(o => h += `<option value="${o}">${o}</option>`);
        h += `</select>`;
        return h;
    }

    function toggleBlock(header) { 
        let parent = header.parentElement;
        while(parent && !parent.className.includes('block-')) { parent = parent.parentElement; }
        if(parent) parent.classList.toggle('collapsed');
    }

    // FIX: STRICT DELETE LOGIC (V47)
    function removeBlock(btn, type) {
        if(!confirm("Delete this item?")) return;
        
        // Strict check based on type passed from button
        let selector = "";
        if(type === 'camp') selector = '.block-campaign';
        else if(type === 'adg') selector = '.block-adgroup';
        else if(type === 'cr') selector = '.block-creative';
        
        if(selector) {
            const block = btn.closest(selector);
            if(block) block.remove();
        }
    }

    function duplicateBlock(btn, type) {
        let block;
        if(type === 'camp') block = btn.closest('.block-campaign');
        else if(type === 'adg') block = btn.closest('.block-adgroup');
        else if(type === 'cr') block = btn.closest('.block-creative');
        
        if(block) {
            const clone = block.cloneNode(true);
            clone.classList.remove('collapsed');
            block.parentNode.insertBefore(clone, block.nextSibling);
            const origSelects = block.querySelectorAll('select');
            const cloneSelects = clone.querySelectorAll('select');
            origSelects.forEach((s, i) => cloneSelects[i].value = s.value);
            clone.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', function() { updateBlockPreview(this); });
                el.addEventListener('change', function() { updateBlockPreview(this); });
            });
            updateBlockPreview(clone.querySelector('input'));
        }
    }

    // --- COPY & PASTE ---
    function copyStructure(btn, type) {
        const block = btn.closest(type === 'adg' ? '.block-adgroup' : '.block-creative');
        if(!block) return;
        
        if(type === 'adg') {
            const data = {
                values: getAdgValues(block),
                children: []
            };
            block.querySelectorAll('.block-creative').forEach(cr => {
                data.children.push(getCrValues(cr));
            });
            appClipboard = { type: 'adg', data: data };
            showToast("Ad Group Copied!");
        } else {
            const data = getCrValues(block);
            appClipboard = { type: 'cr', data: data };
            showToast("Creative Copied!");
        }
        updatePasteButtons();
    }

    function pasteBlock(btn, type) { 
        if(!appClipboard.data || appClipboard.type !== type) return;
        
        if(type === 'adg') {
            const newBlock = addAdGroupBlock(btn);
            setInputs(newBlock, appClipboard.data.values);
            const creativeBtn = newBlock.querySelector('.btn-add-cr');
            appClipboard.data.children.forEach(crData => {
                const newCr = addCreativeRowTree(creativeBtn);
                setInputs(newCr, crData);
            });
            updateBlockPreview(newBlock.querySelector('input'));
        } 
        else if (type === 'cr') {
            const newBlock = addCreativeRowTree(btn);
            setInputs(newBlock, appClipboard.data);
            updateBlockPreview(newBlock.querySelector('input'));
        }
    }

    function setInputs(block, dataValues) {
        for (const [key, val] of Object.entries(dataValues)) {
            let input = block.querySelector(`.g-${key}`);
            if(!input) input = block.querySelector(`.cr-${key}`);
            if(input) input.value = val;
        }
    }

    function updatePasteButtons() {
        document.querySelectorAll('.btn-paste-adg').forEach(b => {
            if(appClipboard.type === 'adg') b.classList.add('enabled'); else b.classList.remove('enabled');
        });
        document.querySelectorAll('.btn-paste-cr').forEach(b => {
            if(appClipboard.type === 'cr') b.classList.add('enabled'); else b.classList.remove('enabled');
        });
    }

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- PREVIEWS & EXPORT ---
    function updateBlockPreview(el) {
        const gProj = document.getElementById('g_project').value.trim();
        const gPhase = document.getElementById('g_phase').value.trim();
        if(el.id === 'g_project' || el.id === 'g_phase') { updateAllPreviews(); return; }

        const campBlock = el.closest('.block-campaign');
        if(!campBlock) return;

        const cPlat = campBlock.querySelector('.c-plat').value || "Plat";
        const cGeoRaw = campBlock.querySelector('.c-geo').value || "GEO";
        const cFirstGeo = cGeoRaw.split(',')[0].trim();
        const cStrat = campBlock.querySelector('.c-strat').value || "Strat";
        const cObj = campBlock.querySelector('.c-obj').value || "Obj";
        const cDate = formatAdOpsDate(campBlock.querySelector('.c-date').value);
        const cCust = campBlock.querySelector('.c-cust').value;
        
        const campName = `${gProj}-${cPlat}-${cFirstGeo}-${gPhase}_${cDate}-${cStrat}_${cObj}${cCust ? '_'+cCust : ''}`;
        updatePreviewText(campBlock, '.preview-camp', campName);

        campBlock.querySelectorAll('.block-adgroup').forEach(adg => {
            adg.querySelector('.g-geo').value = cFirstGeo; 
            const gAud = adg.querySelector('.g-aud').value || "Aud";
            const gType = adg.querySelector('.g-type').value || "Type";
            const gCust = adg.querySelector('.g-cust').value;
            const adgName = `${cFirstGeo}-${gAud}_${gType}${gCust ? '_'+gCust : ''}`;
            updatePreviewText(adg, '.preview-adg', adgName);

            adg.querySelectorAll('.block-creative').forEach(cr => {
                const crFmt = cr.querySelector('.cr-fmt').value || "Fmt";
                const crDim = cr.querySelector('.cr-dim').value || "Dim";
                const crLp = cr.querySelector('.cr-lp').value || "LP";
                const crVer = cr.querySelector('.cr-ver').value || "v1";
                const crLen = cr.querySelector('.cr-len').value || "Len";
                const crCust = cr.querySelector('.cr-cust').value;
                const parts = [cFirstGeo, crFmt, crDim, gPhase, crLp, crVer, crLen];
                if(crCust) parts.push(crCust);
                updatePreviewText(cr, '.preview-cr', parts.join('-'));
            });
        });
    }
    
    function updatePreviewText(block, selector, text) {
        block.querySelector(selector).innerText = text;
        const summary = block.querySelector('.collapsed-summary');
        if(summary) summary.innerText = text;
        const charCount = block.querySelector('.char-count');
        if(charCount) charCount.innerText = `${text.length} chars`;
    }

    function updateAllPreviews() { document.querySelectorAll('.block-campaign').forEach(c => updateBlockPreview(c.querySelector('input'))); }

    function copyPreview(btn) {
        const text = btn.previousElementSibling.previousElementSibling.innerText;
        navigator.clipboard.writeText(text).then(() => {
            btn.innerText = "‚úì"; btn.style.color = "green";
            setTimeout(() => { btn.innerText = "Copy Name"; btn.style.color = "#555"; }, 1500);
        });
    }

    // --- EXPORT ---
    function exportTree(type) {
        const gProj = document.getElementById('g_project').value.trim();
        const gPhase = document.getElementById('g_phase').value.trim();
        let csv = "";

        if(type === 'master') {
            csv = "Project,Phase,Platform,Tier,Geos,Strategy,Objective,Date,Camp_Custom,Campaign Name,AdGroup_Geo,Audience,Aud_Type,AdGroup_Custom,Ad Group Name,Format,Dim,LP,Ver,Len,Creative_Custom,Creative Name\n";
            document.querySelectorAll('.block-campaign').forEach(camp => {
                const c = getCampValues(camp);
                const campNameBase = `${gProj}-${c.plat}-{{GEO}}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;
                c.geos.forEach(geo => {
                    const finalCampName = campNameBase.replace('{{GEO}}', geo);
                    const adGroups = camp.querySelectorAll('.block-adgroup');
                    if(adGroups.length === 0) {
                        csv += `${gProj},${gPhase},${c.plat},${c.tier},${geo},${c.strat},${c.obj},${c.dateRaw},${c.cust},${finalCampName},,,,,,,,,,,\n`;
                    } else {
                        adGroups.forEach(adg => {
                            const a = getAdgValues(adg);
                            const adgName = `${geo}-${a.aud}_${a.type}${a.cust ? '_'+a.cust : ''}`;
                            const creatives = adg.querySelectorAll('.block-creative');
                            if(creatives.length === 0) {
                                csv += `${gProj},${gPhase},${c.plat},${c.tier},${geo},${c.strat},${c.obj},${c.dateRaw},${c.cust},${finalCampName},${geo},${a.aud},${a.type},${a.cust},${adgName},,,,,,,,\n`;
                            } else {
                                creatives.forEach(cr => {
                                    const r = getCrValues(cr);
                                    const parts = [geo, r.fmt, r.dim, gPhase, r.lp, r.ver, r.len];
                                    if(r.cust) parts.push(r.cust);
                                    const crName = parts.join('-');
                                    csv += `${gProj},${gPhase},${c.plat},${c.tier},${geo},${c.strat},${c.obj},${c.dateRaw},${c.cust},${finalCampName},${geo},${a.aud},${a.type},${a.cust},${adgName},${r.fmt},${r.dim},${r.lp},${r.ver},${r.len},${r.cust},${crName}\n`;
                                });
                            }
                        });
                    }
                });
            });
        }
        else if(type === 'camp') {
            csv = "Project,Phase,Platform,Tier,Geos,Strategy,Objective,Date,Custom,Campaign Name\n";
            document.querySelectorAll('.block-campaign').forEach(camp => {
                const c = getCampValues(camp);
                const nameBase = `${gProj}-${c.plat}-{{GEO}}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;
                c.geos.forEach(geo => {
                    csv += `${gProj},${gPhase},${c.plat},${c.tier},${geo},${c.strat},${c.obj},${c.dateRaw},${c.cust},${nameBase.replace('{{GEO}}', geo)}\n`;
                });
            });
        }
        else if(type === 'adg') {
            csv = "Campaign Name,Geo,Audience,Type,Custom,Ad Group Name\n";
            document.querySelectorAll('.block-campaign').forEach(camp => {
                const c = getCampValues(camp);
                camp.querySelectorAll('.block-adgroup').forEach(adg => {
                    const a = getAdgValues(adg);
                    c.geos.forEach(geo => {
                        const campName = `${gProj}-${c.plat}-${geo}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;
                        const adgName = `${geo}-${a.aud}_${a.type}${a.cust ? '_'+a.cust : ''}`;
                        csv += `${campName},${geo},${a.aud},${a.type},${a.cust},${adgName}\n`;
                    });
                });
            });
        }
        else if(type === 'cr') {
            csv = "Camp Ref,Geo,Format,Dim,Phase,LP,Ver,Len,Custom,Creative Name\n";
            document.querySelectorAll('.block-campaign').forEach(camp => {
                const c = getCampValues(camp);
                camp.querySelectorAll('.block-adgroup').forEach(adg => {
                    adg.querySelectorAll('.block-creative').forEach(cr => {
                        const r = getCrValues(cr);
                        c.geos.forEach(geo => {
                            const campName = `${gProj}-${c.plat}-${geo}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;
                            const parts = [geo, r.fmt, r.dim, gPhase, r.lp, r.ver, r.len];
                            if(r.cust) parts.push(r.cust);
                            csv += `${campName},${geo},${r.fmt},${r.dim},${gPhase},${r.lp},${r.ver},${r.len},${r.cust},${parts.join('-')}\n`;
                        });
                    });
                });
            });
        }

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Export_${type}.csv`; link.click();
    }

    function getCampValues(el) {
        return {
            plat: el.querySelector('.c-plat').value, tier: el.querySelector('.c-tier').value,
            geos: el.querySelector('.c-geo').value.split(',').map(s=>s.trim()).filter(s=>s),
            strat: el.querySelector('.c-strat').value, obj: el.querySelector('.c-obj').value,
            dateRaw: el.querySelector('.c-date').value, dateStr: formatAdOpsDate(el.querySelector('.c-date').value),
            cust: el.querySelector('.c-cust').value.trim()
        };
    }
    function getAdgValues(el) { return { aud: el.querySelector('.g-aud').value, type: el.querySelector('.g-type').value, cust: el.querySelector('.g-cust').value.trim() }; }
    function getCrValues(el) {
        return {
            fmt: el.querySelector('.cr-fmt').value, dim: el.querySelector('.cr-dim').value, lp: el.querySelector('.cr-lp').value,
            ver: el.querySelector('.cr-ver').value, len: el.querySelector('.cr-len').value, cust: el.querySelector('.cr-cust').value.trim()
        };
    }

    function formatAdOpsDate(ds) { if(!ds) return ""; const d = new Date(ds); return `${d.getFullYear().toString().substr(-2)}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`; }
    
    function addCustom(catId, valId) {
        const cat = document.getElementById(catId).value;
        const val = document.getElementById(valId).value.trim();
        if(val && !lists[cat].includes(val)) {
            lists[cat].push(val);
            localStorage.setItem('adOpsWizardLists', JSON.stringify(lists));
            document.querySelectorAll(`select[data-cat="${cat}"]`).forEach(sel => { sel.innerHTML += `<option value="${val}">${val}</option>`; });
            document.getElementById(valId).value = ''; 
        }
    }
    
    // --- FILL DOWN FOR INFLUENCER TABLE ---
    function fillDown(tableId, colIndex) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        if (rows.length < 2) return;
        const firstVal = rows[0].querySelectorAll('input, select')[colIndex].value;
        for (let i = 1; i < rows.length; i++) {
            rows[i].querySelectorAll('input, select')[colIndex].value = firstVal;
        }
        updateInfTable();
    }

    // META EXPORT
    function exportMeta() {
        const gProj = document.getElementById('g_project').value.trim();
        const gPhase = document.getElementById('g_phase').value.trim();
        const headers = ['Campaign ID', 'Campaign Name', 'Campaign Status', 'Special Ad Categories', 'Special Ad Category Country', 'Campaign Objective', 'Buying Type', 'Campaign Spend Limit', 'Campaign Daily Budget', 'Campaign Lifetime Budget', 'Campaign Bid Strategy', 'Tags', 'Campaign Is Using L3 Schedule', 'Campaign Start Time', 'Campaign Stop Time', 'Ad Set ID', 'Ad Set Run Status', 'Ad Set Name', 'Ad Set Time Start', 'Ad Set Time Stop', 'Ad Set Daily Budget', 'Ad Set Lifetime Budget', 'Link Object ID', 'Link', 'Application ID', 'Countries', 'Global Regions', 'Excluded Global Regions', 'Cities', 'Regions', 'Zip', 'Gender', 'Age Min', 'Age Max', 'Education Status', 'College Start Year', 'College End Year', 'Interested In', 'Relationship', 'Connections', 'Excluded Connections', 'Friends of Connections', 'Locales', 'Broad Category Clusters', 'Custom Audiences', 'Excluded Custom Audiences', 'Location Cluster IDs', 'Excluded Location Cluster IDs', 'Publisher Platforms', 'Device Platforms', 'Facebook Positions', 'Instagram Positions', 'Oculus Positions', 'Audience Network Positions', 'Optimization Goal', 'Billing Event', 'Bid Amount', 'Ad Set Bid Strategy', 'Beneficiary (financial ads in Taiwan)', 'Payer (financial ads in Taiwan)', 'Beneficiary (Taiwan)', 'Payer (Taiwan)', 'Beneficiary (financial ads in Australia)', 'Payer (financial ads in Australia)', 'Beneficiary (Singapore)', 'Payer (Singapore)', 'Minimum ROAS', 'Ad Set Minimum Spend Limit', 'Ad Set Maximum Spend Limit', 'Beneficiary (securities ads in India)', 'Payer (securities ads in India)', 'Beneficiary (selected locations)', 'Payer (selected locations)', 'Large Geo Areas', 'Excluded Large Geo Areas', 'Medium Geo Areas', 'Excluded Medium Geo Areas', 'Small Geo Areas', 'Excluded Small Geo Areas', 'Metro Areas', 'Excluded Metro Areas', 'Subcities', 'Excluded Subcities', 'Neighborhoods', 'Excluded Neighborhoods', 'Subneighborhoods', 'Excluded Subneighborhoods', 'Ad ID', 'Ad Status', 'Ad Name', 'Title', 'Body', 'Link Description', 'Display Link', 'Image Hash', 'Creative Type', 'URL Tags', 'Image File Name', 'Creative Optimization', 'Product 1 - Link', 'Product 1 - Name', 'Product 1 - Description', 'Product 1 - Image Hash', 'Product 2 - Link', 'Product 2 - Name', 'Product 2 - Description', 'Product 2 - Image Hash', 'Product 3 - Link', 'Product 3 - Name', 'Product 3 - Description', 'Product 3 - Image Hash', 'Call to Action', 'Story ID'];
        
        let csv = headers.join(";") + "\n"; // Meta uses Semicolon

        document.querySelectorAll('.block-campaign').forEach(camp => {
            const c = getCampValues(camp);
            if(c.plat !== 'Meta') return;

            const campNameBase = `${gProj}-${c.plat}-{{GEO}}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;
            
            c.geos.forEach(geo => {
                const finalCampName = campNameBase.replace('{{GEO}}', geo);
                const adGroups = camp.querySelectorAll('.block-adgroup');
                
                if(adGroups.length === 0) {
                    // Camp Row
                    let row = Array(headers.length).fill("");
                    row[1] = finalCampName; row[2] = "Active"; row[5] = c.obj; row[6] = "Auction";
                    csv += row.join(";") + "\n";
                } else {
                    adGroups.forEach(adg => {
                        const a = getAdgValues(adg);
                        const adgName = `${geo}-${a.aud}_${a.type}${a.cust ? '_'+a.cust : ''}`;
                        const creatives = adg.querySelectorAll('.block-creative');

                        if(creatives.length === 0) {
                            // Ad Set Row
                            let row = Array(headers.length).fill("");
                            row[1] = finalCampName; row[2] = "Active"; row[5] = c.obj; row[6] = "Auction";
                            row[16] = "Active"; row[17] = adgName; row[53] = "Offsite Conversions";
                            csv += row.join(";") + "\n";
                        } else {
                            // Ad Row
                            creatives.forEach(cr => {
                                const r = getCrValues(cr);
                                const parts = [geo, r.fmt, r.dim, gPhase, r.lp, r.ver, r.len];
                                if(r.cust) parts.push(r.cust);
                                const crName = parts.join('-');

                                let row = Array(headers.length).fill("");
                                row[1] = finalCampName; row[2] = "Active"; row[5] = c.obj; row[6] = "Auction";
                                row[16] = "Active"; row[17] = adgName; row[53] = "Offsite Conversions";
                                row[87] = "Active"; row[88] = crName; row[94] = r.fmt;
                                csv += row.join(";") + "\n";
                            });
                        }
                    });
                }
            });
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Meta_Import_AdOps.csv`;
        link.click();
    }

    // REDDIT EXPORT
    function exportReddit() {
        const gProj = document.getElementById('g_project').value.trim();
        const gPhase = document.getElementById('g_phase').value.trim();
        const headers = ["Results", "Campaign ID", "Campaign name", "Special ad category", "Campaign objective", "Campaign budget", "Funding instrument", "Campaign status", "Campaign App ID", "Ad group ID", "Ad group name", "Start time", "End time", "Bid strategy", "Bid", "Budget type", "Budget", "Conversion goal", "Conversion optimization window", "Frequency caps", "Ad group status", "Locations", "Exclude locations", "Gender", "Exclude keywords", "Keywords", "Interests", "Communities", "Exclude communities", "Auto app exclusions", "Device type", "Minimum OS version", "Carriers", "Placements", "Platforms", "Custom audiences", "Exclude custom audiences", "Third-party audiences", "Exclude third-party audiences", "Expand audience automatically", "Delivery type", "Ad Group App ID", "Shopping Ad Type", "Product Catalog ID", "Ad ID", "Ad name", "Impression trackers", "Click trackers", "Ad status", "Second Line CTA", "Ad product IDs", "Post ID", "Profile name or ID", "Post type", "Call to action", "Headline", "Destination URL", "Display URL", "Media file name", "Thumbnail file name", "Body", "Allow comments", "Additional Text", "Carousel card 1 - Media file name", "Carousel card 1 - Destination URL", "Carousel card 1 - Display URL", "Carousel card 1 - Caption", "Carousel card 1 - Call to action", "Carousel card 2 - Media file name", "Carousel card 2 - Destination URL", "Carousel card 2 - Display URL", "Carousel card 2 - Caption", "Carousel card 2 - Call to action", "Carousel card 3 - Media file name", "Carousel card 3 - Destination URL", "Carousel card 3 - Display URL", "Carousel card 3 - Caption", "Carousel card 3 - Call to action", "Carousel card 4 - Media file name", "Carousel card 4 - Destination URL", "Carousel card 4 - Display URL", "Carousel card 4 - Caption", "Carousel card 4 - Call to action", "Carousel card 5 - Media file name", "Carousel card 5 - Destination URL", "Carousel card 5 - Display URL", "Carousel card 5 - Caption", "Carousel card 5 - Call to action", "Carousel card 6 - Media file name", "Carousel card 6 - Destination URL", "Carousel card 6 - Display URL", "Carousel card 6 - Caption", "Carousel card 6 - Call to action"];
        
        let csv = headers.join(",") + "\n";

        document.querySelectorAll('.block-campaign').forEach(camp => {
            const c = getCampValues(camp);
            // Filter: Only Reddit
            if(c.plat !== 'Reddit') return;

            const campNameBase = `${gProj}-${c.plat}-{{GEO}}-${gPhase}_${c.dateStr}-${c.strat}_${c.obj}${c.cust ? '_'+c.cust : ''}`;

            c.geos.forEach(geo => {
                const finalCampName = campNameBase.replace('{{GEO}}', geo);
                const adGroups = camp.querySelectorAll('.block-adgroup');
                
                if(adGroups.length === 0) {
                    let row = Array(headers.length).fill("");
                    row[2] = finalCampName; // Campaign name
                    row[4] = c.obj; // Objective
                    row[7] = "ACTIVE"; // Campaign status
                    csv += row.join(",") + "\n";
                } else {
                    adGroups.forEach(adg => {
                        const a = getAdgValues(adg);
                        const adgName = `${geo}-${a.aud}_${a.type}${a.cust ? '_'+a.cust : ''}`;
                        const creatives = adg.querySelectorAll('.block-creative');

                        if(creatives.length === 0) {
                            let row = Array(headers.length).fill("");
                            row[2] = finalCampName;
                            row[4] = c.obj;
                            row[7] = "ACTIVE";
                            row[10] = adgName; // Ad group name
                            row[20] = "ACTIVE"; // Ad group status
                            csv += row.join(",") + "\n";
                        } else {
                            creatives.forEach(cr => {
                                const r = getCrValues(cr);
                                const parts = [geo, r.fmt, r.dim, gPhase, r.lp, r.ver, r.len];
                                if(r.cust) parts.push(r.cust);
                                const crName = parts.join('-');

                                let row = Array(headers.length).fill("");
                                row[2] = finalCampName;
                                row[4] = c.obj;
                                row[7] = "ACTIVE";
                                row[10] = adgName;
                                row[20] = "ACTIVE";
                                row[45] = crName; // Ad name
                                row[48] = "ACTIVE"; // Ad status
                                csv += row.join(",") + "\n";
                            });
                        }
                    });
                }
            });
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Reddit_Import_AdOps.csv`;
        link.click();
    }

    // [UTM/INFLUENCER LOGIC PRESERVED FROM V26]
    const UTM_TEMPLATES = [{ name: "Google Search", tpl: "?channel=GoogleSearch&campaign={campaignid}&ad_group={adgroupid}&ad={creative}&utm_source=search&utm_medium=cpc&utm_campaign={campaignid}&utm_content={adgroupid}&utm_term={creative}&placement={placement}&keyword={keyword}&utm_id={campaignid}" },{ name: "YouTube", tpl: "?channel=YouTube&campaign={campaignid}&ad_group={adgroupid}&ad={creative}&utm_source=youtube&utm_medium=social&utm_campaign={campaignid}&utm_content={adgroupid}&utm_term={creative}&placement={placement}&keyword={keyword}&utm_id={campaignid}" },{ name: "Performance Max", tpl: "?channel=PMax&campaign={campaignid}&ad_group={adgroupid}&ad={creative}&utm_source=pmax&utm_medium=cpc&utm_campaign={campaignid}&utm_content={adgroupid}&utm_term={creative}&placement={placement}&keyword={keyword}&utm_id={campaignid}" },{ name: "Meta", tpl: "?channel=Meta&campaign={{campaign.id}}&campaign_name={{campaign.name}}&ad_group={{adset.id}}&ad_group_name={{adset.name}}&ad={{ad.id}}&ad_name={{ad.name}}&utm_source=meta&utm_medium=social&utm_campaign={{campaign.name}}&utm_content={{adset.name}}&utm_term={{ad.name}}&utm_id={{campaign.id}}&placement={{placement}}&utm_source_platform={{site_source_name}}" },{ name: "Reddit", tpl: "?channel=Reddit&campaign={{CAMPAIGN_ID}}&ad_group={{ADGROUP_ID}}&ad_group_name={{ADGROUP_NAME}}&ad={{AD_ID}}&ad_name={{AD_NAME}}&reddit_clickid={{CLICK_ID}}&utm_source=reddit&utm_medium=social&utm_campaign={{CAMPAIGN_ID}}&utm_content={{ADGROUP_NAME}}&utm_term={{AD_NAME}}&utm_id={{CAMPAIGN_ID}}&placement=reddit&keyword={{POST_ID}}" },{ name: "TikTok", tpl: "?channel=TikTok&campaign=__CAMPAIGN_ID__&campaign_name=__CAMPAIGN_NAME__&ad_group=__AID__&ad_group_name=__AID_NAME__&ad=__CID__&ad_name=__CID_NAME__&utm_source=tiktok&utm_medium=social&utm_campaign=__CAMPAIGN_NAME__&utm_content=__AID_NAME__&utm_term=__CID_NAME__&utm_id=__CAMPAIGN_ID__&placement=__PLACEMENT__" },{ name: "Google DemandGen", tpl: "?channel=GoogleDemandGen&campaign={campaignid}&ad_group={adgroupid}&ad={creative}&utm_source=googledemandgen&utm_medium=cpc&utm_campaign={campaignid}&utm_content={adgroupid}&utm_term={creative}&placement={placement}&keyword={keyword}&utm_id={campaignid}" },{ name: "DisplayVideo360", tpl: "?channel=DisplayVideo&campaign=${INSERTION_ORDER_ID}&ad_group=${CAMPAIGN_ID}&ad=${CREATIVE_ID}&utm_source=displayvideo&utm_medium=cpm&utm_campaign=${INSERTION_ORDER_ID}&utm_content=${CAMPAIGN_ID}&utm_term=${CREATIVE_ID}&utm_id=${INSERTION_ORDER_ID}&placement=${UNIVERSAL_SITE_ID}" },{ name: "YouTube VTA (DV360)", tpl: "?channel=YouTubeVTA&campaign={campaignid}&ad_group={adgroupid}&ad={creative}&utm_source=youtubevta&utm_medium=social&utm_campaign={campaignid}&utm_content={adgroupid}&utm_term={creative}&placement={placement}&keyword={keyword}&utm_id={campaignid}" }];
    function generateUTMs() { const baseUrl = document.getElementById('utm-base-url').value.trim().replace(/\/$/, ""); const tbody = document.getElementById('utm-tbody'); tbody.innerHTML = ""; UTM_TEMPLATES.forEach(item => { let connector = baseUrl.includes("?") ? "&" : "?"; const finalLink = `${baseUrl}${connector}${item.tpl.replace("?", "")}`; const tr = document.createElement('tr'); tr.innerHTML = `<td style="font-weight:bold;">${item.name}</td><td><div class="utm-link-box">${finalLink}</div></td><td style="text-align:center;"><button class="btn-copy" onclick="copyToClip(this, '${finalLink}')">Copy</button></td>`; tbody.appendChild(tr); }); }
    function addInfRow() { const tr = document.createElement('tr'); tr.innerHTML = `<td><input type="text" class="i-creator" placeholder="Name" oninput="updateInfTable()"></td><td>${createSelectHTML(lists.inf_langs,"i-lang","inf_langs")}</td><td>${createSelectHTML(lists.inf_plats,"i-plat","inf_plats")}</td><td>${createSelectHTML(lists.inf_types,"i-type","inf_types")}</td><td>${createSelectHTML(lists.inf_personas,"i-persona","inf_personas")}</td><td><input type="date" class="i-date" value="${new Date().toISOString().split('T')[0]}" oninput="updateInfTable()"></td><td><input type="text" class="i-key" placeholder="Required" oninput="updateInfTable()"></td><td><div class="utm-link-box generated-link-box">...</div></td><td><input type="text" class="i-short" placeholder="Result..." readonly> <button class="btn-shorten" onclick="fetchShortLink(this)">Get Short Link</button></td><td>${generateActionButtons()}</td>`; tr.querySelectorAll('select').forEach(s => s.addEventListener('change', updateInfTable)); document.querySelector('#table-inf tbody').appendChild(tr); }
    function updateInfTable() { const proj = document.getElementById('inf_project').value.trim(); const phase = document.getElementById('inf_phase').value.trim(); const dest = document.getElementById('inf_dest').value.trim().replace(/\/$/, ""); document.querySelectorAll('#table-inf tbody tr').forEach(row => { const creator = row.querySelector('.i-creator').value.trim(); const lang = row.querySelector('.i-lang').value; const plat = row.querySelector('.i-plat').value; const type = row.querySelector('.i-type').value; const persona = row.querySelector('.i-persona').value; const dateRaw = row.querySelector('.i-date').value; const shortKey = row.querySelector('.i-key').value.trim(); const outBox = row.querySelector('.generated-link-box'); const shortenBtn = row.querySelector('.btn-shorten'); if(!creator || !lang || !plat || !type || !persona || !shortKey) { outBox.innerText = "Fill all fields..."; shortenBtn.disabled = true; return; } const date = formatAdOpsDate(dateRaw); const prefix = proj ? `${proj}-` : ""; const parentCamp = `${prefix}${persona}-${lang}-${phase}_${date}-${plat}_${type}`; const campName = `${parentCamp}-${creator}`; let connector = dest.includes("?") ? "&" : "?"; const params = new URLSearchParams(); params.set("campaign_name", campName); params.set("ad_group_name", creator); params.set("utm_source", creator); params.set("utm_medium", "creator"); params.set("utm_campaign", parentCamp); params.set("utm_content", shortKey); const fullLink = `${dest}${connector}${params.toString()}`; outBox.innerHTML = `<a href="${fullLink}" target="_blank">${fullLink}</a>`; outBox.setAttribute('data-long-url', fullLink); outBox.setAttribute('data-short-key', shortKey); shortenBtn.disabled = false; }); }
    async function fetchShortLink(btn) { const row = btn.closest('tr'); const linkBox = row.querySelector('.generated-link-box'); const shortInput = row.querySelector('.i-short'); const longUrl = linkBox.getAttribute('data-long-url'); const shortKey = linkBox.getAttribute('data-short-key'); const destVal = document.getElementById('inf_dest').value; let hostname = new URL(destVal).hostname.replace(/^www\./, ''); const apiUrl = `https://connect.${hostname}/shorten`; btn.innerText = "Shortening..."; btn.disabled = true; shortInput.value = ""; try { const requestUrl = `${apiUrl}?url=${encodeURIComponent(longUrl)}&short_key=${encodeURIComponent(shortKey)}`; const response = await fetch(requestUrl, { method: 'GET' }); if (!response.ok) throw new Error("Network Error"); const data = await response.json(); if (data.short_url) { shortInput.value = data.short_url; btn.innerText = "Done!"; } else { shortInput.value = "Error"; btn.innerText = "Retry"; btn.disabled = false; } } catch (error) { console.error(error); shortInput.value = "API Error"; btn.innerText = "Retry"; btn.disabled = false; alert(`Failed to shorten link. Ensure the domain 'connect.${hostname}' allows CORS requests.`); } }
    function copyToClip(btn, text) { navigator.clipboard.writeText(text).then(() => { const original = btn.innerText; btn.innerText = "Copied!"; btn.style.background = "#27ae60"; setTimeout(() => { btn.innerText = original; btn.style.background = "#333"; }, 1500); }); }
    const PLATFORM_ICONS = { "Google Search": "üîç", "YouTube": "‚ñ∂Ô∏è", "Performance Max": "üöÄ", "Meta": "‚ôæÔ∏è", "Reddit": "ü§ñ", "TikTok": "üéµ", "Google DemandGen": "üìâ", "DisplayVideo360": "üìä", "YouTube VTA (DV360)": "üì∫" };
</script>

</body>
</html>
