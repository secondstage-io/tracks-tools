<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACKS Ad Ops Wizard</title>
    <style>
        :root {
            /* BRAND COLOR */
            --primary: #ff0249; 
            
            /* UI Colors */
            --light: #f8f9fa;
            --grey: #eef2f5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: var(--grey); color: #333; }
        .container { max-width: 95%; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80vh; display: flex; flex-direction: column; }
        
        /* WIZARD HEADER */
        .wizard-header { display: flex; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; justify-content: space-between; align-items: center; }
        
        .header-branding { display: flex; align-items: center; gap: 15px; }
        .header-logo { height: 32px; width: auto; display: block; }

        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); border: none; padding: 0; line-height: 1;}

        /* Steps */
        .step-indicator { display: flex; gap: 10px; }
        .step-dot { width: 30px; height: 30px; border-radius: 50%; background: #ddd; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .step-dot.active { background: var(--primary); box-shadow: 0 2px 5px rgba(255, 2, 73, 0.4); }
        .step-dot.completed { background: #27ae60; }

        h2 { color: var(--primary); margin-top: 0; margin-bottom: 10px; }
        p.instructions { color: #555; font-size: 0.95rem; line-height: 1.5; margin-top: 0; margin-bottom: 20px; max-width: 900px; }

        /* STEPS visibility */
        .step-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Config & Globals */
        .top-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .input-group { display: flex; flex-direction: column; min-width: 150px; }
        .input-group label { font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th { text-align: left; font-size: 0.85rem; color: white; padding: 12px 10px; position: relative; }
        td { padding: 8px; vertical-align: top; border-bottom: 1px solid #eee; }
        
        /* TABLE HEADERS USE BRAND COLOR */
        .header-camp th, 
        .header-adgroup th, 
        .header-creative th { background: var(--primary); }

        input[type="text"] { width: 100%; box-sizing: border-box; }
        select { width: 100%; }

        /* Buttons */
        .btn { cursor: pointer; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        
        .btn-nav { background: var(--primary); color: white; font-size: 1rem; }
        .btn-nav:hover { background: #d6003b; } 
        .btn-nav.secondary { background: #95a5a6; }
        .btn-nav.secondary:hover { background: #7f8c8d; }
        .btn-add { background: #f1f1f1; color: #333; width: 100%; border: 1px dashed #ccc; margin-top: 5px; }
        .btn-add:hover { background: #e2e2e2; }
        .btn-remove { background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 4px 8px; font-size: 0.8rem; }
        .btn-remove:hover { background: #e74c3c; color: white; }
        
        /* DOWNLOAD BUTTON */
        .btn-download { background: #27ae60; color: white; font-size: 0.9rem; margin-top: 10px; display: inline-block; text-decoration: none; }
        .btn-download:hover { background: #219150; }

        .footer-nav { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; }

        /* Output Textareas */
        textarea { width: 100%; height: 150px; font-family: monospace; padding: 10px; border: 1px solid #ccc; background: #fafafa; white-space: pre; overflow-x: auto; }
        .output-label { font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center;}
        
        /* TOOLTIP CSS */
        .tooltip-container { cursor: help; border-bottom: 1px dotted rgba(255,255,255,0.5); }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            right: 0; /* Align to right edge of header */
            top: 100%; /* Show below */
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 0.75rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
            white-space: normal; /* Allow wrapping */
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Auto-fill highlight effect */
        .flash-bg { animation: flash 1s; }
        @keyframes flash { 0% { background-color: #ffe6ed; } 100% { background-color: transparent; } }
    </style>
</head>
<body>

<div class="container">
    
    <div class="wizard-header">
        <div class="header-branding">
            <img src="https://tracks.secondstage.io/vite/assets/tracks-signup-logo-J-NQw5DE.png" alt="TRACKS Logo" class="header-logo">
            <h1>Ad Ops Wizard</h1>
        </div>
        <div class="step-indicator">
            <div class="step-dot active" id="dot-1">1</div>
            <div class="step-dot" id="dot-2">2</div>
            <div class="step-dot" id="dot-3">3</div>
            <div class="step-dot" id="dot-4">4</div>
        </div>
    </div>

    <div id="step-1" class="step-section active">
        <h2>Step 1: Create Campaigns</h2>
        
        <p class="instructions">
            Please begin by completing the Campaign Helper table using your media plan. Each row can be filled out by selecting options from the dropdown menus. If none of the available choices fit your needs, you can add new ones using the “Quick Add Custom Options” button in the top-right corner.
        </p>

        <div class="top-bar">
            <div class="input-group">
                <label>Project Code</label>
                <input type="text" id="g_project" value="2s">
            </div>
            <div class="input-group">
                <label>Beat / Phase</label>
                <input type="text" id="g_phase" value="Update_251125">
            </div>
            <div class="input-group" style="margin-left:auto; border-left:1px solid #ddd; padding-left:20px; min-width: 350px;">
                 <label>Quick Add Custom Option</label>
                 <div style="display:flex; gap:5px;">
                     <select id="custom_cat" style="width: 40%;">
                         <option value="platforms">Platform</option>
                         <option value="strategies">Strategy (Step 1)</option>
                         <option value="objectives">Objective (Step 1)</option>
                         <option value="audiences">Audience (Step 2)</option>
                         <option value="audTypes">Audience Type (Step 2)</option>
                     </select>
                     <input type="text" id="custom_val" placeholder="New Value..." style="width: 40%;">
                     <button onclick="addCustom()" style="background:#27ae60; color:white; border:none; border-radius:3px; width: 20%; font-weight: bold;">Add +</button>
                 </div>
                 <small style="color:#888; font-size:0.7rem; margin-top:3px;">Adds directly to dropdowns below.</small>
            </div>
        </div>

        <table class="header-camp" id="table-camp">
            <thead>
                <tr>
                    <th style="width:15%">Platform</th>
                    <th style="width:10%">Tier</th>
                    <th style="width:15%">Geos (Comma Sep)</th>
                    <th style="width:15%">Strategy</th>
                    <th style="width:15%">Objective</th>
                    <th style="width:15%">Start Date</th>
                    <th class="tooltip-container">Custom Naming Placeholder
                        <span class="tooltip-text">
                            If you like to add additional information you can use "Custom Naming Placeholder" fields. You can add as many values as you'd like by separating each with a underscore ( _ ).<br><br>
                            Example: Call of Duty: Warzone_Desktop_Video
                        </span>
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addCampRow()">+ Add Campaign Row</button>
    </div>

    <div id="step-2" class="step-section">
        <h2>Step 2: Create Ad Groups</h2>
        <p style="color:#666; font-style:italic;">Select a campaign. The <b>Geo</b> field will fill automatically based on the campaign name.</p>
        
        <table class="header-adgroup" id="table-adgroup">
            <thead>
                <tr>
                    <th style="width:30%">Select Parent Campaign</th>
                    <th style="width:10%">Geos (Auto)</th>
                    <th style="width:20%">Audience</th>
                    <th style="width:20%">Audience Type</th>
                    <th>Custom</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addAdGroupRow()">+ Add Ad Group Row</button>
    </div>

    <div id="step-3" class="step-section">
        <h2>Step 3: Creatives</h2>
        <p style="color:#666; font-style:italic;">Select a campaign. The <b>Geo</b> field will fill automatically.</p>

        <table class="header-creative" id="table-creative">
            <thead>
                <tr>
                    <th style="width:20%">Campaign Context (Ref)</th>
                    <th style="width:10%">Geos (Auto)</th>
                    <th style="width:10%">Format</th>
                    <th style="width:10%">Dims</th>
                    <th style="width:10%">LP</th>
                    <th style="width:8%">Ver</th>
                    <th style="width:8%">Len</th>
                    <th>Custom</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addCreativeRow()">+ Add Creative Row</button>
    </div>

    <div id="step-4" class="step-section">
        <h2 style="color:#27ae60;">Step 4: Final Export</h2>
        <p>Copy table content or Download CSV files below.</p>
        
        <div class="output-label">
            <span>1. Campaigns</span>
            <button class="btn btn-download" onclick="downloadCSV('out-camp', 'Campaigns.csv')">Download CSV</button>
        </div>
        <textarea id="out-camp"></textarea>
        
        <br><br>
        <div class="output-label">
            <span>2. Ad Groups</span>
            <button class="btn btn-download" onclick="downloadCSV('out-adgroup', 'AdGroups.csv')">Download CSV</button>
        </div>
        <textarea id="out-adgroup"></textarea>
        
        <br><br>
        <div class="output-label">
            <span>3. Creatives</span>
            <button class="btn btn-download" onclick="downloadCSV('out-creative', 'Creatives.csv')">Download CSV</button>
        </div>
        <textarea id="out-creative"></textarea>
    </div>

    <div class="footer-nav">
        <button class="btn btn-nav secondary" id="btn-back" onclick="changeStep(-1)" style="visibility:hidden;">Back</button>
        <button class="btn btn-nav" id="btn-next" onclick="changeStep(1)">Next Step &rarr;</button>
    </div>

</div>

<script>
    // --- 1. DATA & STORAGE ---
    let currentStep = 1;
    let generatedCampaignList = []; 

    const DEFAULTS = {
        platforms: ["GoogleSearch", "YouTube", "Meta", "Reddit", "TikTok", "DisplayVideo360", "X"],
        tiers: ["T1", "T2", "T3", "Global", "RoW"],
        strategies: ["Awareness", "Consideration", "Conversion", "Retention"],
        objectives: ["Traffic", "Reach", "Views", "AppInstall", "Purchase"],
        audiences: ["Core", "Secondary", "Aspirational", "Broad", "Mainstream", "Lookalike", "Retargeting"],
        audTypes: ["Prospecting", "Retargeting", "Retention"],
        formats: ["Video", "Static", "Carousel", "Collection", "HTML5"],
        lps: ["Website", "Steam", "Epic", "PS_Store"]
    };
    let lists = JSON.parse(JSON.stringify(DEFAULTS));

    // --- 2. INIT ---
    window.onload = function() {
        const saved = localStorage.getItem('adOpsWizardLists');
        if(saved) lists = JSON.parse(saved);

        addCampRow();
        addAdGroupRow();
        addCreativeRow();
    };

    // --- 3. NAVIGATION & AUTO-FILL LOGIC ---
    function changeStep(dir) {
        if (currentStep === 1 && dir === 1) {
            processStep1(); 
            updateAdGroupDropdowns();
        }
        if (currentStep === 3 && dir === 1) {
            generateFinalOutput();
        }

        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById(`dot-${currentStep}`).classList.remove('active');
        if(dir === 1) document.getElementById(`dot-${currentStep}`).classList.add('completed');

        currentStep += dir;
        
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.getElementById(`dot-${currentStep}`).classList.add('active');
        document.getElementById(`dot-${currentStep}`).classList.remove('completed');

        document.getElementById('btn-back').style.visibility = currentStep > 1 ? 'visible' : 'hidden';
        document.getElementById('btn-next').innerText = currentStep === 4 ? 'Finish' : 'Next Step \u2192';
        if(currentStep > 4) currentStep = 4;
    }

    function autoInheritGeo(selectEl) {
        const val = selectEl.value;
        if(!val) return;

        const parts = val.split('-');
        // Naming: Project-Platform-Geo-...
        if (parts.length > 2) {
            const geo = parts[2];
            const row = selectEl.closest('tr');
            const geoInput = row.querySelector('.geo-input');
            
            if(geoInput) {
                geoInput.value = geo;
                geoInput.classList.add('flash-bg');
                setTimeout(() => geoInput.classList.remove('flash-bg'), 1000);
            }
        }
    }

    function processStep1() {
        generatedCampaignList = [];
        const proj = document.getElementById('g_project').value.trim();
        const phase = document.getElementById('g_phase').value.trim();

        document.querySelectorAll('#table-camp tbody tr').forEach(row => {
            const inps = row.querySelectorAll('input, select');
            const plat = inps[0].value;
            const geoRaw = inps[2].value;
            const strat = inps[3].value;
            const obj = inps[4].value;
            const date = inps[5].value;
            const cust = inps[6].value;

            if(!plat || !geoRaw) return;

            geoRaw.split(',').map(s=>s.trim()).filter(s=>s).forEach(geo => {
                let name = `${proj}-${plat}-${geo}-${phase}`;
                const d = formatAdOpsDate(date);
                if(d) name += `_${d}`;
                name += `-${strat}_${obj}`;
                if(cust) name += `_${cust}`;
                
                generatedCampaignList.push(name);
            });
        });
    }

    function updateAdGroupDropdowns() {
        const dropdowns = document.querySelectorAll('.camp-select');
        dropdowns.forEach(sel => {
            const currentVal = sel.value; 
            sel.innerHTML = '<option value="" disabled selected>Select generated campaign...</option>';
            generatedCampaignList.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.text = name;
                sel.appendChild(opt);
            });
            if(generatedCampaignList.includes(currentVal)) sel.value = currentVal;
        });
    }

    // --- 4. ROW BUILDERS ---
    function createSelect(opts, cls="", categoryName) {
        // Add data-cat attribute to identifying dropdown category
        let h = `<select class="${cls}" data-cat="${categoryName}"><option value="" disabled selected>Select...</option>`;
        opts.forEach(o => h += `<option value="${o}">${o}</option>`);
        h += `</select>`;
        return h;
    }

    function addCampRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${createSelect(lists.platforms, "", "platforms")}</td>
            <td>${createSelect(lists.tiers, "", "tiers")}</td>
            <td><input type="text" placeholder="UK, DE"></td>
            <td>${createSelect(lists.strategies, "", "strategies")}</td>
            <td>${createSelect(lists.objectives, "", "objectives")}</td>
            <td><input type="date" value="${new Date().toISOString().split('T')[0]}"></td>
            <td><input type="text"></td>
            <td><button class="btn-remove" onclick="this.closest('tr').remove()">X</button></td>`;
        document.querySelector('#table-camp tbody').appendChild(tr);
    }

    function addAdGroupRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><select class="camp-select" onchange="autoInheritGeo(this)"><option disabled>Complete Step 1 first...</option></select></td>
            <td><input type="text" class="geo-input" placeholder="Auto-fills"></td>
            <td>${createSelect(lists.audiences, "", "audiences")}</td>
            <td>${createSelect(lists.audTypes, "", "audTypes")}</td>
            <td><input type="text"></td>
            <td><button class="btn-remove" onclick="this.closest('tr').remove()">X</button></td>`;
        document.querySelector('#table-adgroup tbody').appendChild(tr);
        
        if(generatedCampaignList.length > 0) {
            const sel = tr.querySelector('.camp-select');
            sel.innerHTML = '<option value="" disabled selected>Select generated campaign...</option>';
            generatedCampaignList.forEach(name => {
                sel.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
    }

    function addCreativeRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><select class="camp-select" onchange="autoInheritGeo(this)"><option disabled>Complete Step 1...</option></select></td>
            <td><input type="text" class="geo-input" placeholder="Auto-fills"></td>
            <td>${createSelect(lists.formats, "", "formats")}</td>
            <td><input type="text" placeholder="1920x1080"></td>
            <td>${createSelect(lists.lps, "Website", "lps")}</td>
            <td><input type="text" value="v1"></td>
            <td><input type="text" placeholder="15s"></td>
            <td><input type="text"></td>
            <td><button class="btn-remove" onclick="this.closest('tr').remove()">X</button></td>`;
        document.querySelector('#table-creative tbody').appendChild(tr);
        
        if(generatedCampaignList.length > 0) {
            const sel = tr.querySelector('.camp-select');
            sel.innerHTML = '<option value="" disabled selected>Select generated campaign...</option>';
            generatedCampaignList.forEach(name => {
                sel.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
    }

    // --- 5. UTILS & EXPORT ---
    function formatAdOpsDate(ds) {
        if(!ds) return "";
        const d = new Date(ds);
        return `${d.getFullYear().toString().substr(-2)}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`;
    }

    function addCustom() {
        const cat = document.getElementById('custom_cat').value;
        const val = document.getElementById('custom_val').value.trim();
        if(val) {
            if(!lists[cat].includes(val)){
                lists[cat].push(val);
                localStorage.setItem('adOpsWizardLists', JSON.stringify(lists));
                refreshDropdowns(cat); 
                document.getElementById('custom_val').value = ''; 
            } else {
                alert("Already exists!");
            }
        }
    }

    function refreshDropdowns(cat) {
        const selects = document.querySelectorAll(`select[data-cat="${cat}"]`);
        selects.forEach(sel => {
            const currentVal = sel.value;
            let html = `<option value="" disabled ${currentVal===""?"selected":""}>Select...</option>`;
            lists[cat].forEach(o => {
                html += `<option value="${o}" ${currentVal===o?"selected":""}>${o}</option>`;
            });
            sel.innerHTML = html;
        });
    }

    function generateFinalOutput() {
        const proj = document.getElementById('g_project').value;
        const phase = document.getElementById('g_phase').value;

        // Campaigns
        let outCamp = "Project\tPhase\tPlatform\tTier\tGeo\tStrat\tObj\tDate\tCustom\tCampaign Name\n";
        document.querySelectorAll('#table-camp tbody tr').forEach(row => {
            const i = row.querySelectorAll('input, select');
            if(!i[0].value || !i[2].value) return;
            i[2].value.split(',').map(s=>s.trim()).forEach(geo => {
                let name = `${proj}-${i[0].value}-${geo}-${phase}`;
                if(i[5].value) name += `_${formatAdOpsDate(i[5].value)}`;
                name += `-${i[3].value}_${i[4].value}`;
                if(i[6].value) name += `_${i[6].value}`;
                outCamp += `${proj}\t${phase}\t${i[0].value}\t${i[1].value}\t${geo}\t${i[3].value}\t${i[4].value}\t${i[5].value}\t${i[6].value}\t${name}\n`;
            });
        });
        document.getElementById('out-camp').value = outCamp;

        // Ad Groups
        let outAG = "Campaign Name\tGeo\tAudience\tType\tCustom\tAd Group Name\n";
        document.querySelectorAll('#table-adgroup tbody tr').forEach(row => {
            const i = row.querySelectorAll('input, select');
            const cmp = i[0].value; 
            const geoRaw = i[1].value; 
            const aud = i[2].value;
            const type = i[3].value;
            const cust = i[4].value;
            if(!cmp || !aud) return;
            const geos = geoRaw ? geoRaw.split(',').map(s=>s.trim()) : [""];
            geos.forEach(geo => {
                let name = geo ? `${geo}-${aud}_${type}` : `${aud}_${type}`;
                if(cust) name += `_${cust}`;
                outAG += `${cmp}\t${geo}\t${aud}\t${type}\t${cust}\t${name}\n`;
            });
        });
        document.getElementById('out-adgroup').value = outAG;

        // Creatives
        let outCr = "Camp Ref\tGeo\tFormat\tDims\tPhase\tLP\tVer\tLen\tCustom\tCreative Name\n";
        document.querySelectorAll('#table-creative tbody tr').forEach(row => {
            const i = row.querySelectorAll('input, select');
            if(!i[2].value) return; 
            const geos = i[1].value ? i[1].value.split(',').map(s=>s.trim()) : [""];
            geos.forEach(geo => {
                let parts = [geo, i[2].value, i[3].value, phase, i[4].value, i[5].value, i[6].value];
                if(i[7].value) parts.push(i[7].value);
                const name = parts.filter(x=>x).join("-");
                outCr += `${i[0].value}\t${geo}\t${i[2].value}\t${i[3].value}\t${phase}\t${i[4].value}\t${i[5].value}\t${i[6].value}\t${i[7].value}\t${name}\n`;
            });
        });
        document.getElementById('out-creative').value = outCr;
    }

    // --- 6. DOWNLOAD CSV ---
    function downloadCSV(elId, filename) {
        let content = document.getElementById(elId).value;
        // Convert Tabs to Commas
        content = content.replaceAll('\t', ',');
        
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
</script>

</body>
</html>
